@startuml constraint-monitor-architecture
!include _standard-style.puml


title Real-time Constraint Monitoring System Architecture

package "Claude Code Integration" {
  [Status Line] as status
  [Pre-Hook] as prehook
  [Post-Hook] as posthook
  [MCP Server] as mcp
}

package "Universal Agent Monitor" {
  [Claude Adapter] as claude_adapter
  [Universal Monitor] as monitor
  [Event Buffer] as buffer
}

package "Processing Engine" {
  [Event Processor] as processor
  [Groq Engine] as groq
  [Constraint Detector] as detector
}

package "Databases" {
  database "Qdrant\n(Vector DB)" as qdrant
  database "DuckDB\n(Analytics)" as duckdb
  database "Redis\n(Cache)" as redis
  database "SQLite\n(Config)" as sqlite
}

package "Live Guide Rails" {
  [Risk Assessor] as risk
  [Intervention Engine] as intervention
  [Context Injector] as context
}

package "HTTP API" {
  [REST Endpoints] as api
  [WebSocket Server] as websocket
  [Dashboard] as dashboard
}

' Connections
claude_adapter --> monitor : events
monitor --> buffer : buffered events
buffer --> processor : batch processing

processor --> groq : semantic analysis
processor --> detector : pattern matching
detector --> qdrant : similarity search
processor --> duckdb : store metrics

processor --> intervention : violations detected
intervention --> risk : assess risk
intervention --> context : inject context

status --> api : status requests
prehook --> api : constraint checks
posthook --> api : event capture
mcp --> api : tool calls

api --> websocket : real-time updates
websocket --> dashboard : live display

' Performance annotations
note right of groq : <50ms analysis\nGroq LLaMa 70B
note right of qdrant : <3ms queries\nHNSW + quantization  
note right of duckdb : <5ms analytics\nColumnar storage
note right of intervention : <10ms total\nReal-time response

' Data flows
groq ..> redis : cache results
detector ..> sqlite : load constraints
qdrant ..> redis : cache vectors

@enduml