@startuml unified-7-agent-system
!include _standard-style.puml

title "Unified 7-Agent System Architecture"

package "AI Coding Assistants" {
  [Claude Code\n(MCP Integration)] <<external>> as claude
  [GitHub CoPilot\n(VSCode Extension)] <<external>> as copilot
}

package "Unified Interface Layer" {
  [MCP Server\n(determine_insights,\nupdate_knowledge_base,\nlessons_learned)] <<api>> as mcp
  [HTTP API Server\n(@KM commands,\nREST endpoints)] <<api>> as http
}

package "7-Agent System Infrastructure" {
  rectangle "Coordinator Agent" <<agent>> as coordinator {
    [Workflow Management] <<core>>
    [Progress Tracking] <<core>>
    [Error Handling] <<core>>
    [Task Scheduling] <<core>>
  }
  
  rectangle "Semantic Analysis Agent" <<agent>> as semantic {
    [Repository Analysis] <<core>>
    [Conversation Processing] <<core>>
    [Pattern Recognition] <<core>>
    [Significance Scoring] <<core>>
  }
  
  rectangle "Knowledge Graph Agent" <<agent>> as knowledge {
    [Entity Extraction] <<core>>
    [Relationship Mapping] <<core>>
    [Graph Management] <<core>>
    [Schema Validation] <<core>>
  }
  
  rectangle "Web Search Agent" <<agent>> as web {
    [Documentation Search] <<util>>
    [Technical Research] <<util>>
    [Context Enrichment] <<util>>
    [Reference Validation] <<util>>
  }
  
  rectangle "SynchronizationAgent\n(SINGLE SOURCE OF TRUTH)" <<agent>> as sync {
    [Multi-DB Sync] <<core>>
    [Conflict Resolution] <<core>>
    [Data Validation] <<core>>
    [Atomic Operations] <<core>>
  }
  
  rectangle "Deduplication Agent" <<agent>> as dedup {
    [Similarity Detection] <<util>>
    [Duplicate Prevention] <<util>>
    [Quality Filtering] <<util>>
    [Entity Merging] <<util>>
  }
  
  rectangle "Documentation Agent" <<agent>> as docs {
    [Markdown Generation] <<util>>
    [Diagram Creation] <<util>>
    [Template Application] <<util>>
    [Cross-referencing] <<util>>
  }
}

package "Communication Infrastructure" {
  [MQTT Broker\n(Async messaging)] <<infra>> as mqtt
  [JSON-RPC Server\n(Sync method calls)] <<infra>> as rpc
}

package "Multi-Database Storage" {
  database "MCP Memory\n(Claude sessions)" <<storage>> as mcpmem
  database "Graphology\n(CoPilot integration)" <<storage>> as graphology
  database "shared-memory.json\n(Git persistence)" <<storage>> as sharedmem
}

package "Monitoring & Visualization" {
  [VKB Web Interface\n(Knowledge graph viewer)] <<cli>> as vkb
  [System Health Monitor\n(Agent status & metrics)] <<util>> as health
  [Workflow Progress Viewer\n(Real-time activity)] <<util>> as progress
}

' User connections
claude SYNC_LINE mcp : "MCP Protocol"
copilot SYNC_LINE http : "HTTP/WebSocket"

' Interface to coordinator
mcp CONTROL_LINE coordinator : "Start workflows"
http CONTROL_LINE coordinator : "API requests"

' Agent workflows (determine_insights)
coordinator CONTROL_LINE semantic : "1. Analyze repository"
coordinator CONTROL_LINE knowledge : "2. Extract entities"
coordinator CONTROL_LINE web : "3. Research context"
coordinator CONTROL_LINE dedup : "4. Check duplicates"
coordinator CONTROL_LINE docs : "5. Generate docs"
coordinator CONTROL_LINE sync : "6. Sync all DBs"

' Agent communication
semantic ASYNC_LINE mqtt : "Async messages"
knowledge ASYNC_LINE mqtt
web ASYNC_LINE mqtt
dedup ASYNC_LINE mqtt
docs ASYNC_LINE mqtt

coordinator SYNC_LINE rpc : "Sync method calls"
sync SYNC_LINE rpc

' SynchronizationAgent (critical path)
sync DATA_LINE mcpmem : "Ensure consistency"
sync DATA_LINE graphology : "Ensure consistency"
sync DATA_LINE sharedmem : "Ensure consistency"

' Monitoring
health OPTIONAL_LINE coordinator : "Check status"
health OPTIONAL_LINE mqtt : "Monitor messages"
progress OPTIONAL_LINE coordinator : "Track workflows"
vkb DATA_LINE sharedmem : "Visualize unified data"

note top of sync
  **CRITICAL COMPONENT**
  Single source of truth ensuring
  data consistency across ALL
  storage systems
end note

note bottom of coordinator
  **UNIFIED WORKFLOWS**
  Same agent system serves both
  Claude Code and CoPilot with
  identical analysis quality
end note

note right of mcp
  MCP Tools:
  • determine_insights
  • update_knowledge_base
  • lessons_learned
  • search_knowledge
  • get_system_status
end note

note right of http
  @KM Commands:
  • @KM determine insights
  • @KM update knowledge base
  • @KM lessons learned
  • @KM search [query]
  • @KM system status
end note

@enduml