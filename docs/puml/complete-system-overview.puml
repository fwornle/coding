@startuml
!include _standard-style.puml

title Coding Project - Complete System Architecture

top to bottom direction

' User Interface Layer
actor "Developer" as dev #FFE6E6
actor "AI Assistant\n(Claude/Copilot)" as ai #FFE6E6

dev -down-> ai : uses

' Core Capabilities (2x2 grid, more compact)
package "Core Real-Time Systems" as realtime #E8F5E8 {
  component "Live Session Logging\n(5-Layer Classification)" as lsl <<core>>
  component "Constraint Monitoring\n(18 Constraints)" as constraints <<core>>
  component "Trajectory Generation\n(Light & Deep)" as trajectory <<core>>
  component "Status Line System\n(4-Layer Health)" as status <<core>>
}

ai -down-> realtime : all interactions

' Knowledge Management (side by side, compact)
package "Knowledge Management" as km #FFF9E6 {
  component "Continuous Learning\n(Automatic, $8.33/mo)" as learning <<core>>
  component "UKB/VKB\n(Manual Capture)" as ukb <<cli>>
}

realtime -down-> km : feeds content

' LLM Providers (compact horizontal)
cloud "LLM Providers" as llm_providers #F8F8F8 {
  [Groq] as groq
  [OpenAI] as openai
  [DMR/llama.cpp] as localllm
}

lsl -down-> llm_providers : Layer 4\nclassification
learning -down-> localllm : sensitive\ndata

' MCP Integration Layer (compact)
package "MCP Integration Servers" as mcp #E0E7FF {
  [Semantic Analysis\n(14 Agents)] as semantic <<mcp>>
  [Constraint Monitor] as mcp_constraint <<mcp>>
  [Serena AST] as serena <<mcp>>
  [Browser/Spec] as other_mcp <<mcp>>
}

trajectory -down-> mcp : deep analysis
constraints -down-> mcp_constraint : violations

' Storage Layer (vertical stack)
database "Storage Layer" as storage #F5F5F5 {
  database "Graph DB\n(Primary Knowledge)\n.data/knowledge-graph/" as graphdb <<primary>>
  database "Qdrant\n(Docker Vector Search)" as qdrant <<search>>
  database "SQLite\n(Analytics Only)\n.data/knowledge.db" as sqlite <<analytics>>
  folder ".specstory/history/\n(Session Logs)" as lsl_logs <<logs>>
}

' Git-tracked JSON exports (MANDATORY bidirectional sync)
file ".data/knowledge-export/*.json\n(Git-Tracked - MANDATORY)" as json #F9F9F9

km -down-> storage : all knowledge
lsl -down-> lsl_logs : sessions
mcp -down-> graphdb : insights
graphdb <-down-> json : MANDATORY auto-sync\n(5s debounce)

note right of realtime
  **Real-Time Monitoring**
  • Zero data loss
  • 4-layer health architecture
  • Multi-project support
  • Automatic recovery
end note

note right of km
  **Dual Knowledge Systems**
  • Continuous Learning (auto)
  • UKB/VKB (manual)
  • Shared Graph DB storage
  • Team-scoped isolation
end note

note right of graphdb
  **PRIMARY STORAGE**
  • Both auto & manual knowledge
  • Team-scoped (team:entity)
  • Persistent (Level DB)
  • Auto-exports to JSON (5s)
end note

note right of json
  **MANDATORY SYNC (Phase 4)**
  REQUIRED for team collaboration
  Auto-export: 5s after changes
  Auto-import: on startup
  Cross-project persistence
  Git-tracked by design
end note

@enduml
