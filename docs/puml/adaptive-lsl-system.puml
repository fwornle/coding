@startuml
!include _standard-style.puml

title Adaptive LSL System Architecture

top to bottom direction

package "Adaptive LSL System" as system #E8F5E8 {

  package "Entry Point Layer" as entry #F0F0F0 {
    [extractExchangesFromBatch()] as extract <<entry>>
    [legacyExtractExchangesFromBatch()] as legacy <<fallback>>

    note right of entry
      **StreamingTranscriptReader**
      Entry point for transcript processing
      with automatic fallback to legacy format
    end note
  }

  package "Extraction Layer" as extraction #FFF9E6 {
    [extractExchanges()] as main <<logic>>
    [getOrDetectFormat()] as cache <<caching>>
    [extractWithStrategy()] as strategy <<format>>

    note right of extraction
      **AdaptiveExchangeExtractor**
      Main logic for exchange extraction
      with format detection and caching
    end note
  }

  package "Detection Layer" as detection #E0E7FF {
    [detectFormat()] as detect <<engine>>
    [analyzeMessageBatch()] as analyze <<recognition>>
    [generatePatternsFromAnalysis()] as generate <<schema>>
    [saveFormatsConfig()] as save <<persistence>>

    note right of detection
      **AdaptiveTranscriptFormatDetector**
      Pattern recognition and schema creation
      for automatic format learning
    end note
  }

  database "Configuration Storage" as storage #F5F5F5 {
    file "transcript-formats.json" as config <<learned>>

    note right of storage
      Persisted format schemas
      Learned from real transcripts
    end note
  }
}

' Data flow
extract -down-> main : delegates to
main -down-> cache : uses
cache -down-> detect : calls when needed
detect -down-> analyze : analyzes messages
analyze -down-> generate : creates schema
generate -down-> save : persists
save -down-> config : stores

' Fallback
extract -right-> legacy : falls back if needed

' Strategy application
main -left-> strategy : applies format-specific

@enduml
