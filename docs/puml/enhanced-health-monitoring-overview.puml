@startuml
!include _standard-style.puml

title Health Monitoring System Architecture\nWith Global Process Supervisor

top to bottom direction

package "Active Supervision Layer" {
  component [GlobalProcessSupervisor] as GPS <<supervisor>>
  note right of GPS
    **Global Process Supervisor**
    - 30s supervision loop
    - Dynamic project discovery
    - 5-min cooldown per service
    - Max 10 restarts/hour
    - Heartbeat: .health/supervisor-heartbeat.json
  end note
}

package "Pre-Session Verification" {
  component [MonitoringVerifier] as MV <<verifier>>
  note right of MV
    **Startup Gate**
    - Exit 0=OK, 1=FAIL, 2=WARN
    - Blocks Claude if unhealthy
  end note
}

package "Health Verification Layer" {
  component [HealthVerifier] as HV <<verifier>>
  note right of HV
    **Layer 3 Verification**
    - 60s periodic checks
    - Dynamic discovery of ALL projects
    - Auto-healing triggers
  end note
}

package "Status Aggregation Layer" {
  component [StatusLineHealthMonitor] as SHM <<monitor>>
  component [CombinedStatusLine] as CSL <<display>>
  note right of SHM
    **Status Aggregation**
    - 15s updates
    - Multi-session status display
    - Health file aggregation
  end note
  note right of CSL
    **Status Display + Master Supervisor**
    - ensureGlobalProcessSupervisorRunning()
    - ensureStatuslineHealthMonitorRunning()
    - ensureAllTranscriptMonitorsRunning()
    - Runs on every Claude prompt
  end note
}

package "Per-Project Monitoring" {
  component [EnhancedTranscriptMonitor] as ETM <<per_project>>
  component [LiveLoggingCoordinator] as LLC <<coordinator>>
  note right of ETM
    **Per-Project Monitor**
    - 2s check interval
    - LSL generation
    - Trajectory analysis
  end note
}

package "Core Infrastructure" {
  component [ProcessStateManager] as PSM <<core>>
  database [.live-process-registry.json] as LPR <<storage>>
}

package "Health Data Storage" {
  database [.health/*-transcript-monitor-health.json] as Health_Files <<per_project>>
  database [.health/supervisor-heartbeat.json] as Heartbeat <<central>>
  database [.health/verification-status.json] as Verify_Status <<central>>
}

package "Discovery Sources" {
  database [PSM Registry] as PSM_Reg <<source>>
  database [Health Files] as HF_Src <<source>>
  database [Claude Transcript Dirs] as CT_Src <<source>>
}

' Global Process Supervisor connections
GPS --> PSM : uses for registration
GPS --> Health_Files : checks freshness
GPS --> ETM : restarts if dead
GPS --> SHM : restarts if dead
GPS --> HV : restarts if dead
GPS --> Heartbeat : writes heartbeat

' Discovery
GPS ..> PSM_Reg : discovers projects
GPS ..> HF_Src : discovers projects
GPS ..> CT_Src : discovers projects

' Health Verifier connections
HV --> PSM : uses
HV --> Verify_Status : writes reports
HV ..> PSM_Reg : dynamic discovery
HV ..> HF_Src : dynamic discovery

' Verification chain
MV ..> GPS : verifies running
MV ..> HV : triggers

' Status aggregation
SHM --> Health_Files : aggregates
SHM --> Verify_Status : reads
CSL --> SHM : queries status
CSL --> ETM : ensures running (fallback)
CSL --> GPS : **ensures running (master)**
CSL --> SHM : ensures running

' Per-project monitoring
ETM --> Health_Files : writes health
ETM --> LLC : uses for LSL
ETM --> PSM : registers

' PSM is central
PSM --> LPR : manages
LLC --> PSM : uses

legend right
  |= Component |= Responsibility |= Check Interval |
  | CombinedStatusLine | **Master supervisor** - ensures GPS + SHM running | Every prompt |
  | GlobalProcessSupervisor | Active supervision, restart dead services | 30s |
  | HealthVerifier | Multi-project health verification (Docker-aware) | 60s |
  | StatusLineHealthMonitor | Status aggregation & display | 15s |
  | EnhancedTranscriptMonitor | Per-project LSL & health | 2s |
endlegend

@enduml
