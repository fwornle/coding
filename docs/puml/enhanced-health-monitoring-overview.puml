@startuml
!include _standard-style.puml

title Enhanced Health Monitoring System - 6-Layer Architecture

top to bottom direction

package "Layer 0: System Failsafe" {
  component [SystemMonitorWatchdog] as SMW <<layer0>>
}

package "Layer 1: Service Management" {
  component [GlobalServiceCoordinator] as GSC <<layer1>>
  component [GlobalLSLCoordinator] as GLC <<layer1>>
}

package "Layer 2: Pre-Session Verification" {
  component [MonitoringVerifier] as MV <<layer2>>
}

package "Layer 3: Health Verification" {
  component [HealthVerifier] as HV <<layer3>>
}

package "Layer 4: Presentation" {
  component [StatusLineHealthMonitor] as SHM <<layer4>>
  component [Combined Status Line] as CSL <<display>>
}

package "Layer 5: Per-Project Monitoring" {
  component [EnhancedTranscriptMonitor] as ETM <<layer5>>
  component [LiveLoggingCoordinator] as LLC <<layer5>>
}

package "Core Infrastructure" {
  component [ProcessStateManager] as PSM <<core>>
  database [.live-process-registry.json] as LPR <<storage>>
}

package "Health Data Storage" {
  database [.health/*.json] as Health_Files <<per_project>>
  database [.global-lsl-registry.json] as LSL_Registry <<central>>
  database [.health/verification-status.json] as Verify_Status <<central>>
}

' Layer relationships
SMW CONTROL_LINE GSC : monitors & restarts
GSC CONTROL_LINE GLC : coordinates
GLC CONTROL_LINE ETM : ensures & recovers

' Verification chain
MV ..> SMW : verifies
MV ..> GSC : verifies
MV ..> HV : triggers

' Health flow
HV DATA_LINE Verify_Status : writes reports
SHM SYNC_LINE Health_Files : aggregates
SHM SYNC_LINE Verify_Status : reads status
CSL SYNC_LINE SHM : queries

' Per-project monitoring
ETM DATA_LINE Health_Files : writes health
ETM ..> LLC : uses

' PSM is central
PSM DATA_LINE LPR : manages
SMW --> PSM : uses
GSC --> PSM : uses
GLC --> PSM : uses
MV --> PSM : uses
HV --> PSM : uses
SHM --> PSM : uses
ETM --> PSM : uses

' Registry updates
GLC ASYNC_LINE LSL_Registry : maintains

note right of SMW
  **Layer 0: Ultimate Failsafe**
  - Runs via cron/launchd (60s)
  - Ensures GSC always runs
  - Cannot be killed by user
end note

note right of GSC
  **Layer 1: Service Daemon**
  - 15s health checks
  - Exponential backoff
  - Manages MCP servers
end note

note right of MV
  **Layer 2: Pre-Session**
  - Exit 0=OK, 1=FAIL, 2=WARN
  - Must pass before Claude
end note

note right of HV
  **Layer 3: Verification**
  - 60s periodic checks
  - Auto-healing triggers
  - DB/Service/Process checks
end note

note right of SHM
  **Layer 4: Aggregation**
  - 15s updates
  - Only running monitors shown
  - Outputs status line text
end note

note right of ETM
  **Layer 5: Per-Project**
  - 2s check interval
  - Centralized health files
  - LSL generation
end note

note bottom of PSM
  **Core Infrastructure**
  Used by ALL other classes
  Atomic file locking
  Singleton management
end note

@enduml
