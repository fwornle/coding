!include _standard-style.puml

@startuml lsl-enhanced-system-overview

title Enhanced LSL System with Global Coordinator

package "Enhanced Live Session Logging System" {

  ' Global Coordinator Layer
  package "Global Coordinator Layer" as GCL {
    [Global LSL Coordinator] as GLC
    [Session Registry] as Registry
    [Health Monitor] as Health
    [Process Manager] as ProcessMgr
    database "session-registry.json" as SessionDB
    
    GLC --> Registry
    GLC --> Health
    GLC --> ProcessMgr
    Registry --> SessionDB
    Health --> ProcessMgr : "restart failed monitors"
  }

  ' Launch Integration Layer  
  package "Launch Integration" as Launch {
    [coding launcher] as Coding
    [launch-claude.sh] as LaunchScript
    [Claude Code Process] as ClaudeProcess
    
    Coding --> LaunchScript : "exec"
    LaunchScript --> ClaudeProcess : "start Claude"
    LaunchScript --> GLC : "ensure LSL"
  }

  ' Monitoring Layer
  package "Real-time Monitoring Layer" as RTM {
    [Enhanced Transcript Monitor] as ETM
    [ReliableCodingClassifier] as RCC
    [Three-Layer Analysis] as ThreeLayer
    
    ETM --> RCC : "classify exchanges"
    RCC --> ThreeLayer : "PathAnalyzer → Keywords → Semantic"
  }

  ' Classification Engine
  package "Classification Engine" as CE {
    rectangle "Layer 1: PathAnalyzer" as L1 {
      [File Operation Detection] as FileOps
      [Repository Path Analysis] as PathAnalysis
      FileOps --> PathAnalysis
    }
    
    rectangle "Layer 2: KeywordMatcher" as L2 {
      [Primary Keywords] as Primary
      [Secondary Keywords] as Secondary  
      [File Patterns] as FilePatterns
      Primary --> Secondary
      Secondary --> FilePatterns
    }
    
    rectangle "Layer 3: SemanticAnalyzer" as L3 {
      [LLM Analysis] as LLM
      [Context Understanding] as Context
      [Confidence Scoring] as Confidence
      LLM --> Context
      Context --> Confidence
    }
    
    L1 --> L2 : "if no file operations"
    L2 --> L3 : "if keyword confidence < threshold"
  }

  ' Content Routing
  package "Content Routing" as CR {
    [Route Determiner] as Router
    [Session File Writer] as Writer
    [Time Window Calculator] as TimeCalc
    
    Router --> Writer
    Writer --> TimeCalc : "organize by time windows"
  }

  ' Output Destinations
  package "Output Layer" as Output {
    folder "coding/.specstory/history/" as CodingOutput {
      file "2025-09-13_1200-1300-session.md" as CodingSession
      file "2025-09-13_1200-1300-session-from-nano-degree.md" as CrossProject
    }
    
    folder "project-x/.specstory/history/" as ProjectOutput {
      file "2025-09-13_1200-1300-session.md" as ProjectSession  
    }
    
    folder "nano-degree/.specstory/history/" as NanoDegreeOutput {
      file "2025-09-13_1200-1300-session.md" as NanoSession
    }
  }

  ' Batch Processing
  package "Batch Processing" as BP {
    [LSL Generation Scripts] as LSLScripts
    [Parallel Worker Pool] as Workers
    [Fast-Path Classification] as FastPath
    
    LSLScripts --> Workers : "5 concurrent processes"
    Workers --> FastPath : "skip semantic analysis"
  }

  ' Status Integration
  package "Status Integration" as SI {
    [Status Line Provider] as StatusProvider
    [Activity Indicators] as Indicators
    [Time Window Display] as TimeDisplay
    
    StatusProvider --> Indicators : "coding activity"
    StatusProvider --> TimeDisplay : "window progress"
  }

}

' System Flow
Health --> ETM : "monitor health (30s)"
ProcessMgr --> ETM : "spawn/restart"
ETM --> CE : "real-time classification"
CE --> CR : "routing decisions"
CR --> CodingOutput : "coding infrastructure"
CR --> ProjectOutput : "project content"
CR --> NanoDegreeOutput : "all content"

FastPath --> CE : "path + keywords only"
LSLScripts --> CR : "batch generation"

ETM --> SI : "activity status"
SI --> LaunchScript : "status line integration"

note right of GLC
  **Robust Features:**
  - Session registry with health monitoring
  - Automatic monitor recovery
  - Cross-project session tracking
  - 30-second health check intervals
  - Clean process lifecycle management
end note

note right of CE
  **Three-Layer Architecture:**
  - Layer 1: 100% accurate file operation detection
  - Layer 2: Fast keyword-based classification  
  - Layer 3: LLM semantic understanding (selective)
  - Performance: 200x faster than previous versions
end note

note right of BP
  **Batch Processing:**
  - Mode: local (all content) or foreign (coding only)
  - Parallel processing (5 workers)
  - Fast-path optimization
  - 111 transcript files processed in seconds
end note

@enduml