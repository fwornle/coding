@startuml graphology-memory-architecture
!include _standard-style.puml


title Graphology Memory Fallback Architecture

box "Application Layer" #E8F4F8
    participant "CoPilot Adapter" as Adapter
    participant "HTTP Server" as HTTP
end box

box "Memory Service Layer" #F0E6FF
    participant "Memory Fallback\nService" as Service
    participant "Sync Manager" as Sync
end box

box "Graph Operations" #E6F7E6
    participant "Graphology\nIn-Memory Graph" as Graph
    participant "Node Operations" as Nodes
    participant "Edge Operations" as Edges
    participant "Search Engine" as Search
end box

box "Persistence Layer" #FFE6E6
    participant "Local Storage\n(.coding-tools/memory.json)" as Local
    participant "Knowledge Export\n(.data/knowledge-export/)" as Shared
    participant "Timer (30s)" as Timer
end box

== Initialization ==
Adapter -> Service: Initialize service
Service -> Shared: Load existing entities/relations
Shared -> Graph: Import to Graphology graph
Service -> Timer: Start auto-sync timer
Timer -> Sync: Schedule periodic sync

== Entity Creation ==
HTTP -> Service: createEntities(entities)
Service -> Graph: addNode(entity)
Graph -> Nodes: Node management
Service -> Local: Save to local JSON
Service -> Sync: Trigger immediate sync
Sync -> Shared: Export to knowledge-export/<team>.json

== Search Operations ==
HTTP -> Service: searchNodes(query)
Service -> Graph: forEachNode(matcher)
Graph -> Search: Query processing
Search -> Service: Return results
Service -> HTTP: Formatted results

== Periodic Sync ==
Timer -> Sync: Every 30 seconds
Sync -> Graph: Export all nodes/edges
Graph -> Sync: Graph data
Sync -> Shared: Update knowledge-export/<team>.json

== Cross-Agent Compatibility ==
note over Shared
    **knowledge-export/<team>.json Format:**
    {
      "entities": [...],
      "relations": [...],
      "metadata": {
        "last_updated": "...",
        "total_entities": N,
        "total_relations": M
      }
    }
end note

note over Graph
    **Graphology Benefits:**
    - Fast in-memory operations
    - Rich graph algorithms
    - Multi-graph support
    - JSON serialization
end note

note over Sync
    **Sync Strategy:**
    - On startup: Load from shared
    - On modify: Immediate sync
    - Periodic: 30s auto-sync
    - On shutdown: Final sync
end note

@enduml