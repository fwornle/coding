@startuml Fallback Services Detailed Architecture
!include _standard-style.puml


title Fallback Services Detailed Architecture

package "GitHub CoPilot Environment" {
    [GitHub CoPilot] as copilot
    [VSCode Extension] as vscode
    [HTTP Client] as httpclient
}

package "CoPilot Adapter" {
    [Adapter Interface] as adapter
    [Service Manager] as manager
    [Health Monitor] as health
}

package "Memory Fallback Service" {
    [Graphology Graph] as graph
    [Memory Service] as memory
    [Sync Manager] as sync
    [Search Engine] as search
}

package "Browser Fallback Service" {
    [Playwright] as playwright
    [Action Parser] as parser
    [Page Manager] as pages
    [Browser Instance] as browser
}

package "Logger Fallback Service" {
    [Logger Service] as logger
    [Specstory Adapter] as specstory
    [File Logger] as filelogger
    [Extension Detector] as detector
}

package "HTTP Server" {
    [Express Server] as express
    [WebSocket Server] as websocket
    [API Endpoints] as api
    [Service Router] as router
}

package "Persistence & Sync" {
    [shared-memory.json] as shared
    [.coding-tools/memory.json] as local
    [.specstory/history/] as history
    [Backup System] as backup
}

package "Shared Interfaces" {
    [Agent Adapter] as agentadapter
    [Memory Interface] as memoryintf
    [Browser Interface] as browserintf
    [Logger Interface] as loggerintf
}

' CoPilot to Adapter Flow
copilot --> vscode : @km commands
vscode --> httpclient : HTTP requests
httpclient --> express : API calls
express --> router : Route requests
router --> adapter : Service calls

' Adapter to Services
adapter --> manager : Initialize services
manager --> memory : Memory service
manager --> playwright : Browser service  
manager --> logger : Logger service
manager --> health : Health monitoring

' Memory Service Details
memory --> graph : In-memory operations
memory --> sync : Sync coordination
memory --> search : Query processing
sync --> local : Local persistence
sync --> shared : Cross-agent sync

' Browser Service Details
playwright --> browser : Browser lifecycle
playwright --> pages : Page management
playwright --> parser : Action parsing

' Logger Service Details
logger --> detector : Detect VSCode extensions
detector --> specstory : Specstory integration
detector --> filelogger : File-based fallback
logger --> history : Log storage

' HTTP Server Details  
express --> api : REST endpoints
express --> websocket : Real-time updates
api --> memory : Memory operations
api --> playwright : Browser operations
api --> logger : Logging operations

' Interface Adapters
memory --> agentadapter : Unified interface
playwright --> agentadapter : Unified interface
logger --> agentadapter : Unified interface
agentadapter --> memoryintf : Memory abstraction
agentadapter --> browserintf : Browser abstraction
agentadapter --> loggerintf : Logger abstraction

' Persistence
shared --> backup : Automated backups
local --> backup : Local backups
history --> backup : Log backups

' Health & Monitoring
health --> memory : Service health
health --> playwright : Service health
health --> logger : Service health
health --> express : Server health

note top of graph
    **Graphology Features:**
    - In-memory graph operations
    - Fast search & traversal
    - Auto-sync to shared storage
    - Cross-agent compatibility
end note

note top of specstory
    **Multi-Modal Logging:**
    - Specstory extension (preferred)
    - File-based fallback
    - WebSocket real-time updates
    - Cross-project routing
end note

note top of parser
    **Natural Language Actions:**
    - "Click the login button"
    - "Type 'hello' into search"
    - "Scroll to bottom"
    - Variable substitution
end note

note bottom of shared
    **Cross-Agent Storage:**
    - Claude Code ↔ MCP Memory
    - CoPilot ↔ Graphology
    - Automatic synchronization
    - Git-tracked for teams
end note

@enduml