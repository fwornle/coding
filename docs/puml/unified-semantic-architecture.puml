@startuml unified-semantic-architecture
!include _standard-style.puml

title "Unified Semantic Analysis & Knowledge Management System"

package "AI Coding Assistants" {
  [Claude Code\n(MCP Tools)] <<external>> as claude
  [GitHub CoPilot\n(VSCode Extension)] <<external>> as copilot
}

package "Unified Interface Layer" {
  [MCP Server\nUnified Commands] <<api>> as mcp
  [HTTP API Server\nVSCode Integration] <<api>> as http
}

package "Single Agent System Infrastructure" {
  [Coordinator Agent\n(Orchestrates workflows)] <<agent>> as coordinator
  [Semantic Analysis Agent\n(Code & conversation analysis)] <<agent>> as semantic
  [Knowledge Graph Agent\n(Entity & relationship extraction)] <<agent>> as knowledge
  [Web Search Agent\n(Documentation research)] <<agent>> as web
  [SynchronizationAgent\n(SINGLE SOURCE OF TRUTH)] <<agent>> as sync
  [Deduplication Agent\n(Prevents duplicate insights)] <<agent>> as dedup
  [Documentation Agent\n(Creates structured docs)] <<agent>> as docs
}

package "Multi-Database Storage" {
  database "MCP Memory\n(Claude Sessions)" <<storage>> as mcpmem
  database "Graphology\n(CoPilot Integration)" <<storage>> as graphology
  database "shared-memory.json\n(Git-tracked persistence)" <<storage>> as sharedmem
}

package "Communication Infrastructure" {
  [MQTT Broker\n(Agent messaging)] <<infra>> as mqtt
  [JSON-RPC Server\n(Synchronous calls)] <<infra>> as rpc
}

package "Visualization & Monitoring" {
  [VKB Web Interface\n(Knowledge graph viewer)] <<cli>> as vkb
  [Progress Logging\n(Agent activity monitor)] <<util>> as logging
  [System Status\n(Health monitoring)] <<util>> as status
}

' User connections
claude SYNC_LINE mcp : "MCP Protocol"
copilot SYNC_LINE http : "HTTP/WebSocket"

' Interface to agent system
mcp CONTROL_LINE coordinator : "Start workflows"
http CONTROL_LINE coordinator : "API requests"

' Agent system internal communication
coordinator CONTROL_LINE semantic : "Analyze code/conversation"
coordinator CONTROL_LINE knowledge : "Extract entities"
coordinator CONTROL_LINE web : "Research topics"
coordinator CONTROL_LINE sync : "Ensure consistency"
semantic DATA_LINE dedup : "Check duplicates"
knowledge DATA_LINE docs : "Generate documentation"

' SynchronizationAgent is the single authority
sync DATA_LINE mcpmem : "Sync to MCP"
sync DATA_LINE graphology : "Sync to Graphology"
sync DATA_LINE sharedmem : "Sync to files"

' Agent communication infrastructure
semantic ASYNC_LINE mqtt : "Message bus"
knowledge ASYNC_LINE mqtt
web ASYNC_LINE mqtt
coordinator SYNC_LINE rpc : "Sync calls"
sync SYNC_LINE rpc

' Visualization and monitoring
vkb DATA_LINE sharedmem : "Read unified data"
vkb OPTIONAL_LINE graphology : "Live graph data"
logging OPTIONAL_LINE mqtt : "Monitor agent activity"
status OPTIONAL_LINE coordinator : "Health checks"

note top of sync
  **CRITICAL**: SynchronizationAgent is the 
  SINGLE SOURCE OF TRUTH ensuring data 
  consistency across ALL databases
end note

note bottom of coordinator
  **UNIFIED**: Both Claude Code and CoPilot use
  the SAME 7-agent system for all analysis,
  ensuring consistent results regardless of AI assistant
end note

note right of mcp
  MCP Tools:
  • determine_insights
  • update_knowledge_base  
  • lessons_learned
end note

note right of http
  VSCode Integration:
  • @KM commands
  • REST API endpoints
  • WebSocket connections
end note

@enduml