@startuml unified-semantic-architecture
!include _standard-style.puml

title "Unified Semantic Analysis & Knowledge Management System"

package "AI Coding Assistants" {
  [Claude Code\n(MCP Tools)] <<external>> as claude
  [GitHub CoPilot\n(VSCode Extension)] <<external>> as copilot
}

package "Unified Interface Layer" {
  [MCP Server\nUnified Commands] <<api>> as mcp
  [HTTP API Server\nVSCode Integration] <<api>> as http
}

package "Single Agent System Infrastructure (8 Agents)" {
  [Coordinator Agent\n(Orchestrates workflows)] <<agent>> as coordinator
  [Semantic Analysis Agent\n(Code & conversation analysis)] <<agent>> as semantic
  [Repository Analyzer\n(Repository structure analysis)] <<agent>> as repo
  [Knowledge Graph Agent\n(Entity & relationship extraction)] <<agent>> as knowledge
  [Web Search Agent\n(Documentation research)] <<agent>> as web
  [SynchronizationAgent\n(SINGLE SOURCE OF TRUTH)] <<agent>> as sync
  [Deduplication Agent\n(Prevents duplicate insights)] <<agent>> as dedup
  [Documentation Agent\n(Creates structured docs)] <<agent>> as docs
}

package "Multi-Database Storage" {
  database "MCP Memory\n(Claude Sessions)" <<storage>> as mcpmem
  database "Graphology\n(CoPilot Integration)" <<storage>> as graphology
  database "shared-memory.json\n(Git-tracked persistence)" <<storage>> as sharedmem
}

package "External Services" {
  cloud "Custom LLM\n(Primary Provider)" <<external>> as custom
  cloud "Anthropic Claude\n(Secondary Provider)" <<external>> as anthropic
  cloud "OpenAI GPT\n(Fallback Provider)" <<external>> as openai
  cloud "Web Search APIs\n(DuckDuckGo)" <<external>> as websearch
}

package "Visualization & Monitoring" {
  [VKB Web Interface\n(Knowledge graph viewer)] <<cli>> as vkb
  [Progress Logging\n(Agent activity monitor)] <<util>> as logging
  [System Status\n(Health monitoring)] <<util>> as status
}

' User connections
claude --> mcp : "MCP Protocol"
copilot --> http : "HTTP/WebSocket"

' Interface to agent system
mcp --> coordinator : "Start workflows"
http --> coordinator : "API requests"

' Agent system internal communication (Node.js direct calls)
coordinator --> semantic : "Analyze code/conversation"
coordinator --> repo : "Scan repository"
coordinator --> knowledge : "Extract entities"
coordinator --> web : "Research topics"
coordinator --> sync : "Ensure consistency"
semantic --> dedup : "Check duplicates"
repo --> knowledge : "Structure analysis"
knowledge --> docs : "Generate documentation"

' SynchronizationAgent is the single authority
sync --> mcpmem : "Sync to MCP"
sync --> graphology : "Sync to Graphology"
sync --> sharedmem : "Sync to files"

' External service connections
semantic ..> custom : "Primary LLM"
semantic ..> anthropic : "Secondary LLM"
semantic .> openai : "Fallback LLM"
web ..> websearch : "Documentation Search"

' Visualization and monitoring
vkb --> sharedmem : "Read unified data"
vkb ..> graphology : "Live graph data"
logging ..> coordinator : "Monitor agent activity"
status ..> coordinator : "Health checks"

note top of sync
  **CRITICAL**: SynchronizationAgent is the 
  SINGLE SOURCE OF TRUTH ensuring data 
  consistency across ALL databases
end note

note bottom of coordinator
  **UNIFIED**: Both Claude Code and CoPilot use
  the SAME 8-agent system for all analysis,
  ensuring consistent results regardless of AI assistant
end note

note right of mcp
  12 MCP Tools:
  • determine_insights
  • analyze_code/repository
  • extract_patterns
  • create_ukb_entity
  • execute_workflow
  • generate_documentation
  • + 6 more tools
end note

note right of http
  VSCode Integration:
  • @KM commands
  • REST API endpoints
  • WebSocket connections
end note

note right of custom
  **3-Tier Provider Chain**:
  • Custom LLM (Primary)
  • Anthropic Claude (Secondary)
  • OpenAI GPT (Fallback)
  • Graceful degradation
end note

note right of anthropic
  **Node.js Architecture**:
  • Direct TypeScript calls
  • No MQTT/JSON-RPC overhead
  • Stable connections
  • Provider fallback chain
end note

@enduml