@startuml agent-agnostic-architecture-components
!include _standard-style.puml

title Agent-Agnostic Architecture\nCoding System

top to bottom direction

package "Agent Layer" {
    component "Claude Code\n(MCP)" as claude <<agent>>
    component "GitHub CoPilot\n(CLI)" as copilot <<agent>>
    component "Future Agent\n(Any)" as future <<agent>>
}

package "Launcher Layer" {
    component "bin/coding\n(Main Entry)" as main <<launcher>>
    component "launch-claude.sh\n(Claude Specific)" as launch_claude <<launcher>>
    component "launch-copilot.sh\n(CoPilot Specific)" as launch_copilot <<launcher>>
    component "launch-future.sh\n(Future Agent)" as launch_future <<launcher>>
}

package "Tmux Wrapper Layer" {
    component "tmux-session-wrapper.sh\n(Unified Status Bar)" as tmux_wrapper <<infra>>
}

package "Common Setup Layer" {
    component "agent-common-setup.sh" as common <<common>> {
        [ensure_specstory_logs_tracked()]
        [start_transcript_monitoring()]
        [start_statusline_health_monitor()]
        [start_global_lsl_monitoring()]
        [show_session_reminder()]
        [agent_common_init()]
    }
}

package "Shared Services Layer" {
    component "start-services.sh\n(Native Mode)" as services_native <<service>> {
        [VKB Server]
        [Semantic Analysis]
        [Constraint Monitor\n(standalone containers)]
        [Live Logging System]
    }
    component "docker compose\n(Docker Mode)" as services_docker <<infra>> {
        [coding-services\n(all-in-one container)]
    }
}

package "Agent Adapter Layer" {
    component "AgentAdapter\n(Interface)" as adapter_interface <<api>>
    component "ClaudeMCPAdapter" as claude_adapter <<agent>>
    component "CoPilotAdapter" as copilot_adapter <<agent>>
    component "AgentRegistry" as registry <<core>>
    component "AgentDetector" as detector <<core>>
}

' Main flow
main --> launch_claude : "--claude or\nauto-detect"
main --> launch_copilot : "--copilot"
main --> launch_future : "--agent future"

' Launchers source common setup
launch_claude ..> common : sources
launch_copilot ..> common : sources
launch_future ..> common : sources

' Launchers use services (Docker or Native mode)
launch_claude --> services_native : native mode
launch_claude --> services_docker : docker mode
launch_copilot --> services_native : native mode
launch_copilot --> services_docker : docker mode
launch_future --> services_native : starts

' Launchers use tmux wrapper to launch agents
launch_claude --> tmux_wrapper : wraps
launch_copilot --> tmux_wrapper : wraps
launch_future --> tmux_wrapper : wraps
tmux_wrapper --> claude : tmux exec
tmux_wrapper --> copilot : tmux exec
tmux_wrapper --> future : tmux exec

' Agent detection
main --> detector : detects\navailable\nagents
detector --> claude : checks
detector --> copilot : checks
detector --> future : checks

' Adapter pattern
main --> registry : gets adapter
registry --> claude_adapter : provides
registry --> copilot_adapter : provides
claude_adapter ..|> adapter_interface : implements
copilot_adapter ..|> adapter_interface : implements

' Common setup provides to all
common --> services_native : initializes
common --> services_docker : initializes

note right of tmux_wrapper
  **Tmux Wrapper provides:**
  • Unified status bar (combined-status-line.js)
  • Per-session config (not global)
  • Nesting guard (no double tmux)
  • Environment propagation
  • Mouse forwarding
end note

note right of common
  **Agent-Agnostic Functions:**
  • LSL (Live Session Logging)
  • Gitignore validation
  • Health monitoring
  • Session continuity
  • Transcript monitoring
end note

note right of adapter_interface
  **Required Interface:**
  • initialize()
  • cleanup()
  • executeCommand()
  • memoryCreate/Search/Read()
  • browserNavigate/Act/Extract()
  • logConversation()
end note

note bottom of services_native
  **Native Mode:**
  Services run as Node.js processes
  Constraint Monitor uses standalone
  Redis + Qdrant containers
end note

note bottom of services_docker
  **Docker Mode:**
  All services in coding-services
  container (Redis, Qdrant, Memgraph
  included - no duplicate containers)
end note

@enduml
