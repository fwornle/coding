@startuml semantic-analysis-enhanced-architecture
!include _standard-style.puml

title Enhanced Semantic Analysis System Architecture

package "Client Layer" {
  [CLI Interface] as CLI <<cli>>
  [MCP Client] as MCP_CLIENT <<api>>
  [HTTP Client] as HTTP_CLIENT <<api>>
  [Web Dashboard] as WEB_UI <<util>>
}

package "API Layer" {
  [MCP Server] as MCP_SERVER <<api>>
  [REST API] as REST_API <<api>>
  [GraphQL API] as GRAPHQL_API <<api>>
}

package "Enhanced Agent Layer" {
  package "Core Agents" {
    [Semantic Analysis\nAgent] as SEMANTIC_AGENT <<agent>>
    [Knowledge Graph\nAgent ✨] as KNOWLEDGE_AGENT <<agent>>
    [Coordinator\nAgent] as COORDINATOR_AGENT <<agent>>
  }
  
  package "Infrastructure Agents ⭐ NEW" {
    [Synchronization\nAgent ✨] as SYNC_AGENT <<agent>>
    [Deduplication\nAgent ✨] as DEDUP_AGENT <<agent>>
    [Documentation\nAgent] as DOC_AGENT <<agent>>
  }
  
  package "Utility Agents" {
    [Web Search\nAgent] as SEARCH_AGENT <<agent>>
    [Quality Assurance\nAgent] as QA_AGENT <<agent>>
  }
}

package "Communication Layer" {
  [MQTT Broker\n(Event Bus)] as MQTT_BROKER <<infra>>
  [JSON-RPC Server\n(Commands)] as RPC_SERVER <<infra>>
  [Event Processing] as EVENT_BUS <<infra>>
}

package "Enhanced Storage Layer ✨" {
  package "Graph Databases" {
    database [MCP Memory\nService] as MCP_MEMORY <<storage>>
    database [Graphology\nDatabase] as GRAPHOLOGY_DB <<storage>>
  }
  
  package "File Storage" {
    database [shared-memory-\ncoding.json] as JSON_CODING <<storage>>
    database [shared-memory-\nui.json] as JSON_UI <<storage>>
    database [shared-memory-\nresi.json] as JSON_RESI <<storage>>
  }
  
  package "Version Control ⭐ NEW" {
    database [Version\nStorage] as VERSION_STORAGE <<storage>>
    database [Backup\nStorage] as BACKUP_STORAGE <<storage>>
  }
}

package "External Services" {
  cloud [Claude API] as CLAUDE_API <<external>>
  cloud [OpenAI API] as OPENAI_API <<external>>
  cloud [Google Search] as GOOGLE_SEARCH <<external>>
  [UKB System] as UKB_SYSTEM <<external>>
}

' Client connections
CLI SYNC_LINE REST_API
MCP_CLIENT SYNC_LINE MCP_SERVER
HTTP_CLIENT SYNC_LINE REST_API
WEB_UI SYNC_LINE GRAPHQL_API

' API to Agent connections
MCP_SERVER SYNC_LINE KNOWLEDGE_AGENT
REST_API SYNC_LINE COORDINATOR_AGENT
GRAPHQL_API SYNC_LINE COORDINATOR_AGENT

' Agent interconnections
COORDINATOR_AGENT ASYNC_LINE EVENT_BUS
SEMANTIC_AGENT ASYNC_LINE EVENT_BUS
KNOWLEDGE_AGENT ASYNC_LINE EVENT_BUS
SYNC_AGENT ASYNC_LINE EVENT_BUS
DEDUP_AGENT ASYNC_LINE EVENT_BUS
DOC_AGENT ASYNC_LINE EVENT_BUS
SEARCH_AGENT ASYNC_LINE EVENT_BUS
QA_AGENT ASYNC_LINE EVENT_BUS

' Communication layer
EVENT_BUS CONTROL_LINE MQTT_BROKER
EVENT_BUS CONTROL_LINE RPC_SERVER

' Enhanced storage connections
SYNC_AGENT DATA_LINE MCP_MEMORY
SYNC_AGENT DATA_LINE GRAPHOLOGY_DB
SYNC_AGENT DATA_LINE JSON_CODING
SYNC_AGENT DATA_LINE JSON_UI
SYNC_AGENT DATA_LINE JSON_RESI
SYNC_AGENT DATA_LINE VERSION_STORAGE

KNOWLEDGE_AGENT DATA_LINE MCP_MEMORY
DEDUP_AGENT DATA_LINE MCP_MEMORY

' External service connections
SEMANTIC_AGENT OPTIONAL_LINE CLAUDE_API
SEMANTIC_AGENT OPTIONAL_LINE OPENAI_API
DEDUP_AGENT OPTIONAL_LINE OPENAI_API
SEARCH_AGENT OPTIONAL_LINE GOOGLE_SEARCH
KNOWLEDGE_AGENT DATA_LINE UKB_SYSTEM

' Backup and versioning
SYNC_AGENT DATA_LINE BACKUP_STORAGE
VERSION_STORAGE OPTIONAL_LINE BACKUP_STORAGE

note right of SYNC_AGENT
  **✨ Enhanced Synchronization Agent**
  • Bidirectional sync between graph DBs and JSON files
  • Real-time file watching with debouncing
  • Conflict resolution (latest-wins, merge, manual)
  • Version management with rollback capabilities
  • Multi-adapter support (MCP/Graphology)
  • Checksum validation prevents infinite loops
end note

note right of DEDUP_AGENT
  **✨ Semantic Deduplication Agent**
  • Embedding-based similarity detection
  • Multiple similarity metrics (cosine, euclidean, etc.)
  • Configurable merge strategies with thresholds
  • Batch processing with auto-merge capabilities
  • Entity grouping for visualization
  • Performance optimization with caching
end note

note right of KNOWLEDGE_AGENT
  **✨ Enhanced Knowledge Graph Agent**
  • Automatic relation creation to CollectiveKnowledge
  • Entity validation with comprehensive checks
  • Duplicate detection before creation
  • Type-based relations (Patterns, Documentation, Insights)
  • Technology-based relations from metadata
  • Team-specific knowledge organization
end note

@enduml