@startuml ukb-cli-data-flow
!include _standard-style.puml

title UKB Unified CLI Data Flow (v2.0)

skinparam activityShape rectangle
skinparam activity {
  BackgroundColor<<input>> #FFE8F4
  BackgroundColor<<process>> #E8F5E8
  BackgroundColor<<routing>> #FFE4E1
  BackgroundColor<<storage>> #FFF9E6
  BackgroundColor<<output>> #E8F4FD
}

|User Input|
start
:CLI Command;<<input>>
note right
  ukb (default incremental)
  ukb analyze [workflow]
  ukb status
  ukb checkpoint [status|reset]
  ukb config
  ukb entity [list|show|delete|search]
  ukb relation [list|show|delete|find-related]
  ukb search <query>
  ukb validate
  ukb --help
end note

|CLI Processing|
:Parse Arguments;<<process>>
note right
  UKBCli.parseArgs()
  Extract command and options
end note

:Identify Command Handler;<<process>>

|Intelligent Routing|
if (Requires VKB?) then (yes)
  :Check Server Availability;<<routing>>
  note right
    VkbApiClient.isServerAvailable()
    Ping VKB server health endpoint
  end note

  if (Server Running?) then (yes)
    :Route via HTTP API;<<routing>>
    note right
      Lock-free access
      VkbApiClient methods:
      - getEntities()
      - createEntity()
      - deleteRelation()
    end note

    |VKB Server|
    :API Endpoint Handler;<<process>>
    :GraphDB Operations;<<storage>>
    note right
      Graphology graph operations
      LevelDB persistence
    end note
  else (no)
    :Route to Direct DB Access;<<routing>>
    note right
      Fallback mode
      Direct GraphDB operations
      (Server startup required)
    end note

    |Direct Access|
    :GraphDB Operations;<<storage>>
  endif

else (no)
  |Local Operations|
  :Checkpoint Management;<<process>>
  note right
    TeamCheckpointManager
    GapAnalyzer
    ConfigManager
  end note

  :Local File Operations;<<storage>>
  note right
    Read/write checkpoints
    Load configuration
  end note
endif

|Response Processing|
:Format Response;<<process>>

:Display Results;<<output>>
note right
  Console output
  JSON formatting
  Success/error messages
end note

|Incremental Workflow|
if (Default Command?) then (yes)
  :Load Last Checkpoint;<<process>>
  note right
    TeamCheckpointManager.getLastCheckpoint()
    Identify gaps since last run
  end note

  :Analyze Gaps;<<process>>
  note right
    GapAnalyzer.identifyGaps()
    Calculate what needs processing
  end note

  :Process Missing Items;<<process>>
  :Save New Checkpoint;<<storage>>
  note right
    Update checkpoint timestamp
    Record processed items
  end note
endif

stop

@enduml
