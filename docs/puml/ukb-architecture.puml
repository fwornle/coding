@startuml ukb-architecture
!include _standard-style.puml

title UKB (Update Knowledge Base) - Current Architecture

' Entry points
package "CLI Entry Points" {
  [bin/ukb] as ukb_bin
  [ukb --interactive] as interactive
  [ukb (auto)] as auto
}

' Core implementation
package "UKB Core" {
  [lib/ukb-database/cli.js] as cli
  [DatabaseManager] as db_mgr
  [UKBDatabaseWriter] as writer
}

' Input processing
package "Knowledge Extraction" {
  [Git History Analyzer] as git_analyzer
  [StreamingKnowledgeExtractor] as extractor
  [Pattern Detector] as pattern
  [Significance Scorer] as scorer
}

' Ontology integration
package "Ontology Layer" {
  [OntologyClassifier] as ontology
  [4-Layer Classification] as layers
}

' Database layer
package "Database Services" {
  [GraphDatabaseService] as graph_db
  [SQLite Service] as sqlite
  [Qdrant Service] as qdrant
}

' Storage layer
package "Persistent Storage" {
  database "Graphology\n(In-Memory)" as graphology
  database "LevelDB\n(.data/knowledge-graph/)" as leveldb
  database "SQLite\n(.data/knowledge.db)" as sqlite_db
  database "Qdrant\n(Vector DB)" as qdrant_db
}

' Synchronized JSON export
package "Git-Tracked Export" {
  [GraphKnowledgeExporter] as exporter
  file "JSON Files\n(.data/knowledge-export/)" as json_export
}

' Visualization
package "Visualization" {
  [VKB Visualizer] as vkb
  [Web UI (port 8080)] as web
}

' Entry flow
ukb_bin --> cli
interactive --> cli
auto --> cli

' Core processing
cli --> db_mgr
cli --> writer
cli --> git_analyzer

' Knowledge extraction
git_analyzer --> extractor
extractor --> pattern
pattern --> scorer
scorer --> extractor

' Ontology classification
extractor --> ontology
ontology --> layers

' Database management
db_mgr --> graph_db
db_mgr --> sqlite
db_mgr --> qdrant

writer --> db_mgr

' Storage
graph_db --> graphology
graph_db --> leveldb
sqlite --> sqlite_db
qdrant --> qdrant_db

' Automatic JSON export (REQUIRED - keeps all storage layers in sync)
graph_db --> exporter : auto-export\n(5s debounce)
exporter --> json_export : git-tracked\nsynchronization

' Visualization
leveldb --> vkb
graphology --> vkb
vkb --> web

note right of cli
  **Entry point for all UKB operations**
  • Auto mode (git analysis)
  • Interactive mode (guided prompts)
  • Entity/relation management
  • Export/import operations
end note

note right of graph_db
  **Primary Storage System**
  • Graphology: In-memory graph
  • LevelDB: Persistent storage
  • Auto-persist: 1000ms
  • Fail-fast on errors
end note

note right of extractor
  **Knowledge Processing Pipeline**
  • Pattern detection
  • Significance scoring (1-10)
  • Ontology classification
  • MCP semantic analysis integration
end note

note right of ontology
  **4-Layer Classification**
  1. Heuristic patterns
  2. Keyword matching
  3. Semantic similarity
  4. LLM classification

  Confidence threshold: 0.7
end note

note right of exporter
  **Automatic Synchronization**
  • Debounced: 5000ms
  • Team-based files
  • Git-tracked exports
  • REQUIRED for sync
  • Keeps all layers in sync
end note

note bottom of db_mgr
  **Multi-Database Orchestration**
  • GraphDB (knowledge graph)
  • SQLite (relational queries)
  • Qdrant (vector search - optional)
  • Health status monitoring
end note

@enduml