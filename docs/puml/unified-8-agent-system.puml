@startuml unified-8-agent-system
!include _standard-style.puml

title "Unified 8-Agent System Architecture"

top to bottom direction

package "AI Coding Assistants" {
  [Claude Code\n(MCP Integration)] <<external>> as claude
  [GitHub CoPilot\n(VSCode Extension)] <<external>> as copilot
}

package "Unified Interface Layer" {
  [MCP Server\n(determine_insights,\nupdate_knowledge_base,\nlessons_learned)] <<api>> as mcp
  [HTTP API Server\n(@KM commands,\nREST endpoints)] <<api>> as http
}

package "8-Agent System Infrastructure" {
  rectangle "Coordinator Agent" <<agent>> as coordinator {
    [Workflow Management] <<core>>
    [Progress Tracking] <<core>>
    [Error Handling] <<core>>
    [Task Scheduling] <<core>>
  }
  
  rectangle "Semantic Analysis Agent" <<agent>> as semantic {
    [Content Analysis] <<core>>
    [Conversation Processing] <<core>>
    [Pattern Recognition] <<core>>
    [Significance Scoring] <<core>>
  }
  
  rectangle "Repository Analyzer" <<agent>> as repository {
    [Repository Structure] <<core>>
    [File Scanning] <<core>>
    [Dependency Analysis] <<core>>
    [Code Metrics] <<core>>
  }
  
  rectangle "Knowledge Graph Agent" <<agent>> as knowledge {
    [Entity Extraction] <<core>>
    [Relationship Mapping] <<core>>
    [Graph Management] <<core>>
    [Schema Validation] <<core>>
  }
  
  rectangle "Web Search Agent" <<agent>> as web {
    [Documentation Search] <<util>>
    [Technical Research] <<util>>
    [Context Enrichment] <<util>>
    [Reference Validation] <<util>>
  }
  
  rectangle "SynchronizationAgent\n(SINGLE SOURCE OF TRUTH)" <<agent>> as sync {
    [Multi-DB Sync] <<core>>
    [Conflict Resolution] <<core>>
    [Data Validation] <<core>>
    [Atomic Operations] <<core>>
  }
  
  rectangle "Deduplication Agent" <<agent>> as dedup {
    [Similarity Detection] <<util>>
    [Duplicate Prevention] <<util>>
    [Quality Filtering] <<util>>
    [Entity Merging] <<util>>
  }
  
  rectangle "Documentation Agent" <<agent>> as docs {
    [Markdown Generation] <<util>>
    [Diagram Creation] <<util>>
    [Template Application] <<util>>
    [Cross-referencing] <<util>>
  }
}

package "External Services" {
  cloud "Custom LLM\n(Primary Provider)" <<external>> as custom
  cloud "Anthropic Claude\n(Secondary Provider)" <<external>> as anthropic
  cloud "OpenAI GPT\n(Fallback Provider)" <<external>> as openai
  cloud "Web Search APIs\n(DuckDuckGo)" <<external>> as websearch
}

package "Multi-Database Storage" {
  database "MCP Memory\n(Claude sessions)" <<storage>> as mcpmem
  database "Graphology\n(CoPilot integration)" <<storage>> as graphology
  database "shared-memory.json\n(Git persistence)" <<storage>> as sharedmem
}

package "Monitoring & Visualization" {
  [VKB Web Interface\n(Knowledge graph viewer)] <<cli>> as vkb
  [System Health Monitor\n(Agent status & metrics)] <<util>> as health
  [Workflow Progress Viewer\n(Real-time activity)] <<util>> as progress
}

' User connections
claude --> mcp : "MCP Protocol"
copilot --> http : "HTTP/WebSocket"

' Interface to coordinator
mcp --> coordinator : "Start workflows"
http --> coordinator : "API requests"

' Agent workflows (determine_insights) - Direct Node.js calls
coordinator --> semantic : "1. Analyze content"
coordinator --> repository : "2. Scan repository"
coordinator --> knowledge : "3. Extract entities"
coordinator --> web : "4. Research context"
coordinator --> dedup : "5. Check duplicates"
coordinator --> docs : "6. Generate docs"
coordinator --> sync : "7. Sync all DBs"

' External service connections
semantic ..> custom : "Primary LLM"
semantic ..> anthropic : "Secondary LLM"
semantic .> openai : "Fallback LLM"
web ..> websearch : "Documentation Search"

' SynchronizationAgent (critical path)
sync --> mcpmem : "Ensure consistency"
sync --> graphology : "Ensure consistency"
sync --> sharedmem : "Ensure consistency"

' Monitoring
health ..> coordinator : "Check status"
progress ..> coordinator : "Track workflows"
vkb --> sharedmem : "Visualize unified data"

note top of sync
  **CRITICAL COMPONENT**
  Single source of truth ensuring
  data consistency across ALL
  storage systems
end note

note bottom of coordinator
  **UNIFIED WORKFLOWS**
  Same agent system serves both
  Claude Code and CoPilot with
  identical analysis quality
end note

note right of mcp
  12 MCP Tools:
  • determine_insights
  • analyze_code/repository
  • extract_patterns
  • create_ukb_entity
  • execute_workflow
  • generate_documentation
  • + 6 more tools
end note

note right of http
  @KM Commands:
  • @KM determine insights
  • @KM update knowledge base
  • @KM lessons learned
  • @KM search [query]
  • @KM system status
end note

note right of custom
  **3-Tier Provider Chain**:
  • Custom LLM (Primary)
  • Anthropic Claude (Secondary)
  • OpenAI GPT (Fallback)
  • Graceful degradation
end note

note right of anthropic
  **Node.js Architecture**:
  • Direct TypeScript calls
  • No MQTT/JSON-RPC overhead
  • Stable connections
  • Provider fallback chain
end note

@enduml