@startuml continuous-learning-architecture
!include _standard-style.puml

title Continuous Learning Knowledge System - Architecture Overview

top to bottom direction

package "Coding Session Layer" <<external>> {
  [Claude Code] <<cli>>
  [GitHub Copilot] <<cli>>
  [Cursor] <<cli>>
  [Generic Agent] <<cli>>
}

package "Agent Adapter Layer" <<api>> {
  [ClaudeAdapter] <<agent>>
  [CopilotAdapter] <<agent>>
  [GenericAdapter] <<agent>>
  interface "AgentAdapter\nInterface" as AdapterAPI
}

package "Core Inference Engine" <<core>> {
  [UnifiedInferenceEngine] <<core>>
  [BudgetTracker] <<util>>
  [SensitivityClassifier] <<util>>

  note right of UnifiedInferenceEngine
    **Multi-Provider Routing**
    • Groq (fast, cheap)
    • Anthropic (accurate)
    • OpenAI (fallback)
    • Local (privacy)

    **Circuit Breaker**
    • 5 failures → 1 min timeout

    **Budget Enforcement**
    • $8.33/month limit
    • Auto-fallback to local
  end note
}

package "Knowledge Management" <<core>> {
  [StreamingKnowledgeExtractor] <<core>>
  [KnowledgeRetriever] <<core>>
  [ConceptAbstractionAgent] <<agent>>
  [TemporalDecayTracker] <<util>>
}

package "Trajectory Tracking" <<core>> {
  [RealTimeTrajectoryAnalyzer] <<core>>

  note right of RealTimeTrajectoryAnalyzer
    **Intent Classification**
    • learning
    • debugging
    • feature-development
    • refactoring

    **Trajectory States**
    • exploring
    • implementing
    • verifying
    • blocked
  end note
}

package "Caching Layer" <<storage>> {
  [AgentAgnosticCache] <<storage>>
  [FileBackend] <<storage>>
  [HTTPBackend] <<storage>>
  [MCPBackend] <<storage>>
}

package "Database Layer" <<storage>> {
  database "Qdrant\n(Docker Vector Search)" as Qdrant {
    [knowledge_patterns\n1536-dim]
    [knowledge_patterns_small\n384-dim]
    [trajectory_analysis\n384-dim]
    [session_memory\n384-dim]
  }

  database "SQLite\n(Analytics)" as SQLite {
    [budget_events]
    [knowledge_extractions]
    [session_metrics]
    [embedding_cache]
  }

  note right of Qdrant
    **Continuous Learning Only**
    Real-time session knowledge
    Not used by UKB/VKB
  end note
}

package "UKB/VKB Storage" <<storage>> {
  database "Graph Database\n(Graphology + Level)" as GraphDB {
    note right
      **Manual Knowledge Capture**
      UKB/VKB use this
      Team isolation
      Git-tracked exports
    end note
  }
}

package "External Providers" <<infra>> {
  cloud "Remote LLMs" as Remote {
    [Groq]
    [Anthropic]
    [OpenAI]
  }

  cloud "Local Models" as Local {
    [Ollama]
    [vLLM]
  }
}

' Connections
[Claude Code] SYNC_LINE AdapterAPI
[GitHub Copilot] SYNC_LINE AdapterAPI
[Cursor] SYNC_LINE AdapterAPI
[Generic Agent] SYNC_LINE AdapterAPI

AdapterAPI SYNC_LINE [ClaudeAdapter]
AdapterAPI SYNC_LINE [CopilotAdapter]
AdapterAPI SYNC_LINE [GenericAdapter]

[ClaudeAdapter] SYNC_LINE [StreamingKnowledgeExtractor]
[CopilotAdapter] SYNC_LINE [StreamingKnowledgeExtractor]
[GenericAdapter] SYNC_LINE [StreamingKnowledgeExtractor]

[StreamingKnowledgeExtractor] SYNC_LINE [UnifiedInferenceEngine]
[KnowledgeRetriever] SYNC_LINE [UnifiedInferenceEngine]
[ConceptAbstractionAgent] SYNC_LINE [UnifiedInferenceEngine]
[RealTimeTrajectoryAnalyzer] SYNC_LINE [UnifiedInferenceEngine]

[UnifiedInferenceEngine] CONTROL_LINE [BudgetTracker]
[UnifiedInferenceEngine] CONTROL_LINE [SensitivityClassifier]
[UnifiedInferenceEngine] DATA_LINE Remote
[UnifiedInferenceEngine] DATA_LINE Local

[StreamingKnowledgeExtractor] DATA_LINE Qdrant
[StreamingKnowledgeExtractor] DATA_LINE SQLite
[KnowledgeRetriever] DATA_LINE Qdrant
[KnowledgeRetriever] DATA_LINE SQLite
[ConceptAbstractionAgent] DATA_LINE Qdrant
[TemporalDecayTracker] DATA_LINE Qdrant
[TemporalDecayTracker] DATA_LINE SQLite

[UnifiedInferenceEngine] ASYNC_LINE [AgentAgnosticCache]
[KnowledgeRetriever] ASYNC_LINE [AgentAgnosticCache]

[AgentAgnosticCache] OPTIONAL_LINE [FileBackend]
[AgentAgnosticCache] OPTIONAL_LINE [HTTPBackend]
[AgentAgnosticCache] OPTIONAL_LINE [MCPBackend]

[BudgetTracker] DATA_LINE SQLite
[RealTimeTrajectoryAnalyzer] DATA_LINE Qdrant
[RealTimeTrajectoryAnalyzer] DATA_LINE SQLite

' Optional manual export to Graph DB
[ConceptAbstractionAgent] OPTIONAL_LINE GraphDB : Manual export\nvia UKB

@enduml
