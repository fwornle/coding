@startuml vscode-integrated-architecture
!include _standard-style.puml

title Knowledge Management System Architecture with VSCode Integration

package "Developer Environment" {
  [Visual Studio Code] as vscode
  [GitHub Copilot Chat] as copilot
  [VSCode Extension Bridge] as extension
  [Command Palette] as palette
}

package "Knowledge Capture Layer" {
  [Git Repository] as git
  [Conversation Logs] as logs
  [UKB Command] as ukb
  [Commit Analysis] as analysis
  [Semantic Analysis] as semantic
}

package "Integration Layer" {
  [Fallback Service Client] as client
  [HTTP Server :8765] as httpserver
  [WebSocket Connection] as websocket
  [Service Manager] as servicemanager
}

package "Memory Service Layer" {
  [Graphology In-Memory Graph] as graphology
  [Memory Sync Manager] as sync
  [Local Storage (.coding-tools/memory.json)] as local
}

package "Data Storage Layer" {
  [shared-memory.json] as storage
  [.backups/] as backups
}

package "Visualization Layer" {
  [VKB Command] as vkb
  [Memory Visualizer :8080] as visualizer
  [Web Browser] as browser
}

package "Agent Integration" {
  [Claude Code] as claude
  [MCP Memory Server] as mcp
  [GitHub CoPilot] as copilot_agent
  [Fallback Services] as fallback
}

' VSCode Integration Flow
vscode --> copilot : User interaction
copilot --> extension : @km commands
extension --> client : HTTP requests
client --> httpserver : API calls
httpserver --> servicemanager : Route commands
servicemanager --> ukb : Execute UKB
servicemanager --> vkb : Execute VKB
palette --> extension : Direct commands

' WebSocket real-time updates
httpserver --> websocket : Status updates
websocket --> client : Real-time notifications
client --> extension : Service messages
extension --> copilot : UI updates

' Traditional Knowledge Flow
git --> analysis : Commit data
logs --> semantic : Conversation data
analysis --> ukb : Extracted insights
semantic --> ukb : Pattern insights
ukb --> storage : Knowledge graph updates
storage --> backups : Automated backups

' Visualization Flow
storage --> vkb : Read memory data
vkb --> visualizer : Start/manage server
visualizer --> browser : Interactive visualization
httpserver --> visualizer : Launch requests

' Memory Service Integration
httpserver --> graphology : Graph operations
graphology --> sync : Auto-sync (30s)
sync --> local : Local persistence
sync --> storage : Cross-agent sync
local <--> graphology : Fast recovery

' Agent Integration
claude <--> mcp : MCP operations
mcp <--> storage : Direct sync
copilot_agent --> fallback : Fallback services
fallback --> graphology : Memory operations
claude --> ukb : Trigger knowledge capture
copilot_agent --> logs : Generate conversations

' Extension Integration Points
extension --> ukb : Direct UKB calls
extension --> vkb : Launch VKB viewer
extension --> graphology : Search operations
httpserver --> sync : Knowledge updates

note right of extension : VSCode Extension Bridge\nIntegrates ukb/vkb into Copilot\nReal-time WebSocket updates
note right of httpserver : HTTP API Server\nHandles VSCode requests\nManages service lifecycle
note right of storage : Authoritative data source\nGit-tracked for team sharing
note right of visualizer : Interactive D3.js graph\nColor-coded by entity type
note right of graphology : Graphology In-Memory Graph\nFast operations, rich algorithms\nJSON serialization
note right of sync : Auto-Sync Manager\n30-second intervals\nImmediate on updates
note right of fallback : Fallback Services\nGraphology + Playwright + Logging\nAgent-agnostic functionality

@enduml