!include _standard-style.puml

@startuml lsl-coordinator-sequence

title Global LSL Coordinator Session Lifecycle

participant "User" as User
participant "coding launcher" as Launcher
participant "launch-claude.sh" as Script
participant "Global LSL Coordinator" as GLC
participant "Enhanced Transcript Monitor" as ETM  
participant "Session Registry" as Registry
participant "Health Monitor" as Health

== Session Startup ==
User -> Launcher : coding --claude
Launcher -> Script : exec launch-claude.sh
Script -> GLC : ensure <project> <pid>
activate GLC

GLC -> Registry : register session
Registry -> Registry : create session record
GLC -> GLC : startTranscriptMonitor()
GLC -> ETM : spawn monitor process
activate ETM
ETM -> ETM : initialize classifier
ETM -> Script : return monitor PID
GLC -> Registry : update monitor PID
GLC -> Script : LSL setup complete
Script -> User : Claude started with LSL

== Health Monitoring (Every 30 seconds) ==
loop Health Check Cycle
  Health -> Registry : get active sessions
  Health -> Health : check Claude PID exists
  alt Claude process alive
    Health -> Health : check monitor PID exists  
    alt Monitor process alive
      Health -> Registry : update health timestamp
    else Monitor died
      Health -> GLC : restart monitor
      GLC -> ETM : spawn new monitor
      ETM -> Health : return new PID
      Health -> Registry : update monitor PID
    end
  else Claude process died
    Health -> Registry : mark session ended
    Health -> Registry : remove session record
    Health -> ETM : terminate monitor
    deactivate ETM
  end
end

== Session End ==
User -> User : exit Claude
note right : Claude process ends
Health -> Health : detect dead Claude PID
Health -> Registry : cleanup session
Health -> ETM : terminate monitor
deactivate ETM
deactivate GLC

note over GLC
  **Coordinator Benefits:**
  - Zero manual intervention
  - Automatic recovery from failures
  - Cross-project session tracking
  - Robust health monitoring
  - Clean process lifecycle management
end note

@enduml