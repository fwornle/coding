@startuml
!include _standard-style.puml

title Claude Code Status Line System Architecture

top to bottom direction

' Main entry point from Claude Code
component [Claude Code] as CC <<client>>
component [~/.claude/settings.json] as Config <<config>>

' Execution layer
component [combined-status-line-wrapper.js] as Wrapper <<wrapper>>
component [combined-status-line.js] as MainScript <<orchestrator>>

' Service providers arranged horizontally
package "Status Components" {
  component [Global Config Manager] as GCM <<service>>
  component [Core Services] as CoreSvc <<service>>
  component [Constraint Monitor] as ConstraintSvc <<service>>
  component [Semantic Analysis] as SemanticSvc <<service>>
}

' Data sources
package "Data Sources" {
  database [Port Scanner] as Ports
  database [Docker Services] as Docker
  database [MCP Constraint API\nhttp://localhost:3031] as ConstraintAPI
  database [Semantic API] as SemanticAPI
}

' Status output format
package "Status Output Format" {
  component "[GCMâœ…]" as GCM_Out
  component "[CğŸŸ¢]" as Core_Out
  component "[ğŸ›¡ï¸ 85% ğŸ”EX]" as Constraint_Out
  component "[ğŸ§ APIâœ…]" as Semantic_Out
}

' Main flow
CC --> Config : reads statusLine config
Config --> Wrapper : executes every 5s
Wrapper --> MainScript : sets CODING_REPO env

' Service orchestration
MainScript --> GCM : getGlobalConfigStatus()
MainScript --> CoreSvc : getCoreServicesStatus()
MainScript --> ConstraintSvc : getConstraintStatus()
MainScript --> SemanticSvc : getSemanticStatus()

' Data source connections
GCM --> Ports : checks port availability
CoreSvc --> Docker : verifies containers
ConstraintSvc --> ConstraintAPI : GET /api/violations
SemanticSvc --> SemanticAPI : checks AI services

' Output generation
GCM --> GCM_Out : operational/warning/failed
CoreSvc --> Core_Out : healthy/degraded/failed
ConstraintSvc --> Constraint_Out : compliance % + trajectory
SemanticSvc --> Semantic_Out : API status

' Final aggregation
MainScript --> CC : [GCMâœ…] [CğŸŸ¢] [ğŸ›¡ï¸ 85% ğŸ”EX] [ğŸ§ APIâœ…]

note top of CC
  **Current Status Line Format:**
  [GCMâœ…] [CğŸŸ¢] [ğŸ›¡ï¸ 85% ğŸ”EX] [ğŸ§ APIâœ…]

  **Update Frequency:** Every 5 seconds
  **Color Coding:** Green/Yellow/Red based on overall health
end note

note right of ConstraintAPI
  **Constraint Monitor Integration:**
  â€¢ API: http://localhost:3031/api/violations
  â€¢ Data: Recent violations, compliance score
  â€¢ Calculation: 100% - penalties for violations
  â€¢ Trajectory: Activity pattern detection
  â€¢ Timeout: 2 seconds with graceful fallback
end note

note left of MainScript
  **buildCombinedStatus() Method:**
  â€¢ Parallel status collection
  â€¢ Individual component assessment
  â€¢ Overall health calculation
  â€¢ Color coding application
  â€¢ Formatted bracket output
end note

@enduml