# Docker Compose for Coding Infrastructure
# Provides containerized MCP servers, web services, and databases

version: '3.8'

services:
  # ===========================================
  # Main Application Container
  # ===========================================
  coding-services:
    build:
      context: ..
      dockerfile: docker/Dockerfile.coding-services
    container_name: coding-services
    restart: unless-stopped
    depends_on:
      qdrant:
        condition: service_healthy
      redis:
        condition: service_healthy
      memgraph:
        condition: service_healthy
    environment:
      # Service ports
      - SEMANTIC_ANALYSIS_PORT=3848
      - BROWSER_ACCESS_PORT=3847
      - CONSTRAINT_MONITOR_PORT=3849
      - CODE_GRAPH_RAG_PORT=3850
      - VKB_PORT=8080
      - HEALTH_DASHBOARD_PORT=3032
      - HEALTH_DASHBOARD_WS_PORT=3033
      # Database connections (container networking)
      - QDRANT_URL=http://qdrant:6333
      - REDIS_URL=redis://redis:6379
      - MEMGRAPH_HOST=memgraph
      - MEMGRAPH_PORT=7687
      # Project paths (mapped via volumes)
      - TARGET_REPO_PATH=/workspace
      - CODING_ROOT=/coding
      # API keys (passed through from host)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GOOGLE_AI_API_KEY=${GOOGLE_AI_API_KEY:-}
    ports:
      - "8080:8080"     # VKB Server
      - "3847:3847"     # Browser Access SSE
      - "3848:3848"     # Semantic Analysis SSE
      - "3849:3849"     # Constraint Monitor SSE
      - "3850:3850"     # Code-Graph-RAG SSE
      - "3032:3032"     # Health Dashboard HTTP
      - "3033:3033"     # Health Dashboard WebSocket
    volumes:
      # Persistent data
      - ${CODING_REPO:-.}/.data:/coding/.data
      - ${CODING_REPO:-.}/.specstory:/coding/.specstory
      # Workspace access (host repos)
      - ${HOME}/Agentic:/workspace:ro
      # Config file
      - ${CODING_REPO:-.}/.env:/coding/.env:ro
    networks:
      - coding-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ===========================================
  # Database Containers
  # ===========================================

  # Qdrant Vector Database
  qdrant:
    image: qdrant/qdrant:latest
    container_name: coding-qdrant
    restart: unless-stopped
    ports:
      - "6333:6333"     # HTTP API
      - "6334:6334"     # gRPC API
    volumes:
      - qdrant-data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    networks:
      - coding-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/readyz"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: coding-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    networks:
      - coding-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Memgraph Graph Database
  memgraph:
    image: memgraph/memgraph-platform:latest
    container_name: coding-memgraph
    restart: unless-stopped
    ports:
      - "7687:7687"     # Bolt protocol
      - "3100:3000"     # Memgraph Lab (changed to 3100 to avoid conflicts)
    volumes:
      - memgraph-data:/var/lib/memgraph
    environment:
      - MEMGRAPH="--log-level=WARNING"
    networks:
      - coding-network
    healthcheck:
      test: ["CMD-SHELL", "echo 'RETURN 1;' | mgconsole || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

# ===========================================
# Networks
# ===========================================
networks:
  coding-network:
    driver: bridge

# ===========================================
# Volumes
# ===========================================
volumes:
  qdrant-data:
  redis-data:
  memgraph-data:
