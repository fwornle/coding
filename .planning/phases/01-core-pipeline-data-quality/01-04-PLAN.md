---
phase: 01-core-pipeline-data-quality
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - integrations/mcp-server-semantic-analysis/src/agents/observation-generation-agent.ts
  - integrations/mcp-server-semantic-analysis/src/agents/insight-generation-agent.ts
autonomous: true
gap_closure: true
requirements: [NAME-01, NAME-02]

must_haves:
  truths:
    - "All entity names produced by observation-generation-agent use correct PascalCase"
    - "All entity names produced by insight-generation-agent use correct PascalCase"
    - "Raw entity.name, pattern.name, insightDoc.name inputs are normalized through toPascalCase before use"
  artifacts:
    - path: "integrations/mcp-server-semantic-analysis/src/agents/observation-generation-agent.ts"
      provides: "PascalCase normalization on all 7 naming paths"
      contains: "toPascalCase"
    - path: "integrations/mcp-server-semantic-analysis/src/agents/insight-generation-agent.ts"
      provides: "Fixed generateMeaningfulPatternName, formatPatternName, generateMeaningfulNameAndTitle"
      contains: "toPascalCase"
  key_links:
    - from: "createEntityObservation"
      to: "toPascalCase"
      via: "name normalization before assignment"
      pattern: "toPascalCase.*entity\\.name"
    - from: "createPatternObservation"
      to: "toPascalCase"
      via: "name normalization before assignment"
      pattern: "toPascalCase.*pattern\\.name"
    - from: "createInsightDocumentObservation"
      to: "toPascalCase"
      via: "name normalization before assignment"
      pattern: "toPascalCase.*insightDoc\\.name"
    - from: "generateMeaningfulPatternName"
      to: "word capitalization"
      via: "each word gets charAt(0).toUpperCase() + slice(1)"
      pattern: "charAt.*toUpperCase.*slice"
---

<objective>
Fix all entity naming paths that bypass PascalCase normalization, covering 4 paths in observation-generation-agent.ts and 3 functions in insight-generation-agent.ts.

Purpose: Phase 01 fixed toPascalCase, generateCleanEntityName, and generateEntityName, but 7 other naming paths were untouched. Four paths in observation-generation-agent.ts use raw names from upstream agents with zero normalization. Three functions in insight-generation-agent.ts have independent naming bugs. This plan fixes all of them.

Output: All entity naming paths produce correct PascalCase names.
</objective>

<execution_context>
@/Users/Q284340/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Q284340/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-pipeline-data-quality/01-02-SUMMARY.md
@.planning/debug/entity-naming-paths.md

<interfaces>
<!-- The existing toPascalCase in observation-generation-agent.ts (line 1804): -->
```typescript
private toPascalCase(input: string): string {
  const words = input
    .replace(/[-_]/g, ' ')
    .replace(/([a-z])([A-Z])/g, '$1 $2')
    .trim()
    .split(/\s+/)
    .filter(w => w.length > 0);
  return words
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join('');
}
```

<!-- UNFIXED paths in observation-generation-agent.ts: -->
<!-- createEntityObservation (line ~917): name: entity.name (RAW, no normalization) -->
<!-- createSessionObservation (line ~670): inline .map with same bug -->
<!-- createPatternObservation (line ~1178): name: patternName (RAW pattern.name) -->
<!-- createInsightDocumentObservation (line ~1041): name: cleanName (RAW insightDoc.name) -->

<!-- UNFIXED functions in insight-generation-agent.ts: -->
<!-- generateMeaningfulPatternName (line ~4503): .slice(1).toLowerCase() destroys case -->
<!-- formatPatternName (line ~4982): already fixed in Phase 01 Plan 01 - VERIFY before changing -->
<!-- generateMeaningfulNameAndTitle (line ~1517): .replace(/\s+/g, '') only removes spaces -->
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Normalize entity names in all 4 bypass paths in observation-generation-agent.ts</name>
  <files>integrations/mcp-server-semantic-analysis/src/agents/observation-generation-agent.ts</files>
  <action>
Fix four naming paths that bypass PascalCase normalization. All four use `this.toPascalCase()` which already exists in this file.

**Path A - createEntityObservation() (around line 917):**
Find the return object construction where `name: entity.name` is used raw. Change entity name assignment to normalize through toPascalCase:
```typescript
// Before (raw):
name: entity.name,
// After (normalized):
name: this.toPascalCase(entity.name),
```
Apply this to the `name` field in the returned StructuredObservation object AND to the `id` field if it uses `entity.name` directly (change to use the normalized name variable).

Better approach: Create a local variable before the return:
```typescript
const normalizedName = this.toPascalCase(entity.name);
```
Then use `normalizedName` for both the `id` and `name` fields.

**Path B - createSessionObservation() (around line 670):**
The inline naming logic at lines ~663-671 has a `.map` that does `w.charAt(0).toUpperCase() + w.slice(1)` but does NOT split camelCase boundaries for all-lowercase concatenated tokens. Replace the entire inline naming block with a call to `this.toPascalCase()`:
```typescript
// Replace the entire inline naming block (lines ~663-671):
const entityName = this.toPascalCase(
  summary.substring(0, 60).replace(/[^a-zA-Z0-9\s]/g, ' ')
);
```
Keep the length check `if (!entityName || entityName.length < 3)` that follows.

**Path C - createPatternObservation() (around line 1137):**
Find where `patternName` is assigned from `pattern.name`:
```typescript
// Before:
const patternName = pattern.name || 'UnknownPattern';
// After:
const patternName = this.toPascalCase(pattern.name || 'UnknownPattern');
```

**Path D - createInsightDocumentObservation() (around line 1039):**
Find where `cleanName` is assigned from `insightDoc.name`:
```typescript
// Before:
const cleanName = insightDoc.name || 'UnknownInsight';
// After:
const cleanName = this.toPascalCase(insightDoc.name || 'UnknownInsight');
```

After all changes, verify no raw `.name` assignments remain in any create*Observation method:
```bash
grep -n 'name:.*entity\.name\|name:.*pattern\.name\|name:.*insightDoc\.name' integrations/mcp-server-semantic-analysis/src/agents/observation-generation-agent.ts
```
This should return zero matches.
  </action>
  <verify>
    <automated>grep -c 'toPascalCase' integrations/mcp-server-semantic-analysis/src/agents/observation-generation-agent.ts</automated>
  </verify>
  <done>All 4 bypass paths (createEntityObservation, createSessionObservation, createPatternObservation, createInsightDocumentObservation) now normalize names through toPascalCase before use. No raw entity.name, pattern.name, or insightDoc.name assignments remain in observation creation methods.</done>
</task>

<task type="auto">
  <name>Task 2: Fix 3 naming functions in insight-generation-agent.ts</name>
  <files>integrations/mcp-server-semantic-analysis/src/agents/insight-generation-agent.ts</files>
  <action>
Fix three independent naming functions in insight-generation-agent.ts. This file does NOT have a shared toPascalCase utility, so the fix is applied inline to each function.

**Function 1 - generateMeaningfulPatternName() (line ~4503):**
Current bug: `.slice(1).toLowerCase()` destroys existing PascalCase.
```typescript
// Current (BROKEN):
.map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
```
Fix: Remove `.toLowerCase()` to preserve existing case:
```typescript
.map(word => word.charAt(0).toUpperCase() + word.slice(1))
```

Also fix the multi-word join bug. Current code:
```typescript
const camelCase = words[0] + words.slice(1).join('');
```
This does NOT capitalize subsequent words. Fix:
```typescript
const pascalCase = words.join('');
```
Since each word already has its first letter capitalized from the `.map()`, joining them produces correct PascalCase. Update the variable name from `camelCase` to `pascalCase` and update all references to it in the function (the `let finalName = camelCase;` line and any subsequent uses).

**Function 2 - generateMeaningfulNameAndTitle() (line ~1517):**
Current code only strips spaces:
```typescript
filename = topPattern.name.replace(/\s+/g, '');
```
This fails when input is already PascalCase with spaces (works by accident) and when input is all-lowercase (stays lowercase). Add camelCase boundary awareness:
```typescript
// Replace the space-removal line with PascalCase conversion:
filename = topPattern.name
  .replace(/[-_]/g, ' ')
  .replace(/([a-z])([A-Z])/g, '$1 $2')
  .trim()
  .split(/\s+/)
  .filter((w: string) => w.length > 0)
  .map((w: string) => w.charAt(0).toUpperCase() + w.slice(1))
  .join('');
```

**Function 3 - formatPatternName() (line ~4982):**
FIRST CHECK: This function was already fixed in Phase 01 Plan 01. Read it and verify the current state. If it already has `.slice(1)` WITHOUT `.toLowerCase()` and has camelCase boundary splitting, do NOT change it. If it still has bugs, apply the same pattern:
```typescript
.map(word => word.charAt(0).toUpperCase() + word.slice(1))  // No .toLowerCase()
```

After all changes, verify TypeScript compiles:
```bash
cd integrations/mcp-server-semantic-analysis && npx tsc --noEmit 2>&1 | grep 'error TS' | head -10
```
Only pre-existing errors in coordinator.ts should remain.
  </action>
  <verify>
    <automated>cd /Users/Q284340/Agentic/coding/integrations/mcp-server-semantic-analysis && grep -n 'toLowerCase' src/agents/insight-generation-agent.ts | grep -v '// ' | grep -v 'fillerWords\|\.has(' | head -10</automated>
  </verify>
  <done>generateMeaningfulPatternName no longer calls .toLowerCase() on word suffixes. generateMeaningfulNameAndTitle converts names to PascalCase instead of just removing spaces. formatPatternName verified or fixed. No toLowerCase() calls remain in any naming function (excluding filler word set lookups).</done>
</task>

</tasks>

<verification>
1. `grep -n 'toLowerCase' integrations/mcp-server-semantic-analysis/src/agents/insight-generation-agent.ts | grep -v '//' | grep 'slice'` returns zero matches (no .slice(1).toLowerCase() in naming functions)
2. `grep -n 'name:.*entity\.name\b' integrations/mcp-server-semantic-analysis/src/agents/observation-generation-agent.ts` returns zero matches (no raw entity.name in observation creation)
3. `grep -c 'toPascalCase' integrations/mcp-server-semantic-analysis/src/agents/observation-generation-agent.ts` returns at least 10 (existing uses + 4 new uses)
4. TypeScript compiles with no new errors: `cd integrations/mcp-server-semantic-analysis && npx tsc --noEmit 2>&1 | grep 'error TS' | wc -l`
</verification>

<success_criteria>
- All 7 naming bypass paths now produce correct PascalCase entity names
- No raw name passthrough remains in any create*Observation method
- No .toLowerCase() on .slice(1) remains in any naming function in either file
- TypeScript compiles with no new errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-pipeline-data-quality/01-04-SUMMARY.md`
</output>
