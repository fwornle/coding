---
phase: 01-core-pipeline-data-quality
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - integrations/mcp-server-semantic-analysis/src/agents/observation-generation-agent.ts
  - docker/docker-compose.yml
autonomous: true
gap_closure: true
requirements: [OBSV-01, OBSV-02]

must_haves:
  truths:
    - "createEntityObservation() successfully JSON.parses LLM responses wrapped in markdown fences"
    - "createSemanticInsightObservation() successfully JSON.parses LLM responses wrapped in markdown fences"
    - "Insight documents written inside Docker persist to the host filesystem"
  artifacts:
    - path: "integrations/mcp-server-semantic-analysis/src/agents/observation-generation-agent.ts"
      provides: "Markdown fence stripping in createEntityObservation and createSemanticInsightObservation"
      contains: "replace.*```"
    - path: "docker/docker-compose.yml"
      provides: "knowledge-management bind-mount"
      contains: "knowledge-management"
  key_links:
    - from: "createEntityObservation"
      to: "JSON.parse"
      via: "markdown fence stripping before parse"
      pattern: "replace.*```.*JSON\\.parse"
    - from: "createSemanticInsightObservation"
      to: "JSON.parse"
      via: "markdown fence stripping before parse"
      pattern: "replace.*```.*JSON\\.parse"
---

<objective>
Fix the two JSON.parse failures that cause 293+63 LLM synthesis fallbacks, and add Docker bind-mount so insight documents persist to host.

Purpose: The LLM calls SUCCEED but JSON.parse fails because responses are wrapped in ```json fences. Two methods already have the fix (createArchitecturalDecisionObservation, createCodeEvolutionObservation) -- apply the same pattern to the two unfixed methods. Also add the missing Docker volume mount for knowledge-management/ so insight files written inside the container are accessible on the host.

Output: Patched observation-generation-agent.ts and docker-compose.yml
</objective>

<execution_context>
@/Users/Q284340/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Q284340/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-pipeline-data-quality/01-02-SUMMARY.md

<interfaces>
<!-- The existing fix pattern from createArchitecturalDecisionObservation (lines 339-341): -->

```typescript
// WORKING pattern (already in codebase):
const cleaned = result.insights
  .replace(/^```json?\n?/m, '').replace(/\n?```$/m, '').trim();
synthesizedContent = JSON.parse(cleaned);
```

<!-- The BROKEN pattern in createEntityObservation (line 948): -->
```typescript
// BROKEN - no fence stripping:
synthesizedObservation = JSON.parse(result.insights);
```

<!-- The BROKEN pattern in createSemanticInsightObservation (line 1337): -->
```typescript
// BROKEN - no fence stripping:
enhancedInsights = JSON.parse(result.insights);
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add markdown fence stripping to createEntityObservation and createSemanticInsightObservation</name>
  <files>integrations/mcp-server-semantic-analysis/src/agents/observation-generation-agent.ts</files>
  <action>
In `createEntityObservation()` (around line 948), find the line:
```typescript
synthesizedObservation = JSON.parse(result.insights);
```
Replace with:
```typescript
const cleaned = result.insights
  .replace(/^```json?\n?/m, '').replace(/\n?```$/m, '').trim();
synthesizedObservation = JSON.parse(cleaned);
```

In `createSemanticInsightObservation()` (around line 1337), find the line:
```typescript
enhancedInsights = JSON.parse(result.insights);
```
Replace with:
```typescript
const cleaned = result.insights
  .replace(/^```json?\n?/m, '').replace(/\n?```$/m, '').trim();
enhancedInsights = JSON.parse(cleaned);
```

This matches the EXACT pattern already used in `createArchitecturalDecisionObservation()` (line 339) and `createCodeEvolutionObservation()` (line 461). Do NOT change anything else in these methods.

After editing, verify TypeScript compiles:
```bash
cd integrations/mcp-server-semantic-analysis && npx tsc --noEmit 2>&1 | grep -c 'error' || true
```
  </action>
  <verify>
    <automated>cd integrations/mcp-server-semantic-analysis && grep -c "replace.*\`\`\`" src/agents/observation-generation-agent.ts</automated>
  </verify>
  <done>Both createEntityObservation and createSemanticInsightObservation strip markdown fences before JSON.parse, matching the pattern used in the two already-fixed methods. The file should now have 4 occurrences of the fence-stripping regex (2 existing + 2 new).</done>
</task>

<task type="auto">
  <name>Task 2: Add knowledge-management bind-mount to Docker compose</name>
  <files>docker/docker-compose.yml</files>
  <action>
In `docker/docker-compose.yml`, find the `coding-services` volume mounts section (around line 62-74). After the line:
```yaml
      - ${CODING_REPO:-.}/.specstory:/coding/.specstory
```
Add:
```yaml
      - ${CODING_REPO:-.}/knowledge-management:/coding/knowledge-management
```

This ensures insight documents generated inside the Docker container at `/coding/knowledge-management/insights/` are persisted to the host at `knowledge-management/insights/`. The mount is read-write (no `:ro` suffix) because the container needs to write insight files.

Do NOT change any other volume mounts or settings.
  </action>
  <verify>
    <automated>grep 'knowledge-management' docker/docker-compose.yml</automated>
  </verify>
  <done>docker-compose.yml contains a bind-mount for knowledge-management directory, ensuring insight documents persist across container restarts.</done>
</task>

</tasks>

<verification>
1. `grep -c "replace.*\x60\x60\x60" integrations/mcp-server-semantic-analysis/src/agents/observation-generation-agent.ts` returns 4 or more (fence stripping in all 4 observation creation methods)
2. `grep 'knowledge-management' docker/docker-compose.yml` shows the bind-mount line
3. `cd integrations/mcp-server-semantic-analysis && npx tsc --noEmit 2>&1 | grep 'error TS' | wc -l` shows no NEW errors (pre-existing errors in coordinator.ts are known and deferred)
</verification>

<success_criteria>
- createEntityObservation and createSemanticInsightObservation both strip markdown fences before JSON.parse
- Docker compose has knowledge-management bind-mount
- No new TypeScript compilation errors introduced
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-pipeline-data-quality/01-03-SUMMARY.md`
</output>
