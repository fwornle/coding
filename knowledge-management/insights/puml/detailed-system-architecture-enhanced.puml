@startuml detailed-system-architecture-enhanced
!theme plain
skinparam backgroundColor white
skinparam defaultFontSize 10

title Enhanced Knowledge Management System - Agent-Agnostic Architecture

top to bottom direction

actor Developer as Dev

package "User Interface" as UI {
    [Terminal/CLI] as Terminal
    [Web Browser] as Browser
    [IDE Extensions] as IDE
}

package "AI Agent Integration Layer" as AgentLayer {
    frame "Claude Code Path" {
        [claude-mcp] as Launcher
        [Claude CLI] as Claude
        [MCP Framework] as MCP
    }
    
    frame "Alternative Agents" {
        [GitHub Copilot] as Copilot
        [Cursor/Other] as Other
        [Agent Abstraction] as AgentAbs
    }
    
    [Conversation Logger ✅] as Logger
}

package "Enhanced MCP Server Ecosystem" as MCPServers {
    frame "Core MCP Servers" {
        [Memory Server] as MemoryMCP
        [Browser Access] as BrowserMCP
    }
    
    frame "Semantic Analysis MCP" {
        [Semantic Analysis\nMCP Server] as SemMCP
        note right : Exposes AI agent tools:\n• analyze_repository\n• analyze_conversation\n• search_web\n• start_workflow\n• sync_with_ukb
    }
}

package "AI Agent Network" as AIAgents {
    [Semantic Analysis\nAgent] as SA
    [Web Search\nAgent] as WS  
    [Knowledge Graph\nAgent] as KG
    [Coordinator\nAgent] as CA
    
    frame "Communication Infrastructure" {
        [MQTT Broker] as MQTT
        [JSON-RPC Server] as RPC
    }
}

package "Knowledge Management Tools" as Tools {
    frame "Traditional Tools" {
        [UKB Engine] as UKB
        [VKB Server] as VKB
        [Knowledge Visualization] as Viz
    }
    
    frame "AI Enhancement Layer" {
        [Workflow Engine] as WorkflowEng
        [Pattern Recognition] as PatternRec
        [Intelligent Routing] as Routing
    }
}

package "Multi-Layer Storage" as Storage {
    frame "Persistent Storage" {
        [GraphDB + LevelDB] as SharedMem
        [.specstory/history/] as SpecStory
        [insights/] as Insights
    }
    
    frame "Runtime Storage" {
        [MCP Memory Cache] as MCPCache
        [Agent State] as AgentState
        [Workflow State] as WorkflowState
    }
    
    [Git Repository] as Git
}

package "External Services" as External {
    frame "LLM Providers" {
        [Claude API] as ClaudeAPI
        [OpenAI API] as OpenAIAPI
    }
    
    frame "Search Services" {
        [DuckDuckGo] as DDG
        [Bing API] as Bing
        [Technical Docs] as TechDocs
    }
    
    [Chrome DevTools] as Chrome
}

' User interaction paths
Dev --> Terminal : claude-mcp / copilot / other
Dev --> Browser : http://localhost:8080
Dev --> IDE : with AI extensions

' Claude Code integration path
Terminal --> Launcher : starts enhanced session
Launcher --> Claude : starts with AI tools
Claude --> MCP : JSON-RPC transport
MCP --> SemMCP : AI tool calls

' Alternative agent paths
Terminal --> Copilot : GitHub Copilot Chat
Copilot --> AgentAbs : fallback services
Terminal --> Other : other AI agents
Other --> AgentAbs : generic API

' Semantic Analysis integration
SemMCP --> MQTT : async agent coordination
SemMCP --> RPC : sync agent calls
MQTT --> SA : analysis requests
MQTT --> WS : search requests  
MQTT --> KG : entity requests
MQTT --> CA : workflow requests

RPC --> SA : immediate responses
RPC --> WS : search results
RPC --> KG : entity operations
RPC --> CA : workflow status

' AI Agent external connections
SA --> ClaudeAPI : primary analysis
SA --> OpenAIAPI : fallback analysis
WS --> DDG : web search
WS --> Bing : API search
WS --> TechDocs : documentation search

' Enhanced knowledge flow
KG --> SharedMem : bidirectional sync
KG --> MCPCache : runtime updates
CA --> WorkflowEng : orchestration
WorkflowEng --> PatternRec : pattern analysis
PatternRec --> Routing : intelligent routing

' Traditional tool integration
Terminal --> UKB : manual/auto analysis
UKB --> SharedMem : knowledge updates
UKB --> Insights : documentation
VKB --> SharedMem : visualization data
VKB --> Viz : web interface
Browser --> Viz : interactive graph

' Memory system integration
MemoryMCP --> MCPCache : session memory
MemoryMCP --> SharedMem : persistent sync
MCPCache --> SharedMem : background sync

' Conversation logging (enhanced)
Claude --> Logger : session end trigger
Copilot --> Logger : conversation capture
Other --> Logger : generic logging
Logger --> SpecStory : smart routing
Logger --> SA : content analysis

' External service integration
BrowserMCP --> Chrome : DevTools Protocol
AgentAbs --> Chrome : browser automation

' Version control
SharedMem --> Git : tracked changes
SpecStory --> Git : conversation history
Insights --> Git : documentation
AgentState --> Git : configuration

note top of AIAgents
  **Multi-Agent Architecture:**
  • Asynchronous coordination via MQTT
  • Synchronous operations via JSON-RPC
  • Intelligent workflow orchestration
  • Scalable across multiple machines
end note

note top of AgentLayer
  **Agent-Agnostic Design:**
  • Native Claude Code integration
  • Fallback services for other agents
  • Unified API regardless of agent
  • Seamless agent switching
end note

note top of Tools
  **Hybrid Toolchain:**
  • Traditional UKB/VKB preserved
  • AI-powered enhancements
  • 10x faster analysis capability
  • Backward compatibility maintained
end note

note top of Storage
  **Multi-Layer Persistence:**
  • Git-tracked shared knowledge
  • Runtime caching for performance
  • Cross-session continuity
  • Agent state management
end note

@enduml