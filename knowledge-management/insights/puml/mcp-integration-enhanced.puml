@startuml mcp-integration-enhanced
!theme plain
skinparam backgroundColor white
skinparam defaultFontSize 10
skinparam maxMessageSize 40

title Enhanced MCP Integration - Agent-Agnostic with AI Analysis

top to bottom direction

package "Agent Integration Layer" as AgentIntegration {
    frame "Claude Code Path" {
        [claude-mcp] as CLI
        [Claude CLI] as Claude
        [MCP Framework] as MCP
    }
    
    frame "Alternative Agents" {
        [GitHub Copilot] as Copilot
        [Other AI Agents] as Other
        [Fallback Services] as Fallback
    }
    
    [Post-Session Logger ✅] as Logger
}

package "Enhanced MCP Server Ecosystem" as Servers {
    frame "Core MCP Servers" {
        [Browser Server] as Browser  
        [Memory Server] as Memory
    }
    
    frame "AI Analysis Server" {
        [Semantic Analysis\nMCP Server] as SemServer
        note bottom : Tools: analyze_repository,\nanalyze_conversation,\nsearch_web, start_workflow
    }
}

package "AI Agent Network" as AINetwork {
    [Semantic Analysis] as SA
    [Web Search] as WS
    [Knowledge Graph] as KG
    [Coordinator] as CA
    
    [MQTT Broker] as MQTT
    [JSON-RPC] as RPC
}

package "Enhanced Knowledge System" as KnowledgeSystem {
    frame "Traditional Tools" {
        [UKB Command] as UKB
        [VKB Server] as VKB
    }
    
    frame "AI Enhancements" {
        [Workflow Engine] as WorkflowEng
        [Pattern Analysis] as PatternAI
        [Smart Routing] as SmartRoute
    }
    
    [GraphDB + LevelDB] as SharedMem
}

package "Multi-Layer Storage" as Storage {
    [.specstory/history/] as SpecStory
    [insights/] as Insights
    [Git Repository] as Git
    [Agent State] as AgentState
}

package "External Services" as External {
    [Claude API] as ClaudeAPI
    [OpenAI API] as OpenAIAPI
    [Search Engines] as SearchEngines
}

' Claude Code Integration Flow
CLI --> Logger : enhanced launch
Logger --> Claude : session management
Claude <--> MCP : stdio transport
MCP <--> SemServer : AI tool calls

' Alternative Agent Integration
Copilot --> Fallback : compatibility layer
Other --> Fallback : generic interface
Fallback --> SmartRoute : unified processing

' MCP Server Connections
MCP <--> Browser : web automation
MCP <--> Memory : graph operations
SemServer --> MQTT : async coordination
SemServer --> RPC : sync operations

' AI Network Processing
MQTT --> SA : analysis requests
MQTT --> WS : search requests
MQTT --> KG : entity requests
MQTT --> CA : workflow coordination

RPC --> SA : immediate analysis
RPC --> WS : search results
RPC --> KG : entity operations
RPC --> CA : status queries

' Enhanced Knowledge Flow
KG --> SharedMem : bidirectional sync
KG --> Memory : runtime updates
CA --> WorkflowEng : orchestration
WorkflowEng --> PatternAI : intelligent analysis
PatternAI --> SmartRoute : content routing

' Traditional Tool Integration
UKB --> SharedMem : manual updates
VKB --> SharedMem : visualization
UKB --> Insights : documentation
SmartRoute --> UKB : AI-enhanced input

' Logging and Persistence
Logger --> SpecStory : conversation logging
Logger --> SA : content analysis
SharedMem --> Git : version control
AgentState --> Git : configuration tracking

' External Service Integration
SA --> ClaudeAPI : primary LLM
SA --> OpenAIAPI : fallback LLM
WS --> SearchEngines : web research
Browser --> External : web automation

' Memory System Integration
Memory <--> SharedMem : persistence
Memory <--> AgentState : state management

actor Developer as Dev
Dev --> CLI : claude-mcp (enhanced)
Dev --> Copilot : alternative path
Dev --> UKB : manual insights
Dev --> VKB : knowledge exploration

note right of SemServer
  **AI Analysis Tools:**
  • Repository analysis
  • Conversation insights
  • Web research
  • Workflow orchestration
  • UKB synchronization
end note

note right of AINetwork
  **Multi-Agent Coordination:**
  • Async event processing
  • Sync request handling
  • Intelligent routing
  • Scalable architecture
end note

note right of Logger
  **Enhanced Logging:**
  • Post-session capture
  • Content analysis
  • Smart routing
  • Agent-agnostic
end note

note bottom of KnowledgeSystem
  **Hybrid Approach:**
  • Traditional tools preserved
  • AI enhancements available
  • 10x performance improvement
  • Seamless integration
end note

@enduml