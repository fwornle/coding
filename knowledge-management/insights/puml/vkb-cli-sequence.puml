@startuml
!include /Users/q284340/Agentic/coding/docs/puml/_standard-style.puml

participant VkbCli as "VkbCli (MCPAgent)"
participant GraphDatabaseService as "Graph Database Service"
participant GraphKnowledgeExporter as "Graph Knowledge Exporter"
participant PersistenceAgent as "Persistence Agent"
participant MCPTools as "MCP Tools"
participant VkbCommand as "Vkb Command"

note over VkbCli: Initialization
VkbCli ->> GraphDatabaseService: Initialize graph database
VkbCli ->> GraphKnowledgeExporter: Initialize graph knowledge exporter
VkbCli ->> PersistenceAgent: Initialize persistence agent

alt Successful Initialization
    VkbCli ->> GraphDatabaseService: Store knowledge in graph database (.data/knowledge-graph)
    GraphDatabaseService ->> GraphKnowledgeExporter: Export knowledge as JSON (.data/knowledge-export)
    GraphKnowledgeExporter ->> PersistenceAgent: Store JSON export
    PersistenceAgent ->> VkbCli: Confirm knowledge storage
end

opt Knowledge Visualization
    VkbCli ->> VkbCommand: Visualize knowledge
    VkbCommand ->> GraphDatabaseService: Retrieve knowledge from graph database
    GraphDatabaseService ->> VkbCommand: Return knowledge for visualization
end

loop Knowledge Operations
    VkbCli ->> MCPTools: Perform knowledge operations
    MCPTools ->> GraphDatabaseService: Update graph database
    GraphDatabaseService ->> GraphKnowledgeExporter: Trigger knowledge export
    GraphKnowledgeExporter ->> PersistenceAgent: Update stored JSON export
end

note over VkbCli: Verified Codebase State
VkbCli ->> VkbCli: Ensure verified codebase state for accuracy and consistency

@enduml