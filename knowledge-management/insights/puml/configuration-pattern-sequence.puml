@startuml
!include /Users/q284340/Agentic/coding/docs/puml/_standard-style.puml

actor User
participant "VkbApiClient" as VKB
participant "ConfigurationPattern" as CP
participant "PersistenceAgent" as PA
participant "GraphDatabaseService" as GDS
participant "GraphKnowledgeExporter" as GKE
participant "GraphDatabaseAdapter" as GDA
database "Graphology + LevelDB" as DB
participant "MCP Server" as MCP

User -> VKB: vkb command (visualization)
activate VKB

VKB -> CP: initialize configuration
activate CP

CP -> CP: validate environment variables\n(.env.ports file)
note right: Replaces deprecated\nshared-memory.json

alt configuration valid
    CP -> GDS: setup graph database service
    activate GDS
    
    GDS -> GDA: initialize database adapter
    activate GDA
    
    GDA -> DB: connect to storage
    activate DB
    
    CP -> PA: initialize persistence agent
    activate PA
    
    loop knowledge operations
        User -> VKB: coding command (development)
        VKB -> CP: process knowledge request
        CP -> GDS: query/update graph data
        GDS -> GDA: execute data operations
        GDA -> DB: read/write operations
        
        CP -> PA: persist changes
        PA -> GKE: trigger export
        activate GKE
        GKE -> GKE: generate JSON exports\n(.data/knowledge-export)
        deactivate GKE
    end
    
    User -> VKB: graph-sync command
    VKB -> CP: synchronize database
    CP -> GDS: sync graph data
    GDS -> PA: coordinate persistence
    PA -> MCP: update MCP server
    activate MCP
    MCP -> MCP: handle git submodules\n(code-graph-rag)
    note right: Resolved race condition\nin status operations
    deactivate MCP
    
    deactivate PA
    deactivate GDA
    deactivate DB
    deactivate GDS

else configuration invalid
    CP -> VKB: return configuration error
end

deactivate CP
deactivate VKB

@enduml