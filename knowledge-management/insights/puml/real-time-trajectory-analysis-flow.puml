@startuml real-time-trajectory-analysis-flow
!theme plain
skinparam backgroundColor white
skinparam defaultFontSize 10

title Real-Time Trajectory Analysis System - Flow and Integration

actor "Claude Code User" as User
participant "Enhanced Transcript Monitor" as Monitor
participant "Real-Time Trajectory Analyzer" as Analyzer
participant "Groq API" as GroqAPI
participant "live-state.json" as StateFile
participant "Status Line System" as StatusLine
participant "Claude Code UI" as UI

User -> Monitor : "Types code or asks questions"
activate Monitor

Monitor -> Monitor : "Detects significant exchanges\n(smart analysis rules)"
Monitor -> Analyzer : "Exchange data for analysis"
activate Analyzer

Analyzer -> Analyzer : "Check analysis frequency\n(max 50/hour)"

alt Analysis allowed
    Analyzer -> GroqAPI : "Analyze conversation pattern\nClassify trajectory state"
    activate GroqAPI
    GroqAPI -> GroqAPI : "Process with LLM\nInfer trajectory state"
    GroqAPI --> Analyzer : "State classification result\n{state: 'implementing', confidence: 0.8}"
    deactivate GroqAPI

    Analyzer -> StateFile : "Update live-state.json"
    activate StateFile
    StateFile -> StateFile : "Store state with timestamp\nand transition history"

    note right of StateFile
        {
          "currentState": "implementing",
          "lastUpdate": 1759590073127,
          "stateHistory": [
            {
              "from": "exploring",
              "to": "implementing",
              "confidence": 0.8,
              "reasoning": "User is modifying code..."
            }
          ]
        }
    end note

    deactivate StateFile
else Analysis rate limited
    Analyzer -> Analyzer : "Skip analysis\n(preserve rate limits)"
end

deactivate Analyzer

loop Every 5 seconds
    StatusLine -> StateFile : "Read current trajectory state"
    activate StatusLine
    StateFile --> StatusLine : "currentState: 'implementing'"
    StatusLine -> StatusLine : "Map to icon: âš™ï¸ IMP"
    StatusLine -> UI : "Display: [ðŸ›¡ï¸ 85% âš™ï¸ IMP]"
    activate UI
    UI --> User : "Real-time trajectory display"
    deactivate UI
    deactivate StatusLine
end

note over GroqAPI
    **External LLM Provider:**
    Fast inference for trajectory
    classification with high accuracy
end note

note over StatusLine
    **Integration Fix (2025-10-04):**
    Now reads from trajectory system
    instead of constraint monitor
end note

@enduml