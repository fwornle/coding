@startuml
!include /Users/q284340/Agentic/coding/docs/puml/_standard-style.puml

participant GraphDatabaseService as "Graph Database Service"
participant KnowledgeExporter as "Knowledge Exporter"
participant PersistenceAgent as "Persistence Agent"
participant GraphDatabaseAdapter as "Graph Database Adapter"
participant VkbApiClient as "Vkb API Client"

activate GraphDatabaseService
GraphDatabaseService ->> GraphDatabaseService: Initialize Graph Database (Graphology and LevelDB)
deactivate GraphDatabaseService

activate KnowledgeExporter
KnowledgeExporter ->> GraphDatabaseService: Listen to entity:stored events
KnowledgeExporter ->> KnowledgeExporter: Auto-export to JSON at .data/knowledge-export
deactivate KnowledgeExporter

activate PersistenceAgent
PersistenceAgent ->> GraphDatabaseAdapter: Interact with Graph Database
PersistenceAgent ->> VkbApiClient: Interact with VKB API
deactivate PersistenceAgent

activate GraphDatabaseService
GraphDatabaseService ->> KnowledgeExporter: Trigger entity:stored event
deactivate GraphDatabaseService

activate KnowledgeExporter
KnowledgeExporter ->> KnowledgeExporter: Export knowledge graph to JSON
KnowledgeExporter ->> PersistenceAgent: Notify persistence agent of export
deactivate KnowledgeExporter

activate PersistenceAgent
PersistenceAgent ->> GraphDatabaseAdapter: Update graph database
PersistenceAgent ->> VkbApiClient: Update VKB API
deactivate PersistenceAgent

activate GraphDatabaseService
GraphDatabaseService ->> GraphDatabaseService: Store knowledge graphs at .data/knowledge-graph
GraphDatabaseService ->> GraphDatabaseService: Store JSON exports at .data/knowledge-export
deactivate GraphDatabaseService

alt Synchronizing Knowledge Graph
    activate PersistenceAgent
    PersistenceAgent ->> GraphDatabaseAdapter: Synchronize knowledge graph using graph-sync command
    PersistenceAgent ->> VkbApiClient: Synchronize VKB API
    deactivate PersistenceAgent
end

@enduml