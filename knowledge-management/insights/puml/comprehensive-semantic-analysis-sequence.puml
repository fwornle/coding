@startuml
!include /Users/q284340/Agentic/coding/docs/puml/_standard-style.puml

participant "Client" as client
participant "MCP Server" as mcp
participant "ComprehensiveSemanticAnalysis" as csa
participant "KnowledgeManager" as km
participant "Graphology Graph" as graph
participant "LevelDB" as leveldb
participant "UKB Unified" as ukb

client -> mcp: semantic_analysis_request
activate mcp

mcp -> csa: analyze(content, options)
activate csa

csa -> km: initialize_knowledge_store()
activate km

km -> graph: create_graph_instance()
activate graph
graph --> km: graph_ready
deactivate graph

km -> leveldb: connect(.data/knowledge-graph)
activate leveldb
leveldb --> km: storage_ready
deactivate leveldb

km --> csa: knowledge_store_ready
deactivate km

csa -> ukb: semantic_processing(content)
activate ukb

ukb -> ukb: extract_entities()
ukb -> ukb: analyze_relationships()
ukb -> ukb: compute_embeddings()

ukb --> csa: semantic_results
deactivate ukb

csa -> km: store_semantic_data(results)
activate km

km -> graph: add_nodes(entities)
activate graph
graph --> km: nodes_added
deactivate graph

km -> graph: add_edges(relationships)
activate graph
graph --> km: edges_added
deactivate graph

km -> leveldb: persist_graph_state()
activate leveldb
leveldb --> km: state_persisted
deactivate leveldb

km --> csa: data_stored
deactivate km

opt query_knowledge
    csa -> km: query_graph(criteria)
    activate km
    km -> graph: traverse(query)
    activate graph
    graph --> km: results
    deactivate graph
    km --> csa: query_results
    deactivate km
end

csa --> mcp: analysis_complete(results)
deactivate csa

mcp --> client: semantic_analysis_response
deactivate mcp

note right of leveldb
  Storage location:
  .data/knowledge-graph
  (shared-memory.json removed)
end note

note right of csa
  Implementation spans:
  - src/knowledge-management
  - lib/ukb-unified
  - integrations/mcp-server-semantic-analysis/src
end note

@enduml