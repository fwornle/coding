@startuml
!include /Users/q284340/Agentic/coding/docs/puml/_standard-style.puml

participant "Client Application" as Client
participant "VkbApiClient" as ApiClient
participant "Knowledge Management" as KnowledgeMgmt
participant "UKB Unified" as UKB
participant "MCP Semantic Analysis" as MCP
participant "Graphology Engine" as Graph
participant "LevelDB Storage" as LevelDB
participant "JSON Export System" as JSONExport

Client -> ApiClient: Request ApiPattern data
activate ApiClient

ApiClient -> KnowledgeMgmt: Query knowledge graph
activate KnowledgeMgmt

alt Knowledge exists in graph
    KnowledgeMgmt -> Graph: Retrieve ApiPattern nodes
    activate Graph
    
    Graph -> LevelDB: Read graph data
    activate LevelDB
    LevelDB --> Graph: Return stored patterns
    deactivate LevelDB
    
    Graph --> KnowledgeMgmt: Return ApiPattern entities
    deactivate Graph
    
    KnowledgeMgmt -> UKB: Process unified knowledge
    activate UKB
    UKB --> KnowledgeMgmt: Unified pattern data
    deactivate UKB
    
else Pattern needs analysis
    KnowledgeMgmt -> MCP: Analyze codebase patterns
    activate MCP
    
    MCP -> MCP: Extract ApiPattern from:\n- src/knowledge-management\n- lib/ukb-unified\n- integrations/mcp-server-semantic-analysis/src
    
    MCP --> KnowledgeMgmt: Analyzed patterns
    deactivate MCP
    
    KnowledgeMgmt -> Graph: Store new patterns
    activate Graph
    Graph -> LevelDB: Persist to .data/knowledge-graph
    activate LevelDB
    LevelDB --> Graph: Confirm storage
    deactivate LevelDB
    deactivate Graph
end

KnowledgeMgmt -> JSONExport: Auto-sync to export
activate JSONExport
JSONExport -> JSONExport: Export to .data/knowledge-export
JSONExport --> KnowledgeMgmt: Export complete
deactivate JSONExport

KnowledgeMgmt --> ApiClient: Return ApiPattern data
deactivate KnowledgeMgmt

ApiClient --> Client: ApiPattern response
deactivate ApiClient

note over Graph, LevelDB: GraphDatabase implementation\nreplaces shared-memory.json

note over JSONExport: Auto-synced JSON exports\nfor external consumption

@enduml