#!/bin/bash
# VKB (View Knowledge Base) - Background visualization server manager
# Version 2.0 - Complete rewrite with proper server management

set -euo pipefail

# Configuration
CLAUDE_REPO="/Users/q284340/Agentic/coding"
SHARED_MEMORY="$CLAUDE_REPO/shared-memory.json"
VISUALIZER_DIR="/Users/q284340/Agentic/coding/memory-visualizer"
SERVER_PORT=8080
PID_FILE="/tmp/vkb-server.pid"
LOG_FILE="/tmp/vkb-server.log"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Error handling
error_exit() {
    echo -e "${RED}ERROR: $1${NC}" >&2
    exit 1
}

# Check if server is running
is_server_running() {
    # First check if our PID file exists and process is running
    if [[ -f "$PID_FILE" ]]; then
        local pid
        pid=$(cat "$PID_FILE")
        if kill -0 "$pid" 2>/dev/null; then
            # Check if it's actually our server
            if lsof -i ":$SERVER_PORT" -t | grep -q "$pid"; then
                return 0
            fi
        fi
        # PID file is stale, remove it
        rm -f "$PID_FILE"
    fi
    
    # Also check if any process is using our port (could be orphaned server)
    if lsof -i ":$SERVER_PORT" >/dev/null 2>&1; then
        return 0
    fi
    
    return 1
}

# Stop existing server
stop_server() {
    if [[ -f "$PID_FILE" ]]; then
        local pid
        pid=$(cat "$PID_FILE")
        if kill -0 "$pid" 2>/dev/null; then
            echo -e "${YELLOW}Stopping existing server (PID: $pid)...${NC}"
            kill "$pid" 2>/dev/null || true
            sleep 2
            # Force kill if still running
            if kill -0 "$pid" 2>/dev/null; then
                kill -9 "$pid" 2>/dev/null || true
            fi
        fi
        rm -f "$PID_FILE"
    fi
    
    # Kill any process using our port
    local port_pid
    port_pid=$(lsof -i ":$SERVER_PORT" -t 2>/dev/null || true)
    if [[ -n "$port_pid" ]]; then
        echo -e "${YELLOW}Killing process using port $SERVER_PORT (PID: $port_pid)...${NC}"
        kill "$port_pid" 2>/dev/null || true
        sleep 1
        if kill -0 "$port_pid" 2>/dev/null; then
            kill -9 "$port_pid" 2>/dev/null || true
        fi
    fi
}

# Prepare memory data for visualization
prepare_memory_data() {
    echo -e "${BLUE}üìä Preparing memory data for visualization...${NC}"
    
    # Ensure visualizer directory exists
    if [[ ! -d "$VISUALIZER_DIR" ]]; then
        error_exit "Memory visualizer directory not found: $VISUALIZER_DIR"
    fi
    
    # Check if shared memory file exists
    if [[ ! -f "$SHARED_MEMORY" ]]; then
        error_exit "Shared memory file not found: $SHARED_MEMORY"
    fi
    
    # Convert shared memory to visualizer format
    local memory_dist="$VISUALIZER_DIR/dist/memory.json"
    mkdir -p "$(dirname "$memory_dist")"
    
    # Create symlink to knowledge-management directory for serving documentation
    local km_link="$VISUALIZER_DIR/dist/knowledge-management"
    if [[ ! -L "$km_link" ]]; then
        ln -sf "$CLAUDE_REPO/knowledge-management" "$km_link" 2>/dev/null || true
    fi
    
    # Convert from our format to NDJSON format expected by visualizer
    # Also deduplicate entities to prevent orphans
    {
        # Deduplicate entities by name (keep the latest one)
        jq -r '.entities | group_by(.name) | map(max_by(.created // "2000-01-01")) | .[] | @json' "$SHARED_MEMORY" 2>/dev/null || true
        jq -r '.relations[] | @json' "$SHARED_MEMORY" 2>/dev/null || true
    } > "$memory_dist"
    
    echo -e "${GREEN}‚úì Memory data prepared${NC}"
    local entity_count relation_count
    entity_count=$(jq '.entities | length' "$SHARED_MEMORY" 2>/dev/null || echo "0")
    relation_count=$(jq '.relations | length' "$SHARED_MEMORY" 2>/dev/null || echo "0")
    echo -e "${GREEN}üìä Entities: $entity_count, Relations: $relation_count${NC}"
}

# Start visualization server
start_server() {
    echo -e "${BLUE}üöÄ Starting visualization server...${NC}"
    
    # Change to visualizer directory
    cd "$VISUALIZER_DIR"
    
    # Start HTTP server in background
    {
        python3 -m http.server "$SERVER_PORT" --directory dist 2>&1 | \
        while IFS= read -r line; do
            echo "$(date '+%Y-%m-%d %H:%M:%S') $line"
        done
    } > "$LOG_FILE" 2>&1 &
    
    local server_pid=$!
    echo "$server_pid" > "$PID_FILE"
    
    # Wait a moment and check if server started successfully
    sleep 2
    if ! kill -0 "$server_pid" 2>/dev/null; then
        rm -f "$PID_FILE"
        error_exit "Failed to start visualization server. Check $LOG_FILE for details."
    fi
    
    # Verify server is responding
    local max_attempts=10
    local attempt=1
    while (( attempt <= max_attempts )); do
        if curl -s "http://localhost:$SERVER_PORT" >/dev/null 2>&1; then
            break
        fi
        if (( attempt == max_attempts )); then
            stop_server
            error_exit "Server failed to respond after $max_attempts attempts"
        fi
        sleep 1
        ((attempt++))
    done
    
    echo -e "${GREEN}‚úÖ Visualization server started successfully!${NC}"
    echo -e "${GREEN}üåê Server PID: $server_pid${NC}"
    echo -e "${GREEN}üîó URL: http://localhost:$SERVER_PORT${NC}"
    echo -e "${GREEN}üìÑ Logs: $LOG_FILE${NC}"
}

# Open browser (optional)
open_browser() {
    if command -v open >/dev/null 2>&1; then
        echo -e "${BLUE}üåê Opening browser...${NC}"
        open "http://localhost:$SERVER_PORT" 2>/dev/null || true
    elif command -v xdg-open >/dev/null 2>&1; then
        echo -e "${BLUE}üåê Opening browser...${NC}"
        xdg-open "http://localhost:$SERVER_PORT" 2>/dev/null || true
    else
        echo -e "${YELLOW}‚ö†Ô∏è  Could not open browser automatically${NC}"
        echo -e "${YELLOW}Please open: http://localhost:$SERVER_PORT${NC}"
    fi
}

# Show server status
show_status() {
    if is_server_running; then
        echo -e "${GREEN}‚úÖ Visualization server is running${NC}"
        if [[ -f "$PID_FILE" ]]; then
            local pid
            pid=$(cat "$PID_FILE")
            echo -e "${GREEN}üåê PID: $pid${NC}"
        else
            echo -e "${GREEN}üåê PID: Unknown (server detected on port)${NC}"
        fi
        echo -e "${GREEN}üîó URL: http://localhost:$SERVER_PORT${NC}"
        echo -e "${GREEN}üìÑ Logs: $LOG_FILE${NC}"
    else
        echo -e "${RED}‚ùå Visualization server is not running${NC}"
    fi
}

# Main execution
main() {
    local command="${1:-start}"
    
    case "$command" in
        "start"|"")
            echo -e "${BLUE}üîç VKB - View Knowledge Base v2.0${NC}"
            echo -e "${BLUE}=====================================${NC}"
            
            if is_server_running; then
                echo -e "${YELLOW}‚ö†Ô∏è  Server already running${NC}"
                echo -e "${BLUE}üìä Refreshing memory data...${NC}"
                prepare_memory_data
                show_status
                open_browser
                echo -e "${GREEN}‚úÖ Data refreshed for existing server${NC}"
                return 0
            fi
            
            # Prepare data and start server
            prepare_memory_data
            start_server
            open_browser
            
            echo -e "${BLUE}üí° Server running in background. Use 'vkb stop' to stop it.${NC}"
            ;;
        "stop")
            echo -e "${BLUE}üõë Stopping visualization server...${NC}"
            stop_server
            echo -e "${GREEN}‚úÖ Server stopped${NC}"
            ;;
        "restart")
            echo -e "${BLUE}üîÑ Restarting visualization server...${NC}"
            stop_server
            prepare_memory_data
            start_server
            open_browser
            echo -e "${GREEN}‚úÖ Server restarted${NC}"
            ;;
        "status")
            show_status
            ;;
        "logs")
            if [[ -f "$LOG_FILE" ]]; then
                echo -e "${BLUE}üìÑ Server logs:${NC}"
                tail -n 20 "$LOG_FILE"
            else
                echo -e "${YELLOW}‚ö†Ô∏è  No log file found${NC}"
            fi
            ;;
        *)
            echo "Usage: $0 [start|stop|restart|status|logs]"
            echo "  start   - Start visualization server (default)"
            echo "  stop    - Stop visualization server"
            echo "  restart - Restart visualization server"
            echo "  status  - Show server status"
            echo "  logs    - Show recent server logs"
            exit 1
            ;;
    esac
}

# Execute main function
main "$@"