#!/bin/bash
#
# VKB Lightweight Script - Minimal wrapper for vkb-cli
#
# This lightweight script provides backward compatibility while
# delegating all functionality to the new vkb-cli Node.js implementation.
#

set -euo pipefail

# Get script directory and project root
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
VKB_CLI="$PROJECT_ROOT/bin/vkb-cli.js"

# Load environment variables from .env file if it exists
if [[ -f "$PROJECT_ROOT/.env" ]]; then
    set -a  # automatically export all variables
    source "$PROJECT_ROOT/.env"
    set +a
fi

# Ensure Node.js and vkb-cli are available
if ! command -v node >/dev/null 2>&1; then
    echo "Error: Node.js is required but not installed" >&2
    exit 1
fi

if [[ ! -f "$VKB_CLI" ]]; then
    echo "Error: vkb-cli not found at $VKB_CLI" >&2
    exit 1
fi

# Helper function for status formatting
show_status() {
    node "$VKB_CLI" server status
}

# Parse command for backward compatibility
case "${1:-start}" in
    "start"|"")
        shift || true
        # Handle --with-cache-clear flag
        if [[ "${1:-}" == "--with-cache-clear" ]]; then
            echo "Note: Browser cache clearing not implemented in Node.js version"
            shift || true
        fi
        # Handle data source flags
        # DEFAULT: Use GraphDB (online mode)
        DATA_SOURCE_MODE="online"
        if [[ "${1:-}" == "--with-batch" ]]; then
            # Legacy batch mode (requires knowledge-export/*.json files)
            DATA_SOURCE_MODE="combined"
            shift || true
        elif [[ "${1:-}" == "--batch-only" ]]; then
            DATA_SOURCE_MODE="batch"
            shift || true
        fi
        export VKB_DATA_SOURCE="$DATA_SOURCE_MODE"
        node "$VKB_CLI" server start "$@"
        ;;
    
    "fg"|"foreground")
        shift || true
        node "$VKB_CLI" server start --foreground "$@"
        ;;
    
    "stop")
        shift || true
        node "$VKB_CLI" server stop "$@"
        ;;
    
    "restart")
        shift || true
        # Handle --with-cache-clear flag
        if [[ "${2:-}" == "--with-cache-clear" ]]; then
            echo "Note: Browser cache clearing not implemented in Node.js version"
            shift || true
        fi
        node "$VKB_CLI" server restart "$@"
        ;;
    
    "status")
        show_status
        ;;
    
    "logs")
        shift || true
        node "$VKB_CLI" server logs "$@"
        ;;
    
    "port"|"check-port")
        # Show port usage with native tools
        echo "Checking port 8080 usage:"
        echo
        echo "Listening servers on port 8080:"
        if command -v lsof >/dev/null 2>&1; then
            lsof -i ":8080" -sTCP:LISTEN 2>/dev/null || echo "None found"
        else
            echo "lsof not available"
        fi
        ;;
    
    "--clear-cache"|"clear-cache")
        node "$VKB_CLI" clear-cache
        ;;
    
    "--with-cache-clear")
        # Start with cache clear
        echo "Note: Browser cache clearing not implemented in Node.js version"
        node "$VKB_CLI" server start
        ;;
    
    "help"|"--help"|"-h")
        cat << EOF
VKB - View Knowledge Base

Usage: vkb [command] [options]

Commands:
  start               Start visualization server (default)
  fg, foreground      Start server in foreground mode
  stop                Stop visualization server
  restart             Restart visualization server
  status              Show server status
  logs                Show server logs
  port, check-port    Check what's using port 8080
  clear-cache         Clear browser cache (not implemented)
  help                Show this help message

Options:
  --with-cache-clear  Clear cache before starting (not implemented)
  --with-batch        Include batch knowledge from knowledge-export files (combined view)
  --batch-only        Show only batch knowledge (legacy mode)

Data Sources:
  • Online (default): GraphDB knowledge (auto-learned + manual)
  • Batch (legacy):   Manual knowledge from .data/knowledge-export/*.json files
  • Combined:         Both online and batch knowledge

Examples:
  vkb                      Start with GraphDB knowledge (default)
  vkb --with-batch         Start with both GraphDB and legacy batch files
  vkb --batch-only         Start with batch files only (requires knowledge-export/*.json)
  vkb fg                   Start in foreground mode for debugging
  vkb restart              Restart the server
  vkb logs -n 50           Show last 50 log lines

This is a lightweight wrapper around vkb-cli.
For more options, use: vkb-cli --help
EOF
        ;;
    
    *)
        echo "Unknown command: $1"
        echo "Run 'vkb help' for usage information"
        exit 1
        ;;
esac