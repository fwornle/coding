#!/bin/bash
# Clean Knowledge Base - Remove garbage patterns and duplicates
# Maintains only high-quality, transferable insights

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}üßπ Knowledge Base Cleanup${NC}"
echo -e "${BLUE}========================${NC}"
echo

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CODING_ROOT="$(dirname "$SCRIPT_DIR")"
cd "$CODING_ROOT"

# Check if shared-memory.json exists
if [[ ! -f "shared-memory.json" ]]; then
    echo -e "${RED}‚ùå shared-memory.json not found${NC}"
    exit 1
fi

# Show current stats
echo -e "${BLUE}üìä Before Cleanup:${NC}"
ENTITIES=$(jq '.entities | length' shared-memory.json 2>/dev/null || echo "0")
RELATIONS=$(jq '.relations | length' shared-memory.json 2>/dev/null || echo "0")
FILE_SIZE=$(du -h shared-memory.json | cut -f1)

echo -e "  Entities: $ENTITIES"
echo -e "  Relations: $RELATIONS"
echo -e "  File size: $FILE_SIZE"

# Check for garbage patterns
GARBAGE_COUNT=$(jq '[.entities[] | select(.name | test("^(GitPattern_|ConversationPattern_|SuccessPattern_.*post-logged)"))] | length' shared-memory.json 2>/dev/null || echo "0")

if [[ "$GARBAGE_COUNT" -gt 0 ]]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Found $GARBAGE_COUNT garbage patterns${NC}"
fi

# Check for duplicate observations
ENTITIES_WITH_DUPS=$(jq '[.entities[] | select(.observations and (.observations | length) > (.observations | unique | length))] | length' shared-memory.json 2>/dev/null || echo "0")

if [[ "$ENTITIES_WITH_DUPS" -gt 0 ]]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Found $ENTITIES_WITH_DUPS entities with duplicate observations${NC}"
fi

echo

# Run cleanup if needed
if [[ "$GARBAGE_COUNT" -gt 0 ]] || [[ "$ENTITIES_WITH_DUPS" -gt 0 ]]; then
    echo -e "${BLUE}üßπ Running cleanup...${NC}"
    
    # Run garbage pattern removal
    node "$CODING_ROOT/scripts/remove-garbage-patterns.js"
    
    # Run duplicate relation cleanup
    node "$CODING_ROOT/scripts/cleanup-shared-memory.js"
    
    echo
    echo -e "${BLUE}üìä After Cleanup:${NC}"
    NEW_ENTITIES=$(jq '.entities | length' shared-memory.json 2>/dev/null || echo "0")
    NEW_RELATIONS=$(jq '.relations | length' shared-memory.json 2>/dev/null || echo "0")
    NEW_FILE_SIZE=$(du -h shared-memory.json | cut -f1)
    
    echo -e "  Entities: $NEW_ENTITIES (was $ENTITIES)"
    echo -e "  Relations: $NEW_RELATIONS (was $RELATIONS)"
    echo -e "  File size: $NEW_FILE_SIZE (was $FILE_SIZE)"
    echo
    
    REMOVED_ENTITIES=$((ENTITIES - NEW_ENTITIES))
    REMOVED_RELATIONS=$((RELATIONS - NEW_RELATIONS))
    
    if [[ "$REMOVED_ENTITIES" -gt 0 ]] || [[ "$REMOVED_RELATIONS" -gt 0 ]]; then
        echo -e "${GREEN}üóëÔ∏è  Removed: $REMOVED_ENTITIES garbage entities, $REMOVED_RELATIONS duplicate relations${NC}"
    fi
    
    echo -e "${GREEN}‚úÖ Knowledge base cleaned!${NC}"
else
    echo -e "${GREEN}‚úÖ Knowledge base is already clean!${NC}"
fi

echo
echo -e "${BLUE}üí° Quality Guidelines:${NC}"
echo -e "  ‚Ä¢ Only add significant, transferable insights"
echo -e "  ‚Ä¢ Use 'ukb --interactive' for manual curation"
echo -e "  ‚Ä¢ Avoid auto-discovery of low-quality patterns"
echo -e "  ‚Ä¢ Run 'clean-knowledge-base' periodically"