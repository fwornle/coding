#!/bin/bash

# MCP Status Check Script
# Provides detailed information about MCP server status and configuration

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
SEMANTIC_DIR="$PROJECT_DIR/semantic-analysis-system"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}═══════════════════════════════════════════════════════════════${NC}"
echo -e "${BLUE}                    MCP Server Status Check                     ${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════════════════════${NC}"
echo

# Check if semantic-analysis system exists
if [ ! -d "$SEMANTIC_DIR" ]; then
    echo -e "${RED}✗ Semantic Analysis System Not Found${NC}"
    echo -e "  Expected at: $SEMANTIC_DIR"
    exit 1
fi

# Check API keys
echo -e "${YELLOW}1. API Key Configuration:${NC}"
if [ -f "$SEMANTIC_DIR/.env" ]; then
    source "$SEMANTIC_DIR/.env"
    
    KEYS_CONFIGURED=0
    
    if [ -n "$ANTHROPIC_API_KEY" ] && [ "$ANTHROPIC_API_KEY" != "your-anthropic-api-key" ]; then
        echo -e "  ${GREEN}✓ ANTHROPIC_API_KEY configured${NC}"
        KEYS_CONFIGURED=$((KEYS_CONFIGURED + 1))
    else
        echo -e "  ${RED}✗ ANTHROPIC_API_KEY not configured${NC}"
    fi
    
    if [ -n "$OPENAI_API_KEY" ] && [ "$OPENAI_API_KEY" != "your-openai-api-key" ]; then
        echo -e "  ${GREEN}✓ OPENAI_API_KEY configured${NC}"
        KEYS_CONFIGURED=$((KEYS_CONFIGURED + 1))
    else
        echo -e "  ${RED}✗ OPENAI_API_KEY not configured${NC}"
    fi
    
    if [ $KEYS_CONFIGURED -eq 0 ]; then
        echo -e "\n  ${RED}⚠️  No API keys configured!${NC}"
        echo -e "  ${YELLOW}Configure at least one API key in:${NC}"
        echo -e "  $SEMANTIC_DIR/.env"
        echo
        echo -e "  ${YELLOW}Example:${NC}"
        echo -e "  ANTHROPIC_API_KEY=sk-ant-your-actual-key-here"
        echo -e "  OPENAI_API_KEY=sk-your-actual-openai-key-here"
    else
        echo -e "  ${GREEN}✓ $KEYS_CONFIGURED API key(s) configured${NC}"
    fi
else
    echo -e "  ${RED}✗ .env file not found${NC}"
    echo -e "  Create one at: $SEMANTIC_DIR/.env"
fi

echo
echo -e "${YELLOW}2. Agent System Status:${NC}"
AGENT_PIDS=$(pgrep -f "semantic-analysis-system/index.js" 2>/dev/null || true)
if [ -n "$AGENT_PIDS" ]; then
    echo -e "  ${GREEN}✓ Agent system is running${NC}"
    echo -e "  Process IDs: $AGENT_PIDS"
    
    # Check if MQTT broker is listening
    if lsof -i :1883 &>/dev/null; then
        echo -e "  ${GREEN}✓ MQTT broker is listening on port 1883${NC}"
    else
        echo -e "  ${YELLOW}⚠️  MQTT broker not detected on port 1883${NC}"
    fi
    
    # Check if RPC server is listening
    if lsof -i :8080 &>/dev/null; then
        echo -e "  ${GREEN}✓ RPC server is listening on port 8080${NC}"
    else
        echo -e "  ${YELLOW}⚠️  RPC server not detected on port 8080${NC}"
    fi
else
    echo -e "  ${RED}✗ Agent system is not running${NC}"
    echo
    echo -e "  ${YELLOW}To start the agent system:${NC}"
    echo -e "  cd $SEMANTIC_DIR"
    echo -e "  npm run start:agents"
    echo
    echo -e "  ${YELLOW}Or use the auto-start feature:${NC}"
    echo -e "  The 'coding' command will now auto-start agents if API keys are configured"
fi

echo
echo -e "${YELLOW}3. MCP Server Configuration:${NC}"
MCP_CONFIG="$PROJECT_DIR/claude-code-mcp-processed.json"
if [ -f "$MCP_CONFIG" ]; then
    echo -e "  ${GREEN}✓ MCP configuration found${NC}"
    
    # Check if semantic-analysis server is configured
    if grep -q "semantic-analysis-system" "$MCP_CONFIG" 2>/dev/null; then
        echo -e "  ${GREEN}✓ Semantic analysis MCP server is configured${NC}"
    else
        echo -e "  ${YELLOW}⚠️  Semantic analysis MCP server not in config${NC}"
    fi
else
    echo -e "  ${RED}✗ MCP configuration not found${NC}"
    echo -e "  Run: cd $PROJECT_DIR && ./install.sh"
fi

echo
echo -e "${YELLOW}4. Quick Start Guide:${NC}"
if [ $KEYS_CONFIGURED -eq 0 ]; then
    echo -e "  1. ${RED}Configure API keys first:${NC}"
    echo -e "     Edit: $SEMANTIC_DIR/.env"
    echo -e "     Add your ANTHROPIC_API_KEY and/or OPENAI_API_KEY"
    echo
fi

if [ -z "$AGENT_PIDS" ]; then
    echo -e "  2. ${YELLOW}Start the agent system:${NC}"
    echo -e "     cd $SEMANTIC_DIR"
    echo -e "     npm run start:agents"
    echo
    echo -e "  3. ${YELLOW}Then start Claude with MCP:${NC}"
    echo -e "     coding --claude"
    echo -e "     # or simply: claude-mcp"
else
    echo -e "  ${GREEN}✓ Agent system is running${NC}"
    echo -e "  ${GREEN}✓ Ready to use with: coding --claude${NC}"
fi

echo
echo -e "${BLUE}═══════════════════════════════════════════════════════════════${NC}"

# Exit with appropriate code
if [ $KEYS_CONFIGURED -eq 0 ] || [ -z "$AGENT_PIDS" ]; then
    exit 1
else
    exit 0
fi