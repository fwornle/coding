#!/bin/bash
# Knowledge Base Repair Tool
# Fixes duplicate relations and other corruption in shared-memory.json

set -euo pipefail

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CODING_ROOT="$(dirname "$SCRIPT_DIR")"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}üîß Knowledge Base Repair Tool${NC}"
echo -e "${BLUE}==============================${NC}"
echo

# Check if shared-memory.json exists
SHARED_MEMORY="$CODING_ROOT/shared-memory.json"
if [[ ! -f "$SHARED_MEMORY" ]]; then
    echo -e "${RED}‚ùå shared-memory.json not found at: $SHARED_MEMORY${NC}"
    exit 1
fi

# Show current stats
echo -e "${BLUE}üìä Current Database Stats:${NC}"
ENTITIES=$(jq '.entities | length' "$SHARED_MEMORY" 2>/dev/null || echo "0")
RELATIONS=$(jq '.relations | length' "$SHARED_MEMORY" 2>/dev/null || echo "0")
FILE_SIZE=$(du -h "$SHARED_MEMORY" | cut -f1)

echo -e "  Entities: $ENTITIES"
echo -e "  Relations: $RELATIONS"  
echo -e "  File size: $FILE_SIZE"
echo

# Check for duplicates
echo -e "${BLUE}üîç Checking for corruption...${NC}"
DUPLICATE_RELATIONS=$(jq '.relations | group_by(.from + "-" + .relationType + "-" + .to) | map(select(length > 1)) | map(length) | add // 0' "$SHARED_MEMORY" 2>/dev/null || echo "0")

if [[ "$DUPLICATE_RELATIONS" -gt 0 ]]; then
    echo -e "${RED}‚ö†Ô∏è  Found $DUPLICATE_RELATIONS duplicate relations!${NC}"
    echo
    
    # Ask for confirmation
    echo -e "${YELLOW}Do you want to clean up the database? [y/N]${NC}"
    read -r response
    
    if [[ "$response" =~ ^[Yy]$ ]]; then
        echo
        echo -e "${BLUE}üßπ Cleaning up database...${NC}"
        
        # Create backup
        BACKUP_FILE="$SHARED_MEMORY.backup.$(date +%Y%m%d_%H%M%S)"
        cp "$SHARED_MEMORY" "$BACKUP_FILE"
        echo -e "${GREEN}‚úì Backup created: $BACKUP_FILE${NC}"
        
        # Run cleanup
        if node "$CODING_ROOT/scripts/cleanup-shared-memory.js"; then
            echo
            echo -e "${GREEN}‚úÖ Database cleaned successfully!${NC}"
            
            # Show new stats
            NEW_ENTITIES=$(jq '.entities | length' "$SHARED_MEMORY" 2>/dev/null || echo "0")
            NEW_RELATIONS=$(jq '.relations | length' "$SHARED_MEMORY" 2>/dev/null || echo "0")
            NEW_FILE_SIZE=$(du -h "$SHARED_MEMORY" | cut -f1)
            
            echo -e "${GREEN}üìä New Database Stats:${NC}"
            echo -e "  Entities: $NEW_ENTITIES (was $ENTITIES)"
            echo -e "  Relations: $NEW_RELATIONS (was $RELATIONS)"
            echo -e "  File size: $NEW_FILE_SIZE (was $FILE_SIZE)"
            echo
            
            REMOVED_RELATIONS=$((RELATIONS - NEW_RELATIONS))
            if [[ "$REMOVED_RELATIONS" -gt 0 ]]; then
                echo -e "${GREEN}üóëÔ∏è  Removed $REMOVED_RELATIONS duplicate relations${NC}"
            fi
            
            echo
            echo -e "${BLUE}üí° Next steps:${NC}"
            echo -e "  ‚Ä¢ Restart any running services (coding --copilot)"
            echo -e "  ‚Ä¢ Test with: vkb start"
            echo -e "  ‚Ä¢ Monitor logs for reduced sync frequency"
            
        else
            echo -e "${RED}‚ùå Cleanup failed!${NC}"
            echo -e "${YELLOW}Restoring backup...${NC}"
            mv "$BACKUP_FILE" "$SHARED_MEMORY"
            exit 1
        fi
    else
        echo -e "${YELLOW}Cleanup cancelled.${NC}"
    fi
else
    echo -e "${GREEN}‚úÖ No corruption detected - database is healthy!${NC}"
fi

echo
echo -e "${BLUE}üîß Knowledge base repair complete${NC}"