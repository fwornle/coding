@startuml system-architecture
!theme aws-orange
!define RECTANGLE(x,y) rectangle x <<y>>

title Semantic Analysis System - Enhanced Architecture

package "Client Layer" {
  RECTANGLE(CLI, "CLI Interface")
  RECTANGLE(MCP_CLIENT, "MCP Client")
  RECTANGLE(HTTP_CLIENT, "HTTP Client")
  RECTANGLE(WEB_UI, "Web Dashboard")
}

package "API Layer" {
  RECTANGLE(MCP_SERVER, "MCP Server")
  RECTANGLE(REST_API, "REST API")
  RECTANGLE(GRAPHQL_API, "GraphQL API")
}

package "Agent Layer" {
  package "Core Agents" {
    RECTANGLE(SEMANTIC_AGENT, "Semantic Analysis\nAgent")
    RECTANGLE(KNOWLEDGE_AGENT, "Knowledge Graph\nAgent ✨")
    RECTANGLE(COORDINATOR_AGENT, "Coordinator\nAgent")
  }
  
  package "Infrastructure Agents ⭐ NEW" {
    RECTANGLE(SYNC_AGENT, "Synchronization\nAgent ✨")
    RECTANGLE(DEDUP_AGENT, "Deduplication\nAgent ✨")
    RECTANGLE(DOC_AGENT, "Documentation\nAgent")
  }
  
  package "Utility Agents" {
    RECTANGLE(SEARCH_AGENT, "Web Search\nAgent")
    RECTANGLE(QA_AGENT, "Quality Assurance\nAgent")
  }
}

package "Communication Layer" {
  RECTANGLE(MQTT_BROKER, "MQTT Broker\n(Event Bus)")
  RECTANGLE(RPC_SERVER, "JSON-RPC Server\n(Commands)")
  RECTANGLE(EVENT_BUS, "Event Processing")
}

package "Storage Layer" {
  package "Graph Databases" {
    RECTANGLE(MCP_MEMORY, "MCP Memory\nService")
    RECTANGLE(GRAPHOLOGY_DB, "Graphology\nDatabase")
  }
  
  package "File Storage" {
    RECTANGLE(JSON_CODING, "shared-memory-\ncoding.json")
    RECTANGLE(JSON_UI, "shared-memory-\nui.json")
    RECTANGLE(JSON_RESI, "shared-memory-\nresi.json")
  }
  
  package "Version Control" {
    RECTANGLE(VERSION_STORAGE, "Version\nStorage")
    RECTANGLE(BACKUP_STORAGE, "Backup\nStorage")
  }
}

package "External Services" {
  RECTANGLE(CLAUDE_API, "Claude API")
  RECTANGLE(OPENAI_API, "OpenAI API")
  RECTANGLE(GOOGLE_SEARCH, "Google Search")
  RECTANGLE(UKB_SYSTEM, "UKB System")
}

' Client connections
CLI --> REST_API
MCP_CLIENT --> MCP_SERVER
HTTP_CLIENT --> REST_API
WEB_UI --> GRAPHQL_API

' API to Agent connections
MCP_SERVER --> KNOWLEDGE_AGENT
REST_API --> COORDINATOR_AGENT
GRAPHQL_API --> COORDINATOR_AGENT

' Agent interconnections
COORDINATOR_AGENT --> EVENT_BUS
SEMANTIC_AGENT --> EVENT_BUS
KNOWLEDGE_AGENT --> EVENT_BUS
SYNC_AGENT --> EVENT_BUS
DEDUP_AGENT --> EVENT_BUS
DOC_AGENT --> EVENT_BUS
SEARCH_AGENT --> EVENT_BUS
QA_AGENT --> EVENT_BUS

' Communication layer
EVENT_BUS --> MQTT_BROKER
EVENT_BUS --> RPC_SERVER

' Storage connections
SYNC_AGENT --> MCP_MEMORY
SYNC_AGENT --> GRAPHOLOGY_DB
SYNC_AGENT --> JSON_CODING
SYNC_AGENT --> JSON_UI
SYNC_AGENT --> JSON_RESI
SYNC_AGENT --> VERSION_STORAGE

KNOWLEDGE_AGENT --> MCP_MEMORY
DEDUP_AGENT --> MCP_MEMORY

' External service connections
SEMANTIC_AGENT --> CLAUDE_API
SEMANTIC_AGENT --> OPENAI_API
DEDUP_AGENT --> OPENAI_API
SEARCH_AGENT --> GOOGLE_SEARCH
KNOWLEDGE_AGENT --> UKB_SYSTEM

' Backup and versioning
SYNC_AGENT --> BACKUP_STORAGE
VERSION_STORAGE --> BACKUP_STORAGE

note right of SYNC_AGENT
  **✨ Enhanced Synchronization Agent**
  • Bidirectional sync between graph DBs and JSON files
  • Real-time file watching with debouncing
  • Conflict resolution (latest-wins, merge, manual)
  • Version management with rollback capabilities
  • Multi-adapter support (MCP/Graphology)
  • Checksum validation prevents infinite loops
end note

note right of DEDUP_AGENT
  **✨ Semantic Deduplication Agent**
  • Embedding-based similarity detection
  • Multiple similarity metrics (cosine, euclidean, etc.)
  • Configurable merge strategies with thresholds
  • Batch processing with auto-merge capabilities
  • Entity grouping for visualization
  • Performance optimization with caching
end note

note right of KNOWLEDGE_AGENT
  **✨ Enhanced Knowledge Graph Agent**
  • Automatic relation creation to CollectiveKnowledge
  • Entity validation with comprehensive checks
  • Duplicate detection before creation
  • Type-based relations (Patterns, Documentation, Insights)
  • Technology-based relations from metadata
  • Team-specific knowledge organization
end note

@enduml