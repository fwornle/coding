{
  "id": "snapshot_1758963984451_h3mq2909j",
  "approvalId": "approval_1758963984443_quaow2qtl",
  "approvalTitle": "Embedding-Based Classifier Design Document",
  "version": 1,
  "timestamp": "2025-09-27T09:06:24.451Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nThe EmbeddingClassifier replaces the failed KeywordMatcher as Layer 2 in the existing ReliableCodingClassifier three-layer architecture. This enhancement leverages the proven mcp-constraint-monitor technology stack (Qdrant vector database + sentence-transformers embeddings) to provide semantic understanding for accurate classification of coding infrastructure content.\n\nThe design maintains the existing LayerAnalyzer → **EmbeddingClassifier** → SemanticAnalyzer flow while achieving the user's requested layered approach: \"path → sure pos keywords → fast embedding → fast semantic analysis\" by integrating a refined positive keyword pre-filter within the EmbeddingClassifier.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\n**Three-Layer Classification Architecture**: Maintains the established PathAnalyzer → EmbeddingClassifier → SemanticAnalyzer pattern with performance requirements:\n- Layer 1 (PathAnalyzer): <1ms response time, 100% accuracy for file operations\n- Layer 2 (EmbeddingClassifier): <3ms response time, semantic vector similarity classification  \n- Layer 3 (SemanticAnalyzer): <10ms response time, LLM-based deep understanding\n\n**Performance Standards**: Achieves <3ms embedding classification time contributing to <30ms total pipeline performance.\n\n**Configuration-Driven Architecture**: Leverages existing live-logging-config.json with new embedding-specific configuration section.\n\n**Node.js Technology Stack**: Uses JavaScript (Node.js 18+) with sentence-transformers integration via Python subprocess for embedding generation.\n\n### Project Structure (structure.md)\n\n**Core Source Code**: New EmbeddingClassifier implemented in `/src/live-logging/EmbeddingClassifier.js` following single responsibility principle.\n\n**Integration Reuse**: Leverages existing `/integrations/mcp-constraint-monitor/` Qdrant infrastructure without duplicating database setup.\n\n**Configuration Management**: Extends `/config/live-logging-config.json` with embedding-specific settings following hierarchical configuration pattern.\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **mcp-constraint-monitor Qdrant Setup**: Reuses existing Qdrant vector database configuration, connection management, and optimized settings (HNSW indexing, int8 quantization)\n- **ReliableCodingClassifier Framework**: Maintains existing initialization, statistics tracking, caching, and decision path logging infrastructure\n- **KeywordMatcher Interface**: EmbeddingClassifier implements identical interface (`matchKeywords()` method) for seamless drop-in replacement\n- **OperationalLogger**: Leverages existing comprehensive logging system for embedding operation tracking\n- **PerformanceMonitor**: Extends existing performance tracking with embedding-specific metrics\n\n### Integration Points\n\n- **Qdrant Database**: Connects to existing mcp-constraint-monitor Qdrant instance, creates new 'coding_infrastructure' collection alongside constraint collections\n- **Configuration System**: Extends existing live-logging-config.json with embedding configuration section\n- **Caching Infrastructure**: Integrates with existing prompt set caching system for embedding result caching\n- **Repository Indexing**: Leverages existing file system scanning patterns from PathAnalyzer for repository content discovery\n\n## Architecture\n\nThe EmbeddingClassifier follows a hybrid approach combining fast positive keyword pre-filtering with semantic vector similarity, addressing the user's specific layered requirements while maintaining performance standards.\n\n### Modular Design Principles\n\n- **Single File Responsibility**: EmbeddingClassifier.js handles only Layer 2 embedding-based classification\n- **Component Isolation**: RepositoryIndexer handles repository indexing, ChangeDetector monitors updates independently\n- **Service Layer Separation**: Embedding generation, vector storage, and similarity computation clearly separated\n- **Utility Modularity**: Reusable embedding utilities that can be leveraged by future semantic analysis systems\n\n```mermaid\ngraph TD\n    A[Exchange Input] --> B[PathAnalyzer Layer 1]\n    B -->|isCoding=false| C[EmbeddingClassifier Layer 2]\n    C --> D[Positive Keyword Pre-filter]\n    D -->|Keywords Match| E[CODING Classification]\n    D -->|No Keyword Match| F[Embedding Generation]\n    F --> G[Vector Similarity Search]\n    G -->|High Similarity| H[CODING Classification] \n    G -->|Low Similarity| I[SemanticAnalyzer Layer 3]\n    C -->|isCoding=true| E\n    B -->|isCoding=true| J[CODING Classification]\n    I --> K[Final Classification]\n```\n\n## Components and Interfaces\n\n### EmbeddingClassifier (Layer 2 Replacement)\n\n- **Purpose:** Replace KeywordMatcher with semantic vector similarity classification, including positive keyword optimization\n- **Interfaces:** \n  - `async matchKeywords(exchange)` - Compatible with existing KeywordMatcher interface\n  - `async initialize()` - Setup embedding generation and Qdrant connection\n  - `getStats()` - Performance and accuracy metrics\n- **Dependencies:** Qdrant client, sentence-transformers (via subprocess), RepositoryIndexer\n- **Reuses:** Existing performance monitoring, operational logging, caching infrastructure\n\n### RepositoryIndexer\n\n- **Purpose:** Index coding repository content into Qdrant 'coding_infrastructure' collection\n- **Interfaces:**\n  - `async indexRepository(repoPath, options)` - Full repository indexing\n  - `async updateIndex(changedFiles)` - Incremental updates\n  - `async isIndexCurrent()` - Freshness validation\n- **Dependencies:** Qdrant client, file system scanning utilities\n- **Reuses:** Existing file discovery patterns from PathAnalyzer, configuration management\n\n### ChangeDetector\n\n- **Purpose:** Monitor repository changes and trigger reindexing when significant changes occur\n- **Interfaces:**\n  - `async detectSignificantChanges()` - Heuristic-based change detection\n  - `startMonitoring()` - Begin continuous monitoring\n  - `stopMonitoring()` - Cleanup monitoring resources\n- **Dependencies:** File system watchers, repository content analysis\n- **Reuses:** Existing configuration system, logging infrastructure\n\n### EmbeddingGenerator\n\n- **Purpose:** Generate semantic embeddings using sentence-transformers\n- **Interfaces:**\n  - `async generateEmbedding(text)` - Single text embedding\n  - `async generateBatchEmbeddings(texts)` - Batch processing for efficiency\n  - `validateEmbedding(embedding)` - Quality validation\n- **Dependencies:** sentence-transformers Python subprocess\n- **Reuses:** Existing subprocess management patterns, performance monitoring\n\n## Data Models\n\n### Enhanced Configuration Schema\n\n```javascript\n{\n  // Existing live-logging-config.json structure\n  \"embedding_classifier\": {\n    \"enabled\": true,\n    \"model\": \"sentence-transformers/all-MiniLM-L6-v2\",\n    \"vector_dimensions\": 384,\n    \"similarity_threshold\": 0.7,\n    \"positive_keywords\": {\n      \"enabled\": true,\n      \"config_path\": \"./scripts/coding-keywords.json\",\n      \"primary_weight\": 4,\n      \"minimum_score\": 1\n    },\n    \"qdrant\": {\n      \"collection_name\": \"coding_infrastructure\",\n      \"distance_metric\": \"Cosine\",\n      \"index_config\": {\n        \"hnsw\": { \"m\": 16, \"ef_construct\": 100 },\n        \"quantization\": { \"type\": \"int8\" }\n      }\n    },\n    \"repository_indexing\": {\n      \"auto_index_on_startup\": true,\n      \"include_patterns\": [\"*.md\", \"*.js\", \"README*\", \"CLAUDE.md\"],\n      \"exclude_patterns\": [\"node_modules/**\", \".git/**\", \"*.log\"],\n      \"max_file_size_mb\": 1,\n      \"index_update_interval_minutes\": 30\n    },\n    \"performance\": {\n      \"max_embedding_time_ms\": 2000,\n      \"max_similarity_search_ms\": 1000,\n      \"cache_embeddings\": true,\n      \"cache_ttl_minutes\": 60\n    }\n  }\n}\n```\n\n### Vector Document Schema\n\n```javascript\n{\n  \"id\": \"uuid-v4\",\n  \"vector\": [/* 384-dimensional float array */],\n  \"payload\": {\n    \"file_path\": \"relative/path/to/file.md\",\n    \"content_type\": \"documentation | source_code | readme | changelog\",\n    \"content_hash\": \"sha256-hash-of-content\",\n    \"title\": \"extracted-title-or-filename\",\n    \"excerpt\": \"first-200-chars-of-content\",\n    \"indexed_at\": \"ISO-8601-timestamp\",\n    \"repository\": \"coding_infrastructure\"\n  }\n}\n```\n\n### Classification Result Schema (Compatible with KeywordMatcher)\n\n```javascript\n{\n  \"isCoding\": boolean,\n  \"confidence\": number, // 0.0 to 1.0\n  \"reason\": string,\n  \"layer\": \"keyword\" | \"embedding\", // Maintains existing layer tracking\n  \"similarity_scores\": {\n    \"max_similarity\": number,\n    \"avg_similarity\": number,\n    \"matching_documents\": number\n  },\n  \"positive_keywords\": {\n    \"matched\": boolean,\n    \"score\": number,\n    \"matched_terms\": string[]\n  },\n  \"processing_time_ms\": number\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Qdrant Connection Failure**\n   - **Handling:** Gracefully fall back to positive keyword matching only, log error, attempt reconnection with exponential backoff\n   - **User Impact:** Classification continues with reduced accuracy, no interruption to session logging\n\n2. **Embedding Generation Timeout**\n   - **Handling:** Return cached embedding if available, otherwise fall back to keyword matching, track timeout metrics\n   - **User Impact:** Slightly reduced classification accuracy for that specific exchange\n\n3. **Repository Index Corruption**\n   - **Handling:** Detect corruption via metadata validation, trigger automatic reindexing, use fallback classification during rebuild\n   - **User Impact:** Temporary classification degradation until index rebuilds (estimated 2-5 minutes)\n\n4. **Memory Pressure from Large Repository**\n   - **Handling:** Implement pagination in repository indexing, use streaming processing, monitor memory usage with alerts\n   - **User Impact:** Indexing takes longer but system remains stable\n\n## Testing Strategy\n\n### Unit Testing\n\n- **EmbeddingClassifier Interface Compatibility**: Verify `matchKeywords()` maintains exact same interface as existing KeywordMatcher\n- **Positive Keyword Pre-filter**: Test keyword matching logic against refined coding-keywords.json configuration\n- **Vector Similarity Computation**: Test cosine similarity calculations with known embedding pairs\n- **Error Handling**: Test all fallback scenarios with mocked failures\n\n### Integration Testing\n\n- **End-to-End Classification Pipeline**: Test full PathAnalyzer → EmbeddingClassifier → SemanticAnalyzer flow with real content\n- **Qdrant Integration**: Test repository indexing, similarity search, and index updates against real Qdrant instance\n- **Performance Requirements**: Validate <3ms embedding classification time and <30ms total pipeline time\n- **Cache Integration**: Test embedding result caching with existing prompt set optimization system\n\n### End-to-End Testing\n\n- **Repository Indexing Scenarios**: Test indexing of actual coding repository content with various file types and sizes\n- **Classification Accuracy**: Compare embedding-based results against manually classified coding infrastructure content\n- **Change Detection**: Test automatic reindexing triggered by documentation updates, feature additions, and structural changes\n- **Resource Usage**: Monitor memory and CPU usage during sustained classification workloads\n\n### Performance Benchmarking\n\n- **Latency Testing**: Measure and optimize to achieve consistent <3ms embedding classification time\n- **Throughput Testing**: Validate system handles high-volume classification during active development sessions\n- **Resource Monitoring**: Ensure <500MB memory usage target is maintained even with large repository indexes\n- **Cache Effectiveness**: Measure embedding cache hit rates and impact on overall system performance",
  "fileStats": {
    "size": 11697,
    "lines": 248,
    "lastModified": "2025-09-27T09:05:20.218Z"
  },
  "comments": []
}