{
  "id": "snapshot_1759143741660_rf0c1q60s",
  "approvalId": "approval_1759143741646_f6hfkg3w1",
  "approvalTitle": "Real-Time Trajectory System Requirements",
  "version": 1,
  "timestamp": "2025-09-29T11:02:21.660Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Real-Time Trajectory System Requirements Specification\n\n## Product: Live Trajectory Monitoring and Intervention System\n**Version:** 1.0.0  \n**Date:** 2025-09-29  \n**Status:** Draft\n\n---\n\n## 1. Executive Summary\n\n### 1.1 Purpose\nReplace the existing semantic trajectory analysis system with a real-time behavioral monitoring and intervention system that provides live trajectory tracking, multi-project coordination, and proactive guidance within the existing coding infrastructure.\n\n### 1.2 Vision  \nTransform the current 6-hourly semantic trajectory analysis into a live system that provides real-time trajectory awareness, intervention capabilities, and seamless multi-project collaboration while leveraging existing LSL and watchdog infrastructure.\n\n### 1.3 Key Outcomes\n- **Live trajectory tracking** replacing batch semantic analysis\n- **Real-time intervention** capabilities with <10ms latency\n- **Multi-project coordination** via existing LSL infrastructure\n- **Zero new development** - enhancement of existing trajectory system\n- **Rock-solid monitoring** integrated with existing 4-layer watchdog architecture\n\n---\n\n## 2. Problem Statement\n\n### 2.1 Current State Limitations\n- **Batch Trajectory Analysis**: Current system runs semantic analysis every 6 hours, missing real-time patterns\n- **No Live Intervention**: Existing constraint monitor operates post-facto without preventing violations\n- **Missing Real-Time Context**: No live conversation state tracking during active sessions\n- **Delayed Trajectory Awareness**: Workflow phases and behavioral patterns only visible in retrospective analysis\n\n### 2.2 User Pain Points\n- Claude Code can deviate from optimal trajectory without real-time correction\n- No live guidance to maintain productive workflow phases\n- Trajectory insights only available after session completion\n- Multi-project work lacks coordinated trajectory monitoring\n\n### 2.3 Business Impact\n- Lost productivity from suboptimal trajectory patterns\n- Delayed detection of workflow inefficiencies\n- Missed opportunities for real-time behavioral guidance\n- Insufficient cross-project learning and coordination\n\n---\n\n## 3. Functional Requirements\n\n### 3.1 Live Trajectory Monitoring (Enhancement of Existing System)\n**Priority:** P0 - Critical\n\n#### Requirements:\n- **FR-001**: Extend existing Enhanced Transcript Monitor with real-time trajectory analysis\n- **FR-002**: Replace 6-hourly semantic analysis with continuous trajectory tracking\n- **FR-003**: Leverage existing LSL file watching infrastructure (<100ms latency)\n- **FR-004**: Maintain trajectory context across sessions using existing session continuity detection\n- **FR-005**: Persist trajectory state in existing `.specstory/trajectory/` structure\n\n#### Acceptance Criteria:\n- Trajectory changes detected within 100ms using existing file monitoring\n- All message types correctly analyzed for trajectory phase transitions\n- Context preserved using existing session continuation detection\n- Zero disruption to existing LSL functionality\n\n### 3.2 Configurable Fast Inference Engine\n**Priority:** P0 - Critical\n\n#### Requirements:\n- **FR-006**: Configure inference provider via `.env` (default: Groq with gpt-oss:20b model)\n- **FR-007**: Implement trajectory phase analysis prompts replacing existing semantic analysis\n- **FR-008**: Classify trajectory states: exploring ‚Üí implementing ‚Üí verifying ‚Üí blocked ‚Üí off-track\n- **FR-009**: Generate action summaries and trajectory insights (<50ms response time)\n- **FR-010**: Support configurable trajectory analysis patterns\n\n#### Acceptance Criteria:\n- Groq API (default) or configured provider response time <50ms\n- Trajectory classification accuracy >85% compared to existing system\n- Seamless provider switching via environment configuration\n- Clear trajectory reasoning and action summaries generated\n\n### 3.3 Real-Time Intervention System\n**Priority:** P0 - Critical\n\n#### Requirements:\n- **FR-011**: Integrate with existing Claude Code hook system for trajectory intervention\n- **FR-012**: Implement trajectory-based action guidance (<10ms response time)\n- **FR-013**: Generate contextual redirection prompts when trajectory deviates\n- **FR-014**: Support intervention thresholds configurable per trajectory state\n- **FR-015**: Log intervention events in existing `.specstory/` logging structure\n\n#### Acceptance Criteria:\n- Hooks successfully provide trajectory-based guidance\n- Intervention response time consistently <10ms\n- Guidance prompts contextually relevant to current trajectory phase\n- Existing hook infrastructure remains unaffected\n\n### 3.4 Multi-Project Trajectory Coordination\n**Priority:** P0 - Critical\n\n#### Requirements:\n- **FR-016**: Extend existing LSL multi-project architecture for trajectory coordination\n- **FR-017**: Coordinate trajectory state across multiple concurrent coding sessions\n- **FR-018**: Support cross-project trajectory learning and pattern sharing\n- **FR-019**: Maintain project-specific trajectory histories with cross-referencing\n- **FR-020**: Integrate with existing project-specific Enhanced Transcript Monitors\n\n#### Acceptance Criteria:\n- Trajectory coordination works seamlessly across existing multi-project setup\n- Each project maintains independent trajectory state while sharing insights\n- Cross-project patterns identified and utilized for trajectory optimization\n- Zero interference between concurrent project trajectories\n\n### 3.5 Enhanced Status Line Integration\n**Priority:** P1 - High\n\n#### Requirements:\n- **FR-021**: Integrate real-time trajectory indicators with existing status line system\n- **FR-022**: Display trajectory state icons (üîçEX, üìàON, üìâOFF, ‚öôÔ∏èIMP, ‚úÖVER, üö´BLK)\n- **FR-023**: Show trajectory phase transitions in existing status line format\n- **FR-024**: Provide trajectory health metrics via existing health monitoring\n- **FR-025**: Support trajectory status aggregation across multiple projects\n\n#### Acceptance Criteria:\n- Status indicators update within 500ms using existing infrastructure\n- Trajectory states clearly represented in familiar status line format\n- Health metrics integrate with existing 4-layer monitoring architecture\n- Multi-project trajectory status available in coordinated view\n\n### 3.6 LSL Redaction System Enhancement\n**Priority:** P0 - Critical\n\n#### Requirements:\n- **FR-026**: Extend existing LSL redaction system to include GROQ_API_KEY\n- **FR-027**: Ensure GROQ_API_KEY is redacted alongside existing XAI_API_KEY, ANTHROPIC_API_KEY\n- **FR-028**: Update LSL redaction patterns to handle Groq provider API keys\n- **FR-029**: Maintain existing redaction effectiveness while adding Groq support\n- **FR-030**: Document distinction between GROQ_API_KEY (Groq provider) and XAI_API_KEY (xAI's Grok)\n\n#### Acceptance Criteria:\n- GROQ_API_KEY properly redacted in all LSL session logs and outputs\n- Existing API key redaction (XAI_API_KEY, ANTHROPIC_API_KEY) remains functional\n- No Groq API keys leak through any LSL logging or monitoring systems\n- Redaction patterns correctly distinguish between different provider keys\n\n---\n\n## 4. Non-Functional Requirements\n\n### 4.1 Performance Requirements\n- **NFR-001**: End-to-end intervention latency <10ms\n- **NFR-002**: Vector search response time <3ms\n- **NFR-003**: LLM analysis completion <50ms\n- **NFR-004**: Dashboard rendering <1s\n- **NFR-005**: Support 100+ concurrent sessions\n\n### 4.2 Reliability Requirements\n- **NFR-006**: 99.9% uptime for core intervention system\n- **NFR-007**: Zero data loss for violation logs\n- **NFR-008**: Automatic recovery from service failures\n- **NFR-009**: Graceful degradation under high load\n\n### 4.3 Security Requirements\n- **NFR-010**: Encrypted storage for conversation context\n- **NFR-011**: Secure API key management for Groq\n- **NFR-012**: Audit logging for all interventions\n- **NFR-013**: Role-based access control for configuration\n\n### 4.4 Scalability Requirements\n- **NFR-014**: Horizontal scaling for analysis workers\n- **NFR-015**: Efficient context pruning for long sessions\n- **NFR-016**: Configurable retention policies\n- **NFR-017**: Support for distributed deployments\n\n---\n\n## 5. Technical Architecture\n\n### 5.1 Enhanced Existing Components\n\n#### 5.1.1 Enhanced Transcript Monitor Extensions\n- Extend existing `scripts/enhanced-transcript-monitor.js` with trajectory analysis\n- Leverage existing file watching infrastructure (FSWatcher)\n- Add trajectory state tracking to existing message parsing pipeline\n- Integrate with existing session continuity detection\n\n#### 5.1.2 Configurable Fast Inference Engine\n- Environment-configurable provider (default: Groq gpt-oss:20b)\n- Replace existing semantic analysis scheduling with real-time analysis\n- Extend existing MCP semantic analysis integration\n- Action summary generation replacing batch trajectory reports\n\n#### 5.1.3 Existing Hook System Integration\n- Utilize existing Claude Code hook infrastructure\n- Extend existing hook registration for trajectory intervention\n- Integrate with existing constraint monitor for trajectory-based guidance\n- Leverage existing correction prompt mechanisms\n\n#### 5.1.4 LSL Multi-Project Architecture Extension\n- Extend existing project-specific Enhanced Transcript Monitors\n- Leverage existing Global Health Monitoring for trajectory coordination\n- Utilize existing cross-project communication channels\n- Integrate with existing 4-layer protection architecture\n\n### 5.2 Data Architecture (Extending Existing)\n\n#### 5.2.1 Existing File Structure Extensions\n```bash\n# Extend existing .specstory structure\n.specstory/\n‚îú‚îÄ‚îÄ history/                    # Existing LSL session files\n‚îú‚îÄ‚îÄ trajectory/                 # Enhanced trajectory tracking\n‚îÇ   ‚îú‚îÄ‚îÄ live-state.json        # Real-time trajectory state\n‚îÇ   ‚îú‚îÄ‚îÄ session-transitions.log # Trajectory phase changes\n‚îÇ   ‚îî‚îÄ‚îÄ cross-project-insights.json # Multi-project patterns\n‚îî‚îÄ‚îÄ comprehensive-project-trajectory.md # Enhanced real-time report\n```\n\n#### 5.2.1 Environment Configuration Extensions\n```bash\n# Extend existing environment configuration\n# Fast inference engine configuration\nTRAJECTORY_INFERENCE_PROVIDER=groq              # Default: groq\nTRAJECTORY_INFERENCE_MODEL=gpt-oss:20b          # Default model\nTRAJECTORY_INFERENCE_ENDPOINT=                  # Optional custom endpoint\nTRAJECTORY_INFERENCE_API_KEY=                   # Provider API key\n\n# Real-time trajectory settings\nTRAJECTORY_ANALYSIS_INTERVAL=100                # Real-time analysis interval (ms)\nTRAJECTORY_INTERVENTION_THRESHOLD=0.8           # Intervention confidence threshold\nTRAJECTORY_CROSS_PROJECT_SYNC=true              # Enable multi-project coordination\n\n# Integration with existing LSL settings\nTRANSCRIPT_SOURCE_PROJECT=                       # Existing project path\nCODING_TOOLS_PATH=                              # Existing tools path  \nTRAJECTORY_WATCHDOG_INTEGRATION=true            # Integrate with existing watchdog\n\n# LSL redaction enhancement (CRITICAL for security)\nLSL_REDACTION_KEYS=\"XAI_API_KEY,GROQ_API_KEY,ANTHROPIC_API_KEY\"  # Extended API key redaction\n```\n\n### 5.3 Integration Points (Leveraging Existing)\n\n#### 5.3.1 Existing Infrastructure Enhancement\n- **Enhanced Transcript Monitors**: Add trajectory analysis capabilities\n- **Global Health Monitoring**: Extend with trajectory health metrics\n- **System Monitor Watchdog**: Include trajectory system monitoring\n- **Status Line System**: Add real-time trajectory indicators\n- **Existing MCP Services**: Leverage semantic analysis, constraint monitoring\n\n#### 5.3.2 External Service Configuration\n- **Groq API**: Default fast inference provider (configurable)\n- **Existing Claude Code Hooks**: Trajectory intervention integration\n- **Existing Health Files**: Trajectory state persistence\n- **Existing LaunchAgent**: Watchdog integration for trajectory monitoring\n\n---\n\n## 6. Implementation Phases\n\n### Phase 1: Enhanced Transcript Monitor Extension (Week 1)\n- [ ] Extend existing Enhanced Transcript Monitor with trajectory analysis capabilities\n- [ ] Configure fast inference engine (Groq default, environment configurable)\n- [ ] Integrate trajectory state tracking with existing message parsing\n- [ ] Test real-time trajectory analysis with existing file watching\n\n### Phase 2: Multi-Project Coordination (Week 2)\n- [ ] Extend existing LSL multi-project architecture for trajectory coordination\n- [ ] Implement cross-project trajectory state synchronization\n- [ ] Integrate with existing Global Health Monitoring for trajectory metrics\n- [ ] Test trajectory coordination across multiple concurrent sessions\n\n### Phase 3: Real-Time Intervention Integration (Week 3)\n- [ ] Integrate trajectory analysis with existing Claude Code hook system\n- [ ] Implement trajectory-based intervention prompts\n- [ ] Add trajectory health monitoring to existing 4-layer watchdog system\n- [ ] Test intervention system with existing constraint monitoring\n\n### Phase 4: Status Line and Monitoring Enhancement (Week 4)\n- [ ] Integrate real-time trajectory indicators with existing status line system\n- [ ] Extend existing health monitoring with trajectory metrics\n- [ ] Implement trajectory state persistence in existing `.specstory/` structure\n- [ ] Remove/deprecate existing 6-hourly semantic analysis system\n\n---\n\n## 7. Success Metrics\n\n### 7.1 Performance Metrics\n- Intervention latency: <10ms (P95)\n- Detection accuracy: >85%\n- False positive rate: <10%\n- System availability: >99.9%\n\n### 7.2 User Metrics\n- Violation prevention rate: >90%\n- User satisfaction score: >4.5/5\n- Trajectory adherence: >80%\n- Configuration adoption: >75%\n\n### 7.3 Business Metrics\n- Reduced cleanup time: -50%\n- Increased developer productivity: +30%\n- Decreased critical violations: -80%\n- Improved code quality: +25%\n\n---\n\n## 8. Risks and Mitigations\n\n### 8.1 Technical Risks\n\n| Risk | Probability | Impact | Mitigation |\n|------|------------|--------|------------|\n| Groq API latency spikes | Medium | High | Implement fallback to local LLM |\n| Hook integration complexity | High | Medium | Phased rollout with feature flags |\n| Context storage growth | Medium | Medium | Implement sliding window pruning |\n| False positive disruptions | Low | High | Configurable sensitivity levels |\n\n### 8.2 Operational Risks\n\n| Risk | Probability | Impact | Mitigation |\n|------|------------|--------|------------|\n| User resistance to interventions | Medium | Medium | Gradual introduction with education |\n| Configuration complexity | Medium | Low | Provide preset profiles |\n| Performance degradation | Low | High | Load testing and monitoring |\n| Data privacy concerns | Low | Medium | Clear data handling policies |\n\n---\n\n## 9. Dependencies\n\n### 9.1 External Dependencies\n- Configurable fast inference provider (default: Groq API) availability and performance\n- Claude Code hook system stability and intervention capabilities\n- Existing LSL file watching and monitoring infrastructure\n\n### 9.2 Internal Dependencies\n- Enhanced Transcript Monitor system (`scripts/enhanced-transcript-monitor.js`)\n- Existing LSL multi-project architecture and Global Health Monitoring\n- System Monitor Watchdog (`scripts/system-monitor-watchdog.js`) integration\n- Existing status line system and 4-layer protection architecture\n- Current constraint monitor and MCP semantic analysis services\n\n---\n\n## 10. Open Questions\n\n1. **Fast Inference Rate Limits**: What are the rate limits for Groq (default) and alternative providers?\n2. **Existing Hook Intervention Scope**: Can current Claude Code hooks handle trajectory-based interventions?\n3. **Trajectory Context Window**: What's the optimal trajectory context size for real-time analysis?\n4. **Cross-Project State Sync**: How to handle trajectory state conflicts across multiple project sessions?\n5. **Backward Compatibility**: How to ensure existing trajectory reports remain functional during transition?\n6. **Watchdog Integration Depth**: What level of trajectory monitoring should be integrated with existing 4-layer watchdog?\n\n---\n\n## 11. Appendices\n\n### Appendix A: Live Trajectory State Definitions (Replacing Batch Analysis)\n\n| State | Icon | Description | Transition Triggers | Integration Point |\n|-------|------|-------------|-------------------|------------------|\n| Exploring | üîçEX | Information gathering phase | Read/search tool usage | Enhanced Transcript Monitor detection |\n| On-Track | üìàON | Productive trajectory progression | Successful task advancement | Existing status line indicators |\n| Off-Track | üìâOFF | Deviating from optimal path | Excessive exploration, wrong direction | Hook-based intervention triggers |\n| Implementing | ‚öôÔ∏èIMP | Active code modification | Edit/Write tool usage patterns | Existing file change monitoring |\n| Verifying | ‚úÖVER | Testing and validation phase | Test execution, validation tools | Existing health monitoring integration |\n| Blocked | üö´BLK | Intervention preventing action | High-confidence trajectory deviation | Existing constraint monitor integration |\n\n### Appendix B: Enhanced Environment Configuration\n\n```bash\n# Replace existing trajectory configuration\n# Fast inference engine settings (NEW)\nTRAJECTORY_INFERENCE_PROVIDER=groq                    # Default: groq\nTRAJECTORY_INFERENCE_MODEL=gpt-oss:20b                # Default model  \nTRAJECTORY_INFERENCE_API_KEY=${GROQ_API_KEY}          # Provider API key\nTRAJECTORY_ANALYSIS_INTERVAL=100                      # Real-time interval (ms)\n\n# Integration with existing LSL settings (ENHANCED)\nTRAJECTORY_LSL_INTEGRATION=true                       # Enable LSL integration\nTRAJECTORY_MULTI_PROJECT=true                         # Multi-project coordination\nTRAJECTORY_WATCHDOG_LEVEL=full                        # Watchdog integration depth\n\n# Deprecate existing batch analysis settings\n# TRAJECTORY_ANALYSIS_LEVEL=light                     # REMOVE - replaced by real-time\n# TRAJECTORY_UPDATE_INTERVAL=86400000                 # REMOVE - replaced by continuous\n```\n\n### Appendix C: Performance Benchmarks (Leveraging Existing Infrastructure)\n\n| Operation | Target | Acceptable | Maximum | Integration Point |\n|-----------|--------|------------|---------|------------------|\n| Trajectory Analysis | 50ms | 100ms | 200ms | Fast inference engine (Groq default) |\n| Hook Intervention | 5ms | 10ms | 20ms | Existing Claude Code hooks |\n| Context Update | 50ms | 100ms | 200ms | Enhanced Transcript Monitor |\n| Status Line Update | 100ms | 500ms | 1000ms | Existing status line system |\n| Cross-Project Sync | 200ms | 500ms | 1000ms | Existing LSL multi-project architecture |\n| Watchdog Integration | 1s | 2s | 5s | Existing 4-layer monitoring system |\n\n### Appendix D: Migration from Existing System\n\n#### Deprecation Plan\n- **Existing 6-hourly semantic analysis**: Replace with real-time trajectory monitoring\n- **Batch trajectory reports**: Enhance with live trajectory state updates  \n- **Manual trajectory generation**: Supplement with continuous tracking\n- **Static trajectory insights**: Replace with dynamic intervention capabilities\n\n#### Backward Compatibility\n- Maintain existing `.specstory/comprehensive-project-trajectory.md` format\n- Preserve existing trajectory report structure with enhanced real-time data\n- Keep existing LSL session file formats and naming conventions\n- Maintain existing multi-project coordination mechanisms\n\n---\n\n## Document Control\n\n**Author:** Claude Code Assistant  \n**Reviewers:** [To be added]  \n**Approval:** [Pending]  \n**Next Review:** [30 days from approval]\n\n**Integration Notes:**\n- This specification enhances existing trajectory and LSL systems rather than creating new infrastructure\n- All proposed changes leverage existing monitoring, analysis, and intervention capabilities\n- Implementation focuses on real-time enhancement of proven batch analysis system\n- Multi-project coordination builds on existing LSL multi-project architecture",
  "fileStats": {
    "size": 19901,
    "lines": 430,
    "lastModified": "2025-09-29T10:18:09.190Z"
  },
  "comments": []
}