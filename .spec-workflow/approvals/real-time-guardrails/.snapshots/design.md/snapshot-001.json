{
  "id": "snapshot_1759145059048_hbh17n92d",
  "approvalId": "approval_1759145059041_wnh9vsnd9",
  "approvalTitle": "Real-Time Trajectory System Design Document",
  "version": 1,
  "timestamp": "2025-09-29T11:24:19.048Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: Real-Time Trajectory System\n\n## Overview\n\nEnhancement of the existing trajectory analysis system to provide real-time monitoring, intervention capabilities, and multi-project coordination while leveraging all existing LSL, watchdog, and monitoring infrastructure.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n- Follows existing TypeScript patterns and MCP integration approaches\n- Leverages existing environment configuration and monitoring patterns\n- Maintains existing file watching and session management architectures\n\n### Project Structure (structure.md)\n- Extends existing `.specstory/` structure for trajectory state persistence\n- Integrates with existing `scripts/` directory for Enhanced Transcript Monitor extensions\n- Utilizes existing health monitoring and watchdog infrastructure\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n- **Enhanced Transcript Monitor**: Extend with real-time trajectory analysis capabilities\n- **LSL Multi-Project Architecture**: Leverage for cross-project trajectory coordination\n- **System Monitor Watchdog**: Integrate trajectory health monitoring\n- **MCP Semantic Analysis**: Replace batch processing with real-time inference\n- **Existing Status Line System**: Add trajectory state indicators\n\n### Integration Points\n- **Claude Code Hook System**: Integrate trajectory-based intervention\n- **Existing Health Monitoring**: Extend 4-layer protection with trajectory metrics\n- **Current Constraint Monitor**: Coordinate with trajectory-based guidance\n- **LSL Session Files**: Enhance with real-time trajectory state tracking\n\n## Architecture\n\nThe design extends existing components rather than creating new infrastructure:\n\n```mermaid\ngraph TD\n    A[Enhanced Transcript Monitor] -->|Extended| B[Real-Time Trajectory Analysis]\n    B --> C[Fast Inference Engine]\n    C -->|Configurable| D[Groq/Alternative Provider]\n    \n    E[LSL Multi-Project] -->|Extended| F[Cross-Project Trajectory Sync]\n    F --> G[Global Trajectory Coordination]\n    \n    H[System Watchdog] -->|Enhanced| I[Trajectory Health Monitoring]\n    I --> J[4-Layer Protection + Trajectory]\n    \n    K[Claude Code Hooks] -->|Integrated| L[Trajectory Intervention]\n    L --> M[Real-Time Guidance]\n    \n    B --> N[Status Line Integration]\n    F --> N\n    I --> N\n```\n\n## Components and Interfaces\n\n### Enhanced Transcript Monitor Extension\n- **Purpose:** Add real-time trajectory analysis to existing file monitoring\n- **Interfaces:** Extend existing message parsing with trajectory state detection\n- **Dependencies:** Existing FSWatcher, session continuity detection\n- **Reuses:** Current message parsing, file watching, session management\n\n### Configurable Fast Inference Engine\n- **Purpose:** Replace 6-hourly semantic analysis with real-time inference\n- **Interfaces:** Environment-configurable provider (default: Groq gpt-oss:20b)\n- **Dependencies:** Provider API keys, existing MCP infrastructure\n- **Reuses:** Existing MCP semantic analysis patterns, configuration management\n\n### Multi-Project Trajectory Coordinator\n- **Purpose:** Extend LSL multi-project architecture for trajectory synchronization\n- **Interfaces:** Cross-project trajectory state sharing and conflict resolution\n- **Dependencies:** Existing Global Health Monitoring, project registration\n- **Reuses:** Current multi-project communication channels, health file formats\n\n### Trajectory Intervention System\n- **Purpose:** Integrate with existing Claude Code hooks for trajectory guidance\n- **Interfaces:** Real-time intervention prompts and trajectory redirection\n- **Dependencies:** Existing hook infrastructure, constraint monitor\n- **Reuses:** Current hook registration, intervention mechanisms\n\n## Implementation Strategy\n\n### Phase 1: Core Extension (Week 1)\n1. Extend `scripts/enhanced-transcript-monitor.js` with trajectory analysis\n2. Configure fast inference engine with environment variables\n3. Test real-time trajectory detection with existing file watching\n\n### Phase 2: Multi-Project Integration (Week 2)\n1. Extend existing LSL multi-project architecture\n2. Implement cross-project trajectory state synchronization\n3. Integrate with existing Global Health Monitoring\n\n### Phase 3: Intervention and Monitoring (Week 3)\n1. Integrate trajectory analysis with existing Claude Code hooks\n2. Extend existing 4-layer watchdog system with trajectory monitoring\n3. Test intervention system with existing constraint monitoring\n\n### Phase 4: Status Line and Deprecation (Week 4)\n1. Integrate trajectory indicators with existing status line system\n2. Enhance existing health monitoring with trajectory metrics\n3. Deprecate existing 6-hourly semantic analysis system\n\n## Data Flow\n\n### Real-Time Trajectory Analysis Flow\n```mermaid\nsequenceDiagram\n    participant ETM as Enhanced Transcript Monitor\n    participant FIE as Fast Inference Engine\n    participant TH as Trajectory Handler\n    participant SL as Status Line\n    participant MP as Multi-Project Coordinator\n    \n    ETM->>ETM: File change detected (existing)\n    ETM->>TH: Parse message for trajectory analysis (new)\n    TH->>FIE: Analyze trajectory state (new)\n    FIE->>TH: Return trajectory classification (new)\n    TH->>SL: Update status indicators (enhanced)\n    TH->>MP: Sync trajectory state (enhanced)\n    TH->>ETM: Log trajectory transition (enhanced)\n```\n\n### Environment Configuration\n\n```bash\n# New trajectory-specific settings\nTRAJECTORY_INFERENCE_PROVIDER=groq                    # Default: groq\nTRAJECTORY_INFERENCE_MODEL=gpt-oss:20b                # Default model\nTRAJECTORY_INFERENCE_API_KEY=${GROQ_API_KEY}          # Provider API key\nTRAJECTORY_ANALYSIS_INTERVAL=100                      # Real-time interval (ms)\n\n# Enhanced LSL integration\nTRAJECTORY_LSL_INTEGRATION=true                       # Enable LSL integration\nTRAJECTORY_MULTI_PROJECT=true                         # Multi-project coordination\nTRAJECTORY_WATCHDOG_LEVEL=full                        # Watchdog integration depth\n\n# LSL redaction enhancement (NEW REQUIREMENT)\nLSL_REDACTION_KEYS=\"XAI_API_KEY,GROQ_API_KEY,ANTHROPIC_API_KEY,OPENAI_API_KEY,CLAUDE_API_KEY,GEMINI_API_KEY\"  # Comprehensive redaction\n```\n\n## File Structure Extensions\n\n```bash\n# Extend existing .specstory structure\n.specstory/\n├── history/                           # Existing LSL session files\n├── trajectory/                        # Enhanced trajectory tracking (new)\n│   ├── live-state.json               # Real-time trajectory state\n│   ├── session-transitions.log       # Trajectory phase changes\n│   └── cross-project-insights.json   # Multi-project patterns\n└── comprehensive-project-trajectory.md # Enhanced with real-time data\n```\n\n## Integration with LSL Redaction System\n\n### Enhanced Redaction Requirements\nThe LSL redaction system must be extended to handle the new GROQ_API_KEY in addition to existing keys:\n\n- **Current**: Redacts XAI_API_KEY, ANTHROPIC_API_KEY  \n- **Enhanced**: Add comprehensive API key redaction list\n- **Implementation**: Update LSL redaction patterns to include all major AI provider API keys\n- **Note**: GROQ_API_KEY ≠ XAI_API_KEY (different providers: Groq vs xAI's Grok)\n\n## Performance Characteristics\n\n| Operation | Target | Integration Point |\n|-----------|--------|------------------|\n| Trajectory Analysis | 50ms | Fast inference engine |\n| Hook Intervention | 5ms | Existing Claude Code hooks |\n| Status Line Update | 100ms | Existing status line system |\n| Cross-Project Sync | 200ms | LSL multi-project architecture |\n| Watchdog Integration | 1s | Existing 4-layer monitoring |\n\n## Migration and Compatibility\n\n### Deprecation Strategy\n- **6-hourly semantic analysis**: Replace with continuous real-time monitoring\n- **Batch trajectory reports**: Enhance with live state updates\n- **Manual trajectory generation**: Supplement with automatic tracking\n\n### Backward Compatibility\n- Maintain existing `.specstory/comprehensive-project-trajectory.md` format\n- Preserve existing LSL session file formats and naming conventions\n- Keep existing multi-project coordination mechanisms\n- Maintain existing status line and health monitoring interfaces\n\n## Risk Mitigation\n\n### Technical Risks\n- **Fast inference rate limits**: Configure alternative providers via environment\n- **Hook system compatibility**: Gradual integration with existing constraint monitor\n- **Multi-project state conflicts**: Leverage existing LSL conflict resolution\n\n### Operational Risks\n- **Performance impact**: Use existing monitoring to track system resource usage\n- **Configuration complexity**: Leverage existing environment configuration patterns\n- **User adoption**: Build on familiar existing interfaces and status indicators\n\n## Success Criteria\n\n- Zero disruption to existing LSL and trajectory functionality\n- Real-time trajectory analysis with <100ms latency\n- Seamless multi-project coordination using existing architecture\n- Full integration with existing 4-layer watchdog system\n- Enhanced LSL redaction including GROQ_API_KEY\n- Successful deprecation of 6-hourly batch analysis system",
  "fileStats": {
    "size": 9105,
    "lines": 209,
    "lastModified": "2025-09-29T11:04:53.876Z"
  },
  "comments": []
}