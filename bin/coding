#!/bin/bash

# Coding Agent Unified Launcher
# Supports both Claude Code (with MCP) and GitHub CoPilot (with fallbacks)

set -e

# Default values
AGENT=""
FORCE_AGENT=""
ARGS=()
VERBOSE=false
CONFIG_FILE=""

# Helper functions
log() {
  if [ "$VERBOSE" = true ]; then
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
  fi
}

error() {
  echo "Error: $1" >&2
  exit 1
}

show_help() {
  cat << EOF
Coding Agent Unified Launcher

USAGE:
  coding-agent [OPTIONS] [COMMAND_ARGS...]

OPTIONS:
  --agent AGENT      Force specific agent (claude|copilot)
  --claude           Force Claude Code (same as --agent claude)
  --copilot          Force CoPilot (same as --agent copilot)
  --config FILE      Use specific config file
  --verbose          Enable verbose logging
  --help             Show this help

EXAMPLES:
  coding-agent                    # Use best available agent
  coding-agent --copilot          # Force CoPilot
  coding-agent --claude           # Force Claude Code
  coding-agent suggest "add tests" # Pass command to agent

AGENTS:
  claude     Claude Code with MCP servers (memory, browser, logging)
  copilot    GitHub CoPilot with fallback services

For more information, see docs/agent-agnostic-implementation-plan.md
EOF
}

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    --agent)
      FORCE_AGENT="$2"
      shift 2
      ;;
    --copilot)
      FORCE_AGENT="copilot"
      shift
      ;;
    --claude)
      FORCE_AGENT="claude"
      shift
      ;;
    --config)
      CONFIG_FILE="$2"
      shift 2
      ;;
    --verbose)
      VERBOSE=true
      shift
      ;;
    --help|-h)
      show_help
      exit 0
      ;;
    *)
      ARGS+=("$1")
      shift
      ;;
  esac
done

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Detect Node.js
if ! command -v node &> /dev/null; then
  error "Node.js is required but not found in PATH"
fi

# Use forced agent if specified
if [ -n "$FORCE_AGENT" ]; then
  AGENT="$FORCE_AGENT"
  log "Using forced agent: $AGENT"
else
  # Auto-detect best available agent
  log "Detecting best available agent..."
  AGENT=$(node "$SCRIPT_DIR/lib/agent-detector.js" --best)
  
  if [ "$AGENT" = "null" ] || [ -z "$AGENT" ]; then
    error "No supported agent found. Please install Claude Code or GitHub CoPilot CLI."
  fi
  
  log "Detected agent: $AGENT"
fi

# Validate agent
case "$AGENT" in
  claude|copilot)
    ;;
  *)
    error "Unsupported agent: $AGENT. Must be 'claude' or 'copilot'"
    ;;
esac

# Set environment variables
export CODING_AGENT="$AGENT"
export CODING_TOOLS_PATH="$SCRIPT_DIR"

# Launch appropriate agent
case "$AGENT" in
  claude)
    log "Launching Claude Code with MCP..."
    exec "$SCRIPT_DIR/scripts/launch-claude.sh" "${ARGS[@]}"
    ;;
  copilot)
    log "Launching CoPilot with fallback services..."
    exec "$SCRIPT_DIR/scripts/launch-copilot.sh" "${ARGS[@]}"
    ;;
esac