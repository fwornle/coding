#!/bin/bash

# Coding Agent Unified Launcher
# Supports both Claude Code (with MCP) and GitHub CoPilot (with fallbacks)

set -e

# Disable terminal focus reporting immediately to prevent ^[[I / ^[[O escape sequences
# leaking into output during the startup phase
printf '\e[?1004l' 2>/dev/null || true

# Default values
AGENT=""
FORCE_AGENT=""
ARGS=()
VERBOSE=false
DRY_RUN=false
CONFIG_FILE=""
PROJECT_DIR=""

# Helper functions
log() {
  if [ "$VERBOSE" = true ]; then
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
  fi
}

error() {
  echo "Error: $1" >&2
  exit 1
}

show_help() {
  cat << EOF
Coding Agent Unified Launcher

USAGE:
  coding-agent [OPTIONS] [COMMAND_ARGS...]

OPTIONS:
  --agent AGENT      Force specific agent (claude|copilot)
  --claude           Force Claude Code (same as --agent claude)
  --copilot, --copi  Force CoPilot (same as --agent copilot)
  --copilot-stop     Stop all CoPilot fallback services
  --config FILE      Use specific config file
  --project DIR      Set target project directory (default: current dir)
  --verbose          Enable verbose logging
  --dry-run          Run startup logic but stop before launching agent
  --help             Show this help

MODE SWITCHING:
  --switch-to-docker Switch all sessions from native to Docker mode
  --switch-to-native Switch all sessions from Docker to native mode
  --mode-status      Show current mode and transition status

EXAMPLES:
  coding-agent --lsl-status           # Show LSL system status
  coding-agent --lsl-validate         # Run LSL system validation  coding-agent                    # Use best available agent
  coding-agent --copilot          # Force CoPilot
  coding-agent --copilot-stop     # Stop CoPilot services
  coding-agent --claude           # Force Claude Code
  coding-agent --project /path/to/project  # Work in specific project
  coding-agent suggest "add tests" # Pass command to agent

AGENTS:
  claude     Claude Code with MCP servers (memory, browser, logging)
  copilot    GitHub CoPilot with fallback services

For more information, see docs/agent-agnostic-implementation-plan.md
EOF
}

# Get script directory (needed early for --copilot-stop)
# Resolve symlinks to get the actual script location
SOURCE="${BASH_SOURCE[0]}"
while [ -L "$SOURCE" ]; do
  DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    --agent)
      FORCE_AGENT="$2"
      shift 2
      ;;
    --copilot|--copi)
      FORCE_AGENT="copilot"
      shift
      ;;
    --copilot-stop)
      exec node "$SCRIPT_DIR/../lib/services/stop-services.js" --agent copilot --verbose
      ;;
    --claude)
      FORCE_AGENT="claude"
      shift
      ;;
    --config)
      CONFIG_FILE="$2"
      shift 2
      ;;
    --project)
      PROJECT_DIR="$2"
      shift 2
      ;;
    --verbose)
      VERBOSE=true
      shift
      ;;
    --dry-run)
      DRY_RUN=true
      shift
      ;;
    --lsl-status)
      exec node "$SCRIPT_DIR/../scripts/live-logging-coordinator.js" --status
      ;;
    --lsl-validate)
      exec node "$SCRIPT_DIR/../tests/integration/full-system-validation.test.js"
      ;;
    --switch-to-docker)
      exec node "$SCRIPT_DIR/../scripts/docker-mode-transition.js" to-docker --verbose
      ;;
    --switch-to-native)
      exec node "$SCRIPT_DIR/../scripts/docker-mode-transition.js" to-native --verbose
      ;;
    --mode-status)
      exec node "$SCRIPT_DIR/../scripts/docker-mode-transition.js" status
      ;;
    --help|-h)
      show_help
      exit 0
      ;;
    *)
      ARGS+=("$1")
      shift
      ;;
  esac
done

# Script directory already defined above

# Detect Node.js
if ! command -v node &> /dev/null; then
  error "Node.js is required but not found in PATH"
fi

# Use forced agent if specified
if [ -n "$FORCE_AGENT" ]; then
  AGENT="$FORCE_AGENT"
  log "Using forced agent: $AGENT"
else
  # Auto-detect best available agent
  log "Detecting best available agent..."
  AGENT=$(node "$SCRIPT_DIR/../lib/agent-detector.js" --best)
  
  if [ "$AGENT" = "null" ] || [ -z "$AGENT" ]; then
    error "No supported agent found. Please install Claude Code or GitHub CoPilot CLI."
  fi
  
  log "Detected agent: $AGENT"
fi

# Validate agent
case "$AGENT" in
  claude|copilot)
    ;;
  *)
    error "Unsupported agent: $AGENT. Must be 'claude' or 'copilot'"
    ;;
esac

# Capture the directory where coding was invoked from (before any cd operations)
INVOKED_FROM_DIR="$(pwd)"
CODING_REPO_PATH="$(cd "$SCRIPT_DIR/.." && pwd)"

# Validate and set project directory
if [ -n "$PROJECT_DIR" ]; then
  # Explicit project directory was specified with --project
  if [ ! -d "$PROJECT_DIR" ]; then
    error "Project directory does not exist: $PROJECT_DIR"
  fi
  PROJECT_DIR="$(cd "$PROJECT_DIR" && pwd)"  # Get absolute path
  log "Using explicit project directory: $PROJECT_DIR"
else
  # No explicit project specified, use the directory where coding was invoked
  PROJECT_DIR="$INVOKED_FROM_DIR"
  
  # Check if we're in the coding repo itself
  if [ "$PROJECT_DIR" = "$CODING_REPO_PATH" ]; then
    log "Working in coding repository itself"
  else
    log "Working in project: $(basename "$PROJECT_DIR") (from: $PROJECT_DIR)"
  fi
fi

# Export dry-run flag for launch scripts
export CODING_DRY_RUN="$DRY_RUN"

# Set environment variables for agent adapter system
export CODING_AGENT="$AGENT"
export CODING_TOOLS_PATH="$SCRIPT_DIR/.."
export CODING_REPO="$SCRIPT_DIR/.."
export CODING_PROJECT_DIR="$PROJECT_DIR"
export CODING_AGENT_ADAPTER_PATH="$SCRIPT_DIR/../lib/agent-api/adapters"
export CODING_HOOKS_CONFIG="$SCRIPT_DIR/../config/hooks-config.json"
export CODING_TRANSCRIPT_FORMAT="$AGENT"

# Launch appropriate agent
case "$AGENT" in
  claude)
    log "Launching Claude Code with MCP..."
    exec "$SCRIPT_DIR/../scripts/launch-claude.sh" "${ARGS[@]}"
    ;;
  copilot)
    log "Launching CoPilot with fallback services..."
    exec "$SCRIPT_DIR/../scripts/launch-copilot.sh" "${ARGS[@]}"
    ;;
esac