#!/bin/bash
#
# UKB Wrapper Script - Lightweight replacement for the original UKB script
# 
# This script provides backward compatibility while delegating to ukb-cli
# for the actual knowledge management operations. It gradually replaces
# the 3,948-line bash script with clean delegation to the Node.js CLI.
#
# Usage: ./bin/ukb-wrapper [options] [arguments]
#

set -euo pipefail

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
UKB_CLI="$PROJECT_ROOT/bin/ukb-cli.js"
ORIGINAL_UKB="$PROJECT_ROOT/knowledge-management/ukb"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging functions
log_info() {
    echo -e "${BLUE}[INFO]${NC} $*"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $*"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $*"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $*"
}

# Check if ukb-cli is available
check_ukb_cli() {
    if [[ ! -f "$UKB_CLI" ]]; then
        log_error "ukb-cli not found at $UKB_CLI"
        log_error "Please run './install.sh' to set up the system"
        exit 1
    fi
    
    if ! command -v node >/dev/null 2>&1; then
        log_error "Node.js is required but not installed"
        exit 1
    fi
}

# Display help information
show_help() {
    cat << 'EOF'
UKB Wrapper - Knowledge Management CLI

USAGE:
    ukb [command] [options]

COMMANDS:
    # Entity Management
    --list-entities              List all entities
    --add-entity                 Add a new entity (interactive)
    --remove-entity <name>       Remove an entity
    --search-entities <query>    Search entities
    --rename-entity <old> <new>  Rename an entity
    
    # Relation Management  
    --list-relations             List all relations
    --add-relation               Add a new relation (interactive)
    --remove-relation            Remove a relation (interactive)
    
    # Observations
    --add-observation <entity> <text>     Add observation to entity
    --remove-observation <entity> <text>  Remove observation from entity
    
    # Git Analysis
    --auto [num_commits]         Analyze recent commits (default: 10)
    --full-history [branch]      Analyze complete git history
    --agent                      Interactive analysis mode
    
    # Batch Operations
    --batch-add-entities <file>  Add entities from JSON file
    --batch-add-relations <file> Add relations from JSON file
    
    # Knowledge Base Management
    --stats                      Show knowledge base statistics
    --validate                   Validate knowledge base integrity
    --backup [path]              Create backup of knowledge base
    --restore <backup_file>      Restore from backup
    
    # Legacy Support
    --interactive                Start interactive mode
    --status                     Show knowledge base status
    --export <file>              Export knowledge base
    --import <file>              Import knowledge base
    
    # System
    --help, -h                   Show this help message
    --version                    Show version information
    --migrate-check              Check migration status

EXAMPLES:
    ukb --list-entities                    # List all entities
    ukb --auto 5                          # Analyze last 5 commits
    ukb --add-entity                      # Interactive entity creation
    ukb --search-entities "pattern"       # Search for entities
    ukb --stats                           # Show statistics
    ukb --backup                          # Create backup
    
MIGRATION STATUS:
    This wrapper gradually replaces the original UKB bash script with
    ukb-cli calls. Run 'ukb --migrate-check' to see migration progress.

EOF
}

# Show version information
show_version() {
    echo "UKB Wrapper v2.0.0"
    echo "Node.js CLI: $(node "$UKB_CLI" --version 2>/dev/null || echo "Unknown")"
    echo "Git: $(git --version 2>/dev/null || echo "Not available")"
}

# Check migration status
check_migration_status() {
    echo "=== UKB Migration Status ==="
    echo
    echo "âœ… Entity Management: Migrated to ukb-cli"
    echo "âœ… Relation Management: Migrated to ukb-cli"  
    echo "âœ… Git Analysis: Migrated to ukb-cli"
    echo "âœ… Batch Operations: Migrated to ukb-cli"
    echo "âœ… Knowledge Base Utils: Migrated to ukb-cli"
    echo "ðŸ”„ Legacy Script: Still available as fallback"
    echo
    echo "Original script size: $(wc -l < "$ORIGINAL_UKB" 2>/dev/null || echo "Unknown") lines"
    echo "Wrapper script size: $(wc -l < "${BASH_SOURCE[0]}" 2>/dev/null || echo "Unknown") lines"
    echo
    echo "Migration: ~95% complete"
}

# Delegate to ukb-cli with appropriate command mapping
delegate_to_cli() {
    local cmd="$1"
    shift
    
    case "$cmd" in
        # Entity management
        "--list-entities")
            node "$UKB_CLI" entity list "$@"
            ;;
        "--add-entity")
            node "$UKB_CLI" entity add --interactive "$@"
            ;;
        "--remove-entity")
            if [[ $# -eq 0 ]]; then
                node "$UKB_CLI" entity remove --interactive
            else
                node "$UKB_CLI" entity remove --name "$1"
            fi
            ;;
        "--search-entities")
            if [[ $# -eq 0 ]]; then
                log_error "Search query is required"
                exit 1
            fi
            node "$UKB_CLI" entity search "$1" "${@:2}"
            ;;
        "--rename-entity")
            if [[ $# -lt 2 ]]; then
                log_error "Both old name and new name are required"
                exit 1
            fi
            node "$UKB_CLI" entity rename "$1" "$2"
            ;;
            
        # Relation management
        "--list-relations")
            node "$UKB_CLI" relation list "$@"
            ;;
        "--add-relation")
            node "$UKB_CLI" relation add --interactive "$@"
            ;;
        "--remove-relation")
            node "$UKB_CLI" relation remove --interactive "$@"
            ;;
            
        # Observations
        "--add-observation")
            if [[ $# -lt 2 ]]; then
                log_error "Entity name and observation text are required"
                exit 1
            fi
            node "$UKB_CLI" entity add-observation "$1" "$2"
            ;;
        "--remove-observation")
            if [[ $# -lt 2 ]]; then
                log_error "Entity name and observation text are required"
                exit 1
            fi
            node "$UKB_CLI" entity remove-observation "$1" "$2"
            ;;
            
        # Git analysis
        "--auto")
            local num_commits="${1:-10}"
            node "$UKB_CLI" auto --num-commits "$num_commits" "${@:2}"
            ;;
        "--full-history")
            local branch="${1:-main}"
            node "$UKB_CLI" full-history --branch "$branch" "${@:2}"
            ;;
        "--agent")
            node "$UKB_CLI" agent "$@"
            ;;
            
        # Batch operations
        "--batch-add-entities")
            if [[ $# -eq 0 ]]; then
                log_error "Batch file is required"
                exit 1
            fi
            node "$UKB_CLI" entity add-batch "$1" "${@:2}"
            ;;
        "--batch-add-relations")
            if [[ $# -eq 0 ]]; then
                log_error "Batch file is required"
                exit 1
            fi
            node "$UKB_CLI" relation add-batch "$1" "${@:2}"
            ;;
            
        # Knowledge base management
        "--stats")
            node "$UKB_CLI" stats "$@"
            ;;
        "--validate")
            node "$UKB_CLI" validate "$@"
            ;;
        "--backup")
            if [[ $# -eq 0 ]]; then
                node "$UKB_CLI" backup
            else
                node "$UKB_CLI" backup --path "$1"
            fi
            ;;
        "--restore")
            if [[ $# -eq 0 ]]; then
                log_error "Backup file is required"
                exit 1
            fi
            node "$UKB_CLI" restore "$1" "${@:2}"
            ;;
            
        # Legacy support
        "--interactive")
            node "$UKB_CLI" interactive "$@"
            ;;
        "--status")
            node "$UKB_CLI" status "$@"
            ;;
        "--export")
            if [[ $# -eq 0 ]]; then
                log_error "Export file path is required"
                exit 1
            fi
            node "$UKB_CLI" export "$1" "${@:2}"
            ;;
        "--import")
            if [[ $# -eq 0 ]]; then
                log_error "Import file path is required"
                exit 1
            fi
            node "$UKB_CLI" import "$1" "${@:2}"
            ;;
            
        # System commands
        "--help"|"-h")
            show_help
            ;;
        "--version")
            show_version
            ;;
        "--migrate-check")
            check_migration_status
            ;;
            
        # Fallback to original script for unhandled commands
        *)
            log_warning "Command '$cmd' not yet migrated, falling back to original UKB script"
            if [[ -f "$ORIGINAL_UKB" ]]; then
                "$ORIGINAL_UKB" "$cmd" "$@"
            else
                log_error "Original UKB script not found at $ORIGINAL_UKB"
                log_error "Unknown command: $cmd"
                echo
                show_help
                exit 1
            fi
            ;;
    esac
}

# Main execution
main() {
    # Check prerequisites
    check_ukb_cli
    
    # Handle no arguments - show help
    if [[ $# -eq 0 ]]; then
        show_help
        exit 0
    fi
    
    # Parse and delegate command
    local command="$1"
    shift
    
    # Execute command
    delegate_to_cli "$command" "$@"
}

# Run main function with all arguments
main "$@"